---
title: 系统初始化
description: 系统初始化
keywords:
  - 系统初始化
  - Linux
  - CentOS
  - Ubuntu
  - Debian
  - 运维
tags:
  - 系统初始化
  - Linux
  - CentOS
  - Ubuntu
  - Debian
  - 运维
  - 知识库
  - 系统环境
---

# 系统初始化

本文档提供 CentOS、Ubuntu 和 Debian 三个主流 Linux 发行版的详细初始化指南。

!!! tip
    建议在虚拟机中先行测试，确认无误后再在生产环境执行。

---

## 配置 NTP 


???+ warning 

    如果是内网环境，建议配置内网 NTP 服务器，避免依赖外网连接。


时间同步对于分布式系统和日志管理至关重要，推荐使用 chrony 服务。


=== "CentOS/RHEL"

    ``` bash
    # 安装并启动 chrony 服务
    sudo yum install -y chrony
    sudo systemctl enable chronyd --now
    sudo systemctl restart crond

    # 配置 NTP 服务器
    sudo tee -a /etc/chrony.conf << EOF
    server ntp.aliyun.com iburst
    server ntp1.aliyun.com iburst
    server ntp2.aliyun.com iburst
    EOF

    # 重启服务并验证状态
    sudo systemctl restart chronyd
    chronyc tracking
    chronyc sources -v
    ```


=== "Ubuntu/Debian"

    ``` bash
    # 安装并启动 chrony 服务
    sudo apt update && sudo apt install -y chrony
    sudo systemctl enable chronyd --now

    # 配置 NTP 服务器
    sudo tee -a /etc/chrony/chrony.conf << EOF
    server ntp.aliyun.com iburst
    server ntp1.aliyun.com iburst
    server ntp2.aliyun.com iburst
    EOF

    # 重启服务并验证状态
    sudo systemctl restart chrony
    chronyc tracking
    chronyc sources -v
    ```





## 配置静态 IP

=== "CentOS/RHEL"

    ```bash
    # 查看网络接口名称
    ip addr show

    # 编辑网络配置文件（以 ens32 为例）
    sudo vim /etc/sysconfig/network-scripts/ifcfg-ens32

    # 配置示例：
    TYPE="Ethernet"
    BOOTPROTO="static"
    DEFROUTE="yes"
    IPV4_FAILURE_FATAL="no"
    IPV6INIT="no"
    NAME="ens32"
    DEVICE="ens32"
    ONBOOT="yes"
    IPADDR="192.168.1.100"
    NETMASK="255.255.255.0"
    GATEWAY="192.168.1.1"
    DNS1="114.114.114.114"
    DNS2="8.8.8.8"

    # 重启网络服务
    sudo systemctl restart NetworkManager
    # 或者
    sudo systemctl restart network
    ```

=== "Ubuntu/Debian"

    ```bash
    # Ubuntu 18.04+ 使用 Netplan 配置网络 

    # 查看现有配置文件
    ls /etc/netplan/

    # 编辑配置文件
    sudo vim /etc/netplan/01-netcfg.yaml 


    # 配置示例：
    network:
    version: 2
    renderer: networkd
    ethernets:
        enp0s3:
        dhcp4: no
        addresses:
            - 192.168.1.100/24
        gateway4: 192.168.1.1
        nameservers:
            addresses:
            - 114.114.114.114
            - 8.8.8.8


    # 应用配置
    sudo netplan apply

    # 验证配置
    ip addr show
    ```

## 内核升级

```bash
# 检查当前内核版本
uname -r

# 检查可用内核版本
rpm -qa | grep kernel  # CentOS/RHEL
dpkg -l | grep linux-image  # Ubuntu/Debian
```

!!! danger

    内核升级有一定风险，建议：
    
    1. 升级前创建系统快照或备份
    2. 保留原有内核，以便出现问题时回退
    3. 在测试环境验证无误后再在生产环境执行


=== "CentOS/RHEL"

    ```bash
    # 安装 ELRepo 仓库（用于获取最新内核）
    sudo rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
    sudo dnf install -y https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm

    # 安装最新稳定内核
    sudo dnf --enablerepo=elrepo-kernel install -y kernel-ml

    # 设置默认启动内核
    sudo grub2-set-default 0
    sudo grub2-mkconfig -o /boot/grub2/grub.cfg
    ```

=== "Ubuntu/Debian"

    ```bash
    # 更新包列表
    sudo apt update

    # 安装最新内核
    sudo apt install -y linux-generic linux-headers-generic

    # 更新 GRUB 配置
    sudo update-grub
    ```

## 安全配置

### 1. 关闭服务

???+ warning

    - 关闭防火墙：将直接暴露所有服务端口到网络中，极大增加被攻击风险
    - 关闭 SELinux/AppArmor：移除重要的安全防护层，降低系统抗攻击能力
    - 关闭系统服务：可能影响系统功能，请确认这些服务确实不需要

???+ tip

    - 生产环境中，推荐完全开启防火墙，配置好端口白名单
    - SELinux/AppArmor 应配置为许可模式而非完全禁用
    - 仅在测试环境或有明确需求时执行以下操作

=== "CentOS/RHEL"

    ```bash
    # 关闭防火墙（根据安全策略决定）
    sudo systemctl stop firewalld  
    sudo systemctl disable firewalld

    # 关闭 SELinux
    sudo setenforce 0
    sudo sed -i 's/^SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config

    # 关闭不必要的服务
    sudo systemctl stop postfix rpcbind
    sudo systemctl disable postfix rpcbind
    ```

=== "Ubuntu/Debian"

    ```bash
    # 关闭防火墙（根据安全策略决定）
    sudo systemctl stop ufw  
    sudo systemctl disable ufw

    # 关闭 AppArmor
    sudo systemctl stop apparmor
    sudo systemctl disable apparmor

    # 关闭不必要的服务
    sudo systemctl stop postfix rpcbind
    sudo systemctl disable postfix rpcbind
    ```

### 2. SSH 安全

???+ warning

    - 修改 SSH 端口：如果忘记新端口号，可能导致无法远程连接
    - 禁止 root 登录：确保已创建其他管理员用户，否则可能失去系统访问权限
    - 禁用密码认证：必须先配置好密钥认证，否则将无法登录
    - 配置错误：可能导致完全失去 SSH 访问权限，需要物理访问服务器恢复

???+ tip

    - 保持现有 SSH 连接会话，在新会话中测试配置
    - 确保有服务器的物理访问权限或控制台访问
    - 先创建配置备份
    - 逐项测试配置，确认无误后再应用下一项

```bash
# 备份原配置
sudo cp /etc/ssh/sshd_config{,.bak}

# 编辑 SSH 配置
sudo vim /etc/ssh/sshd_config


# 推荐的 SSH 安全配置：

# 修改默认端口（可选）
Port 2222
# 禁止 root 直接登录（推荐）
PermitRootLogin no
# 禁用密码认证，仅使用密钥认证（高安全要求）
PasswordAuthentication yes
PubkeyAuthentication yes
# 设置登录超时
ClientAliveInterval 600
ClientAliveCountMax 0
# 限制登录用户
AllowUsers guodi
# 禁用空密码
PermitEmptyPasswords no

# 重启 SSH 服务
sudo systemctl restart sshd
```

## 性能优化

### 1. 内核参数

```bash
# 备份原配置
sudo cp /etc/sysctl.conf{,.bak}

# 创建优化配置
sudo tee /etc/sysctl.conf << EOF
# 文件系统优化
fs.file-max = 1048576
fs.aio-max-nr = 1048576

# 内存管理
vm.drop_caches = 3
vm.max_map_count = 262144
vm.swappiness = 10

# 共享内存
kernel.shmall = 4294967296
kernel.shmmax = 4294967295
kernel.shmmni = 4096

# 系统安全
kernel.sysrq = 0
kernel.dmesg_restrict = 1

# 信号量
kernel.sem = 250 32000 100 128

# 网络优化
net.ipv4.ip_forward = 1
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# TCP 优化
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.ip_local_port_range = 1024 65535

# 网络缓冲区
net.core.rmem_default = 16777216
net.core.rmem_max = 16777216
net.core.wmem_default = 16777216
net.core.wmem_max = 16777216
net.core.netdev_max_backlog = 5000
EOF

# 应用配置
sudo sysctl -p
```

### 2. 文件描述符

```bash
# 设置系统级文件描述符限制
sudo tee -a /etc/security/limits.conf << EOF
* soft nofile 1048576
* hard nofile 1048576
* soft nproc 1048576
* hard nproc 1048576
EOF

# 设置 systemd 服务限制
sudo tee /etc/systemd/system.conf.d/limits.conf << EOF
[Manager]
DefaultLimitNOFILE=1048576
DefaultLimitNPROC=1048576
EOF
```

### 3. 中断负载均衡

=== "CentOS/RHEL"

    ```bash
    # 安装并启动 irqbalance
    sudo yum install -y irqbalance 

    sudo systemctl enable irqbalance --now
    ```

=== "Ubuntu/Debian"

    ```bash
    # 安装并启动 irqbalance
    sudo apt install -y irqbalance 

    sudo systemctl enable irqbalance --now 
    ```


## 磁盘管理

### 1. 查看磁盘

```bash
# 查看磁盘分区
lsblk

# 查看文件系统
df -h

# 查看磁盘使用情况
df -Th
```

### 2. 方案选择

| 磁盘大小 | 数据类型 | 分区方案 | 优势 |
|---------|---------|---------|------|
| < 2TB | 任意 | LVM 分区 | 灵活扩容 |
| ≥ 2TB | 任意 | GPT 分区 | 支持大容量 |

### 3. LVM 分区管理

#### 3.1 创建 LVM 分区

```bash
# 创建物理卷
sudo pvcreate /dev/sdb

# 创建卷组
sudo vgcreate data_vg /dev/sdb

# 创建逻辑卷（使用全部空间）
sudo lvcreate -l 100%FREE -n data_lv data_vg

# 格式化为 ext4
sudo mkfs.ext4 /dev/data_vg/data_lv

# 创建挂载点并挂载
sudo mkdir -p /data
sudo mount /dev/data_vg/data_lv /data

# 设置开机自动挂载
echo '/dev/data_vg/data_lv /data ext4 defaults 0 2' | sudo tee -a /etc/fstab
```

#### 3.2 LVM 扩容

```bash
# 添加新磁盘到卷组
sudo pvcreate /dev/sdc
sudo vgextend data_vg /dev/sdc

# 扩展逻辑卷
sudo lvextend -l +100%FREE /dev/data_vg/data_lv

# 扩展文件系统
sudo resize2fs /dev/data_vg/data_lv
```

#### 3.3 删除 LVM 

```bash
# 删除逻辑卷
sudo lvremove /dev/data_vg/data_lv

# 删除卷组
sudo vgremove data_vg

# 删除物理卷
sudo pvremove /dev/sdb /dev/sdc
```

### 4. GPT 分区管理

#### 4.1 创建 GPT 分区

```bash
# 查看磁盘
lsblk

# 转换为 GPT 分区表
sudo parted /dev/sdb mklabel gpt

# 创建分区
sudo parted /dev/sdb mkpart primary ext4 0% 100%

# 格式化分区
sudo mkfs.ext4 /dev/sdb1

# 创建挂载点并挂载
sudo mkdir -p /data
sudo mount /dev/sdb1 /data

# 设置开机自动挂载
echo '/dev/sdb1 /data ext4 defaults 0 2' | sudo tee -a /etc/fstab

# 查看挂载信息
df -h /data

# 查看块设备信息
lsblk

# 查看 GPT 分区信息
sudo parted /dev/sdb print
```


## 配置 Vim

创建全局 vim 配置：

```bash
sudo tee /etc/vim/vimrc.local << 'EOF'
" ===== 基本设置 =====
syntax on
filetype plugin indent on

" ===== 显示设置 =====
set number
set ruler
set cursorline
set laststatus=2
set showcmd
set showmode
colorscheme desert

" ===== 缩进和制表符 =====
set tabstop=4
set shiftwidth=4
set expandtab
set autoindent
set smartindent        " 新增：智能缩进

" ===== 编辑设置 =====
set backspace=indent,eol,start
set whichwrap+=<,>,h,l
set mouse=a           " 新增：鼠标支持

" ===== 搜索设置 =====
set hlsearch
set incsearch
set ignorecase
set smartcase

" ===== 编码设置 =====
set encoding=utf-8
set fileencodings=utf-8,gb18030,gbk,gb2312,latin1
set fileencoding=utf-8
set fileformat=unix
set formatoptions+=mM

" ===== 备份和临时文件 =====
set backupdir=/tmp,/var/tmp,~/tmp
set directory=/tmp,/var/tmp,~/tmp

" ===== 显示和换行 =====
set wrap              " 改为：启用自动换行显示（不改变文件内容）
set linebreak         " 新增：在合适的地方换行
set showbreak=↪\      " 新增：换行标识符

" ===== 粘贴模式 =====
set pastetoggle=<F2>  " 改为：按F2切换粘贴模式

" ===== 额外的便利设置 =====
set wildmenu          " 新增：命令行补全菜单
set scrolloff=3       " 新增：光标上下保持3行
set sidescrolloff=5   " 新增：光标左右保持5列
set clipboard=unnamedplus  " 新增：与系统剪贴板同步（如果支持）

" ===== 快捷键映射 =====
" Ctrl+C 复制到系统剪贴板
vnoremap <C-c> "+y
" Ctrl+V 从系统剪贴板粘贴
inoremap <C-v> <C-r>+
EOF
```




## 重启机器

```bash
# 修改配置后最好重启机器
sync;reboot
```




