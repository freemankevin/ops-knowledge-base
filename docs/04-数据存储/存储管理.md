---
title: 数据存储
description: 中间件数据库的数据存储配置与管理
keywords:
  - 数据存储
  - Docker
  - 持久化
  - 存储卷
  - 数据管理
tags:
  - 数据存储
  - Docker
  - 持久化
  - 存储卷
  - 数据管理
  - 运维
---

# 数据存储

本文档介绍各个中间件服务的数据存储配置，包括持久化存储、存储卷管理、数据迁移等内容。

## 存储架构概览

### 目录结构
```
.
├── data/                           # 数据根目录
│   ├── nginx/                      # Nginx 相关数据
│   │   ├── certs/                  # SSL证书
│   │   ├── html/                   # 静态网站文件
│   │   └── logs/                   # 访问和错误日志
│   ├── nacos/                      # Nacos 相关数据
│   │   ├── data/                   # 配置和服务数据
│   │   └── logs/                   # 应用日志
│   ├── minio/                      # MinIO 对象存储
│   │   └── data/                   # 对象数据文件
│   ├── redis/                      # Redis 缓存数据
│   │   └── data/                   # RDB和AOF文件
│   ├── rabbitmq/                   # RabbitMQ 消息队列
│   │   └── data/                   # 消息持久化数据
│   ├── postgres/                   # PostgreSQL 数据库
│   │   ├── pgdata/                 # 数据库文件
│   │   └── backups/                # 备份文件
│   ├── elastic/                    # Elasticsearch 搜索引擎
│   │   ├── data/                   # 索引数据
│   │   ├── logs/                   # 运行日志
│   │   └── plugins/                # 插件目录
│   └── geoserver/                  # GeoServer 地理信息
│       └── data/                   # 工作空间和图层数据
├── conf/                           # 配置文件目录
└── scripts/                        # 脚本文件目录
```

## 各服务存储配置

### Nginx 存储配置

**存储类型**: 配置文件 + 静态文件 + 日志文件

```yaml
volumes:
  # 只读配置文件
  - ./conf/mime.types:/etc/nginx/mime.types:ro
  - ./conf/nginx.conf:/etc/nginx/nginx.conf:ro
  - ./conf/web.conf:/etc/nginx/conf.d/default.conf:ro
  # 只读证书文件
  - ./data/nginx/certs:/etc/ssl/private:ro
  # 读写数据文件
  - ./data/nginx/html:/usr/share/nginx/html
  - ./data/nginx/logs:/var/log/nginx:rw
```

**存储特点**:

- 配置文件和证书采用只读挂载，提高安全性
- 日志文件采用读写挂载，支持日志轮转
- 静态文件支持热更新

### Nacos 存储配置

**存储类型**: 配置数据 + 服务注册数据 + 日志文件

```yaml
volumes:
  - /etc/localtime:/etc/localtime:ro
  - ./conf/nacos-application.properties:/home/nacos/conf/application.properties
  - ./data/nacos/data/:/home/nacos/data          # 持久化配置和服务数据
  - ./data/nacos/logs/:/home/nacos/logs          # 应用日志
```

**数据说明**:

- `data/` 目录存储配置中心的配置信息和服务注册信息
- `logs/` 目录存储应用运行日志
- 支持集群模式下的数据共享

### MinIO 存储配置

**存储类型**: 对象存储数据 + 元数据

```yaml
volumes:
  - /etc/localtime:/etc/localtime:ro
  - ./data/minio/data:/data                      # 对象存储数据
  - ./certs:/certs                               # HTTPS模式证书 (可选)
```

**存储特点**:
- 所有对象数据存储在 `/data` 目录
- 支持多驱动器部署以提高性能
- 元数据与对象数据一起存储
- 支持纠删码和数据保护

**扩展存储配置**:
```yaml
# 多驱动器配置示例
command: server /data1 /data2 /data3 /data4 --console-address ":9001"
volumes:
  - ./data/minio/data1:/data1
  - ./data/minio/data2:/data2
  - ./data/minio/data3:/data3
  - ./data/minio/data4:/data4
```

### Redis 存储配置

**存储类型**: 内存快照 + 持久化日志

```yaml
volumes:
  - /etc/localtime:/etc/localtime:ro
  - ./conf/redis.conf:/usr/local/etc/redis/redis.conf
  - ./data/redis/data:/data                      # RDB + AOF 持久化文件
```

**持久化模式**:

- **RDB**: 定期快照，适合备份和灾难恢复
- **AOF**: 日志记录，提供更好的数据持久性
- **混合模式**: 结合RDB和AOF的优点

**配置示例**:
```conf
# RDB配置
save 900 1
save 300 10
save 60 10000

# AOF配置
appendonly yes
appendfsync everysec
```

### RabbitMQ 存储配置

**存储类型**: 队列数据 + 元数据 + 日志

```yaml
volumes:
  - /etc/localtime:/etc/localtime:ro
  - ./data/rabbitmq/data/:/var/lib/rabbitmq/     # 队列、交换器、绑定等数据
```

**存储内容**:

- 队列定义和消息持久化
- 用户权限和虚拟主机配置
- 插件配置和节点状态
- 操作日志和统计信息

### PostgreSQL 存储配置

**存储类型**: 数据库文件 + WAL日志 + 备份文件

```yaml
volumes:
  - ./data/postgres/pgdata:/var/lib/postgresql/data    # 数据库主文件
  - ./data/postgres/backups:/backups                   # 备份文件 (pg-backup容器)
```

**存储结构**:
```
pgdata/
├── base/           # 数据库文件
├── global/         # 全局表
├── pg_wal/         # WAL日志文件
├── pg_stat/        # 统计信息
└── postgresql.conf # 配置文件
```

### Elasticsearch 存储配置

**存储类型**: 索引数据 + 日志 + 插件

```yaml
volumes:
  - /etc/localtime:/etc/localtime:ro
  - ./data/elastic/data:/usr/share/elasticsearch/data        # 索引和文档数据
  - ./data/elastic/logs:/usr/share/elasticsearch/logs        # 应用日志
  - ./data/elastic/plugins:/usr/share/elasticsearch/plugins  # 插件目录
  - ./conf/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
```

**数据分布**:

- `data/` 目录存储所有索引的分片数据
- `logs/` 目录存储集群和慢查询日志
- `plugins/` 目录存储安装的插件

### GeoServer 存储配置

**存储类型**: 工作空间 + 图层数据 + 样式文件

```yaml
volumes:
  - ./data/geoserver/data:/opt/geoserver/data    # GeoServer数据目录
```

**数据结构**:
```
geoserver/data/
├── workspaces/     # 工作空间配置
├── layergroups/    # 图层组
├── styles/         # 样式文件(SLD)
├── data/          # 数据存储(Shapefile等)
├── logs/          # 日志文件
└── global.xml     # 全局配置
```

## 存储管理

### 磁盘空间监控

创建监控脚本检查各服务的存储使用情况:

```bash
#!/bin/bash
# storage-monitor.sh

echo "=== 存储空间使用情况 ==="
echo "总体磁盘使用情况:"
df -h /

echo -e "\n各服务数据目录使用情况:"
for service in nginx nacos minio redis rabbitmq postgres elastic geoserver; do
    if [ -d "./data/$service" ]; then
        size=$(du -sh "./data/$service" | cut -f1)
        echo "$service: $size"
    fi
done

echo -e "\n日志文件大小:"
find ./data -name "*.log" -exec ls -lh {} \; | awk '{print $9 ": " $5}'
```

### 数据清理

定期清理日志和临时文件:

```bash
#!/bin/bash
# cleanup.sh

# 清理Nginx日志 (保留30天)
find ./data/nginx/logs -name "*.log" -mtime +30 -delete

# 清理Elasticsearch日志 (保留7天)
find ./data/elastic/logs -name "*.log" -mtime +7 -delete

# 清理Docker日志
docker system prune -f --volumes --filter "until=168h"

echo "清理完成"
```

### 权限管理

设置正确的文件权限:

```bash
#!/bin/bash
# set-permissions.sh

# Elasticsearch需要特殊权限
chmod -R 775 ./data/elastic/
chown -R 1000:1000 ./data/elastic/

# PostgreSQL数据权限
chmod -R 700 ./data/postgres/pgdata/

# 其他服务通用权限
chmod -R 755 ./data/nginx/
chmod -R 755 ./data/nacos/
chmod -R 755 ./data/minio/
chmod -R 755 ./data/redis/
chmod -R 755 ./data/rabbitmq/
chmod -R 755 ./data/geoserver/

echo "权限设置完成"
```

## 存储优化建议

### 性能优化

1. **SSD存储**: 对于数据库、搜索引擎等I/O密集型服务，建议使用SSD
2. **存储分离**: 将数据和日志分别存储在不同的磁盘上
3. **RAID配置**: 使用RAID 10提供性能和冗余的平衡

### 容量规划

| 服务 | 预估存储需求 | 增长率 | 建议配置 |
|------|-------------|--------|----------|
| PostgreSQL | 根据业务数据量 | 20-50%/年 | 至少预留50%空间 |
| Elasticsearch | 原始数据的1.5-2倍 | 30-100%/年 | 监控分片大小 |
| MinIO | 根据文件存储需求 | 50-200%/年 | 支持动态扩容 |
| Redis | 内存数据大小 | 稳定 | RDB文件约为内存的50% |
| RabbitMQ | 消息量相关 | 波动较大 | 配置消息过期 |
| 日志文件 | 5-20GB/月 | 线性增长 | 配置日志轮转 |

### 安全考虑

1. **敏感数据加密**: PostgreSQL、Redis等包含敏感数据的服务启用加密
2. **访问控制**: 限制数据目录的访问权限
3. **网络隔离**: 使用Docker网络隔离不同服务
4. **定期备份**: 制定完善的备份策略

## 故障排查

### 常见存储问题

**磁盘空间不足**:
```bash
# 检查磁盘使用情况
df -h
du -sh ./data/*

# 清理Docker占用空间
docker system df
docker system prune -a
```

**权限问题**:
```bash
# 检查目录权限
ls -la ./data/

# Elasticsearch权限修复
sudo chown -R 1000:1000 ./data/elastic/
```

**数据损坏**:
```bash
# PostgreSQL数据检查
docker exec postgres pg_dump -U postgres -d gis -f /tmp/test_backup.sql

# Redis数据检查
docker exec redis redis-cli --rdb /tmp/dump.rdb
```

通过合理的存储配置和管理，可以确保各个中间件服务的数据安全和高性能运行。