---
title: 防火墙防护
description: 防火墙防护
keywords:
  - 防火墙防护
  - 安全防护
  - 运维
  - 知识库
  - 系统环境
tags:
  - 防火墙防护
  - 安全防护
  - 运维
  - 知识库
  - 系统环境
---

# 防火墙安全

## 1. iptables防火墙配置

### 1.1 iptables基础操作

```bash
# 查看当前防火墙规则
iptables -L -n -v

# 查看NAT表规则
iptables -t nat -L -n -v

# 清空所有规则
iptables -F
iptables -t nat -F
iptables -X

# 设置默认策略
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 保存规则
service iptables save  # CentOS 6
iptables-save > /etc/iptables/rules.v4  # Ubuntu/Debian

# 恢复规则
iptables-restore < /etc/iptables/rules.v4
```

### 1.2 基础防火墙规则配置

```bash
# 创建基础防火墙配置脚本
cat > /usr/local/bin/setup-iptables.sh << 'EOF'
#!/bin/bash

# 清空现有规则
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

# 设置默认策略
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 允许回环接口
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# 允许已建立和相关的连接
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# 允许SSH连接（修改为你的SSH端口）
SSH_PORT=2222
iptables -A INPUT -p tcp --dport $SSH_PORT -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT

# 允许HTTP和HTTPS
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 允许DNS查询响应
iptables -A INPUT -p udp --sport 53 -m conntrack --ctstate ESTABLISHED -j ACCEPT
iptables -A INPUT -p tcp --sport 53 -m conntrack --ctstate ESTABLISHED -j ACCEPT

# 允许NTP同步
iptables -A INPUT -p udp --sport 123 -m conntrack --ctstate ESTABLISHED -j ACCEPT

# 防止常见攻击
# 防止端口扫描
iptables -A INPUT -m conntrack --ctstate INVALID -j DROP
iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP
iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP
iptables -A INPUT -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP
iptables -A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP
iptables -A INPUT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
iptables -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP

# 限制连接速率（防止暴力破解）
iptables -A INPUT -p tcp --dport $SSH_PORT -m conntrack --ctstate NEW -m recent --set
iptables -A INPUT -p tcp --dport $SSH_PORT -m conntrack --ctstate NEW -m recent --update --seconds 60 --hitcount 4 -j DROP

# 防止ping洪水攻击
iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s --limit-burst 2 -j ACCEPT
iptables -A INPUT -p icmp --icmp-type echo-request -j DROP

# 记录并丢弃其他连接
iptables -A INPUT -j LOG --log-prefix "iptables-denied: "
iptables -A INPUT -j DROP

echo "iptables rules configured successfully"
EOF

chmod +x /usr/local/bin/setup-iptables.sh
```

### 1.3 高级iptables规则

```bash
# 创建高级防火墙规则脚本
cat > /usr/local/bin/advanced-iptables.sh << 'EOF'
#!/bin/bash

# 创建自定义链
iptables -N LOGDROP
iptables -A LOGDROP -j LOG --log-prefix "iptables-drop: " --log-level 4
iptables -A LOGDROP -j DROP

# 防止SYN洪水攻击
iptables -N SYN_FLOOD
iptables -A SYN_FLOOD -p tcp --syn -m limit --limit 1/s --limit-burst 3 -j RETURN
iptables -A SYN_FLOOD -j LOGDROP
iptables -A INPUT -p tcp --syn -j SYN_FLOOD

# 地理位置封锁（需要xtables-addons）
# 封锁特定国家的IP（例如：CN为中国代码）
# iptables -A INPUT -m geoip --src-cc CN -j LOGDROP

# 基于时间的访问控制
# 只在工作时间允许SSH连接
iptables -A INPUT -p tcp --dport 2222 -m time --timestart 08:00 --timestop 18:00 --weekdays Mon,Tue,Wed,Thu,Fri -j ACCEPT

# IP地址白名单/黑名单管理
# 创建IP集合（需要ipset）
ipset create whitelist hash:ip
ipset create blacklist hash:ip

# 添加白名单IP
ipset add whitelist 192.168.1.100
ipset add whitelist 10.0.0.50

# 添加黑名单IP
ipset add blacklist 1.2.3.4
ipset add blacklist 5.6.7.8

# 应用IP集合规则
iptables -A INPUT -m set --match-set whitelist src -j ACCEPT
iptables -A INPUT -m set --match-set blacklist src -j LOGDROP

# 端口敲门（Port Knocking）配置
iptables -N KNOCKING
iptables -N GATE1
iptables -N GATE2
iptables -N PASSED

# 第一个敲门端口
iptables -A KNOCKING -p tcp --dport 7000 -m recent --name KNOCK1 --set -j DROP
iptables -A KNOCKING -p tcp --dport 8000 -m recent --name KNOCK1 --rcheck -m recent --name KNOCK2 --set -j DROP
iptables -A KNOCKING -p tcp --dport 9000 -m recent --name KNOCK2 --rcheck -m recent --name KNOCK3 --set -j DROP
iptables -A KNOCKING -p tcp --dport 2222 -m recent --name KNOCK3 --rcheck -j ACCEPT

# 应用端口敲门
iptables -A INPUT -p tcp --dport 2222 -j KNOCKING

echo "Advanced iptables rules configured"
EOF

chmod +x /usr/local/bin/advanced-iptables.sh
```

## 2. firewalld配置

### 2.1 firewalld基础操作

```bash
# 启动和启用firewalld
systemctl start firewalld
systemctl enable firewalld

# 查看状态
firewall-cmd --state
firewall-cmd --list-all

# 查看所有zone
firewall-cmd --get-zones
firewall-cmd --get-default-zone

# 查看活跃zone
firewall-cmd --get-active-zones

# 重新加载配置
firewall-cmd --reload
```

### 2.2 基本服务和端口管理

```bash
# 永久添加服务
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https

# 永久添加端口
firewall-cmd --permanent --add-port=2222/tcp
firewall-cmd --permanent --add-port=3306/tcp

# 删除服务或端口
firewall-cmd --permanent --remove-service=ssh
firewall-cmd --permanent --remove-port=2222/tcp

# 端口范围
firewall-cmd --permanent --add-port=4000-4100/tcp

# 应用配置
firewall-cmd --reload
```

### 2.3 创建自定义firewalld配置

```bash
# 创建自定义zone
firewall-cmd --permanent --new-zone=dmz-servers
firewall-cmd --permanent --zone=dmz-servers --add-service=ssh
firewall-cmd --permanent --zone=dmz-servers --add-service=http
firewall-cmd --permanent --zone=dmz-servers --add-service=https

# 将接口绑定到zone
firewall-cmd --permanent --zone=dmz-servers --add-interface=eth0

# 富规则（Rich Rules）
# 只允许特定IP访问SSH
firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.100" service name="ssh" accept'

# 限制连接数
firewall-cmd --permanent --add-rich-rule='rule service name="ssh" accept limit value="3/m"'

# 基于时间的规则
firewall-cmd --permanent --add-rich-rule='rule service name="ssh" accept audit limit value="1/m"'

# 端口转发
firewall-cmd --permanent --add-forward-port=port=80:proto=tcp:toport=8080:toaddr=192.168.1.100

# 创建firewalld配置管理脚本
cat > /usr/local/bin/firewalld-setup.sh << 'EOF'
#!/bin/bash

# 基础配置
firewall-cmd --set-default-zone=public

# 移除不需要的服务
firewall-cmd --permanent --remove-service=dhcpv6-client 2>/dev/null
firewall-cmd --permanent --remove-service=cockpit 2>/dev/null

# 添加必要的服务
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https

# 自定义SSH端口
firewall-cmd --permanent --add-port=2222/tcp
firewall-cmd --permanent --remove-service=ssh

# 限制SSH访问
firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port protocol="tcp" port="2222" accept'
firewall-cmd --permanent --add-rich-rule='rule family="ipv4" port protocol="tcp" port="2222" limit value="3/m" accept'

# 防止暴力破解
firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="0.0.0.0/0" service name="ssh" log prefix="ssh-attempt" level="info" limit value="3/m" drop'

# 应用配置
firewall-cmd --reload

echo "Firewalld configuration completed"
EOF

chmod +x /usr/local/bin/firewalld-setup.sh
```

-----

## 3. 防火墙日志分析和监控

### 3.1 rsyslog配置

防火墙日志通常由内核记录，并通过 `rsyslog` 或 `journald` 收集。为了方便分析，可以配置 `rsyslog` 将防火墙日志单独保存。

```bash
# 创建一个新的rsyslog配置文件
cat > /etc/rsyslog.d/firewall.conf << 'EOF'
# 将所有带有 "iptables-denied" 前缀的内核消息记录到 /var/log/firewall.log
:msg, contains, "iptables-denied" -/var/log/firewall.log
& stop
EOF

# 重启rsyslog服务以应用配置
systemctl restart rsyslog
```

### 3.2 防火墙日志监控脚本

编写一个脚本来实时监控和分析防火墙日志，以便及时发现潜在的攻击。

```bash
# 创建防火墙日志监控脚本
cat > /usr/local/bin/firewall-monitor.sh << 'EOF'
#!/bin/bash

LOG_FILE="/var/log/firewall.log"
REPORT_FILE="/var/log/firewall-report.log"
EMAIL="admin@yourdomain.com"
THRESHOLD=100  # 阈值：在给定时间内超过此数量的连接将被视为异常

# 检查日志文件是否存在
if [ ! -f "$LOG_FILE" ]; then
    echo "[$DATE] Log file not found: $LOG_FILE" >> $REPORT_FILE
    exit 1
fi

DATE=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$DATE] Firewall Activity Report" > $REPORT_FILE
echo "=============================================" >> $REPORT_FILE

# 统计过去1小时内被拒绝的连接
echo "=== Top 10 Blocked IPs (Last Hour) ===" >> $REPORT_FILE
# 使用 sed 过滤掉空行和非IP地址的行，并使用 awk 提取 IP 地址
grep "iptables-denied" $LOG_FILE | tail -n 1000 | awk '{
    for (i=1;i<=NF;i++) {
        if ($i ~ /^SRC=/) {
            split($i, a, "=");
            print a[2]
        }
    }
}' | sort | uniq -c | sort -nr | head -10 >> $REPORT_FILE

# 检查异常连接数量
BLOCKED_COUNT=$(grep "iptables-denied" $LOG_FILE | wc -l)
if [ "$BLOCKED_COUNT" -gt "$THRESHOLD" ]; then
    ALERT_MSG="[WARNING] High volume of blocked connections: $BLOCKED_COUNT in last hour."
    echo "$ALERT_MSG" >> $REPORT_FILE
    logger -t firewall-monitor "$ALERT_MSG"
    # echo "$ALERT_MSG" | mail -s "Firewall Alert - $(hostname)" $EMAIL
fi

echo "" >> $REPORT_FILE
echo "Report generated successfully." >> $REPORT_FILE
EOF

chmod +x /usr/local/bin/firewall-monitor.sh

# 将脚本设置为每小时运行一次
echo "0 * * * * /usr/local/bin/firewall-monitor.sh" | crontab -
```

-----

## 4. IPSET高效封禁

`ipset` 是一个比 `iptables` 更高效的工具，可以管理大量的 IP 地址或网络集合。对于需要频繁添加、删除黑名单 IP 的场景，使用 `ipset` 可以显著提升性能。

### 4.1 IPSET基础操作

```bash
# 安装ipset
yum install ipset -y      # CentOS/RHEL
apt install ipset -y      # Ubuntu/Debian

# 创建一个名为 blacklist 的 hash:ip 类型集合，超时时间为 1小时 (3600秒)
ipset create blacklist hash:ip timeout 3600

# 将一个IP地址添加到集合中
ipset add blacklist 1.2.3.4

# 将一个网络添加到集合中
ipset add blacklist 5.6.7.0/24

# 从集合中删除IP
ipset del blacklist 1.2.3.4

# 查看集合中的所有成员
ipset list blacklist

# 将iptables规则与ipset集合关联
# 将所有源IP在 blacklist 集合中的数据包都丢弃
iptables -A INPUT -m set --match-set blacklist src -j DROP

# 保存ipset规则
ipset save > /etc/ipset.rules

# 恢复ipset规则
ipset restore < /etc/ipset.rules
```

### 4.2 自动黑名单脚本

这个脚本将结合日志分析和 `ipset`，自动将频繁访问的恶意 IP 地址添加到黑名单。

```bash
# 创建自动封禁脚本
cat > /usr/local/bin/auto-blocker.sh << 'EOF'
#!/bin/bash

LOG_FILE="/var/log/firewall.log"
# 阈值：一个IP在短时间内被拒绝的连接数
BLOCK_THRESHOLD=50
# 封禁时间（秒）
BLOCK_TIME=3600

# 确保ipset集合存在
if ! ipset list blacklist >/dev/null 2>&1; then
    ipset create blacklist hash:ip timeout $BLOCK_TIME
    iptables -A INPUT -m set --match-set blacklist src -j DROP
fi

# 检查日志，将达到阈值的IP添加到ipset黑名单
grep "iptables-denied" $LOG_FILE | tail -n 1000 | awk '{
    for (i=1;i<=NF;i++) {
        if ($i ~ /^SRC=/) {
            split($i, a, "=");
            print a[2]
        }
    }
}' | sort | uniq -c | sort -nr | while read count ip; do
    if [ "$count" -gt "$BLOCK_THRESHOLD" ]; then
        if ! ipset test blacklist $ip >/dev/null 2>&1; then
            ipset add blacklist $ip timeout $BLOCK_TIME
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            echo "[$TIMESTAMP] Auto-blocked suspicious IP: $ip (count: $count)" >> /var/log/auto-blocker.log
            logger -t auto-blocker "Auto-blocked IP $ip"
        fi
    fi
done
EOF

chmod +x /usr/local/bin/auto-blocker.sh

# 将脚本设置为每15分钟运行一次
echo "*/15 * * * * /usr/local/bin/auto-blocker.sh" | crontab -
```


我明白了。作为对之前文档的补充，我将为你整理一份关于 **UFW 防火墙** 的详细内容，并将其作为第五部分添加到文档中，与 `iptables` 和 `firewalld` 部分形成一个完整的防火墙管理指南。

-----

## 5. UFW 防火墙配置

**UFW (Uncomplicated Firewall)** 是 Debian 和 Ubuntu 系统默认且推荐的防火墙管理工具。它旨在简化复杂的 `iptables` 规则配置，提供了一个直观易用的命令行接口。

### 5.1 UFW 基础操作

```bash
# 安装 UFW (如果未安装)
sudo apt update
sudo apt install ufw -y

# 启用 UFW (请在配置好 SSH 规则后再执行)
sudo ufw enable

# 禁用 UFW
sudo ufw disable

# 查看 UFW 状态及规则
sudo ufw status verbose
sudo ufw status numbered  # 以数字形式显示规则，方便删除

# 重置所有规则为默认状态
sudo ufw reset
```

### 5.2 默认策略与基本规则

为了保证安全性，最佳实践是拒绝所有传入连接，并允许所有传出连接。

```bash
# 设置默认策略：拒绝所有传入，允许所有传出
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许常用的服务和端口
# 允许 SSH 连接 (请根据你的实际端口号进行修改，例如 2222)
sudo ufw allow 2222/tcp

# 允许 HTTP 和 HTTPS
sudo ufw allow http
sudo ufw allow https
# 或者直接使用端口号
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 允许自定义端口 (例如数据库端口 3306)
sudo ufw allow 3306/tcp

# 允许特定 IP 地址或网络访问
# 允许来自 192.168.1.100 的所有连接
sudo ufw allow from 192.168.1.100

# 允许来自 192.168.1.0/24 网段的 SSH 连接
sudo ufw allow from 192.168.1.0/24 to any port 2222
```

### 5.3 高级 UFW 规则

UFW 也支持更复杂的规则，例如速率限制，可以有效防止暴力破解攻击。

```bash
# 限制 SSH 连接速率，防止暴力破解
# 允许每 30 秒内最多 6 次新连接尝试
sudo ufw limit 2222/tcp

# 拒绝特定 IP 地址或网络
# 拒绝来自 1.2.3.4 的所有连接
sudo ufw deny from 1.2.3.4

# 拒绝来自 172.16.0.0/12 网段的所有连接
sudo ufw deny from 172.16.0.0/12
```

### 5.4 脚本化 UFW 配置

为了方便部署，可以创建一个脚本来自动化配置 UFW。

```bash
# 创建 UFW 配置脚本
cat > /usr/local/bin/setup-ufw.sh << 'EOF'
#!/bin/bash

# 禁用并重置 UFW，以清除旧规则
sudo ufw disable
sudo ufw reset -f

# 设置默认策略：拒绝所有传入，允许所有传出
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 定义自定义 SSH 端口
SSH_PORT=2222

# 允许 SSH 连接
echo "Allowing SSH access on port $SSH_PORT..."
sudo ufw allow $SSH_PORT/tcp

# 允许 HTTP/HTTPS 服务
echo "Allowing HTTP and HTTPS..."
sudo ufw allow http
sudo ufw allow https

# 限制 SSH 连接速率以防止暴力破解
echo "Applying rate limits for SSH..."
sudo ufw limit $SSH_PORT/tcp

# 允许本地回环接口 (lo)
echo "Allowing loopback interface..."
sudo ufw allow in on lo

# 启用 UFW
echo "Enabling UFW..."
sudo ufw enable

echo "UFW configuration completed. Current status:"
sudo ufw status verbose
EOF

chmod +x /usr/local/bin/setup-ufw.sh

# 运行脚本
sudo /usr/local/bin/setup-ufw.sh
```