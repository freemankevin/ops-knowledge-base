---
title: ç³»ç»Ÿå®‰å…¨åŠ å›º
description: ä¼ä¸šçº§ç³»ç»Ÿå®‰å…¨åŠ å›ºå®Œæ•´æŒ‡å—ï¼Œæ¶µç›–ç³»ç»Ÿæ›´æ–°ã€ç”¨æˆ·ç®¡ç†ã€æ–‡ä»¶ç³»ç»Ÿå®‰å…¨ã€ç½‘ç»œé…ç½®ã€ç›‘æŽ§å®¡è®¡ç­‰æ ¸å¿ƒå®‰å…¨æŽªæ–½
keywords:
  - ç³»ç»Ÿå®‰å…¨åŠ å›º
  - å®‰å…¨é˜²æŠ¤
  - è¿ç»´å®‰å…¨
  - ç³»ç»ŸçŽ¯å¢ƒ
  - å®‰å…¨åŸºçº¿
tags:
  - ç³»ç»Ÿå®‰å…¨åŠ å›º
  - å®‰å…¨é˜²æŠ¤
  - è¿ç»´
  - çŸ¥è¯†åº“
  - ç³»ç»ŸçŽ¯å¢ƒ
---

# ç³»ç»ŸåŸºç¡€å®‰å…¨åŠ å›º

## ðŸ“‹ åŠ å›ºæ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®è®¤æ‚¨çš„åŠ å›ºç›®æ ‡å’Œå½“å‰ç³»ç»ŸçŠ¶æ€ï¼š

- [ ] ç¡®è®¤ç³»ç»Ÿç‰ˆæœ¬å’Œæž¶æž„
- [ ] å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶
- [ ] å‡†å¤‡åº”æ€¥æ¢å¤æ–¹æ¡ˆ
- [ ] é€šçŸ¥ç›¸å…³äººå‘˜ç»´æŠ¤çª—å£

## 1. ç³»ç»Ÿæ›´æ–°å’Œè¡¥ä¸ç®¡ç† ðŸ”„

### 1.1 ä¿æŒç³»ç»Ÿæ›´æ–°

=== "CentOS/RHEL 8+"

    ```bash
    # æŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬
    cat /etc/redhat-release
    
    # æŸ¥çœ‹å¯æ›´æ–°çš„è½¯ä»¶åŒ…
    dnf list updates
    
    # æ›´æ–°æ‰€æœ‰è½¯ä»¶åŒ…
    dnf update -y
    
    # åªæ›´æ–°å®‰å…¨è¡¥ä¸
    dnf --security update
    
    # æŸ¥çœ‹æ›´æ–°åŽ†å²
    dnf history list
    ```

=== "CentOS/RHEL 7"

    ```bash
    # æŸ¥çœ‹å¯æ›´æ–°çš„è½¯ä»¶åŒ…
    yum list updates
    
    # æ›´æ–°æ‰€æœ‰è½¯ä»¶åŒ…
    yum update -y
    
    # åªæ›´æ–°å®‰å…¨è¡¥ä¸
    yum --security update
    
    # å®‰è£…yum-securityæ’ä»¶ï¼ˆå¦‚æžœéœ€è¦ï¼‰
    yum install yum-plugin-security -y
    ```

=== "Ubuntu/Debian"

    ```bash
    # æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
    apt update
    
    # æŸ¥çœ‹å¯å‡çº§çš„åŒ…
    apt list --upgradable
    
    # å‡çº§æ‰€æœ‰è½¯ä»¶åŒ…
    apt upgrade -y
    
    # å®Œæ•´å‡çº§ï¼ˆåŒ…æ‹¬å†…æ ¸ï¼‰
    apt full-upgrade -y
    
    # æ¸…ç†ä¸éœ€è¦çš„åŒ…
    apt autoremove -y
    apt autoclean
    ```

### 1.2 é…ç½®è‡ªåŠ¨æ›´æ–°

=== "CentOS/RHEL 8+"

    ```bash
    # å®‰è£…å¹¶é…ç½®dnf-automatic
    dnf install dnf-automatic -y
    
    # ç¼–è¾‘é…ç½®æ–‡ä»¶
    vim /etc/dnf/automatic.conf
    # å…³é”®é…ç½®ï¼š
    # apply_updates = yes
    # upgrade_type = security
    # email_to = admin@yourdomain.com
    # email_from = system@yourdomain.com
    
    # å¯ç”¨æœåŠ¡
    systemctl enable --now dnf-automatic.timer
    systemctl status dnf-automatic.timer
    ```

=== "CentOS/RHEL 7"

    ```bash
    yum install yum-cron -y
    systemctl enable yum-cron
    systemctl start yum-cron
    
    # ç¼–è¾‘é…ç½®æ–‡ä»¶
    vim /etc/yum/yum-cron.conf
    # è®¾ç½®ä»¥ä¸‹å‚æ•°ï¼š
    # apply_updates = yes
    # update_cmd = security
    # email_to = admin@yourdomain.com
    # email_from = root@localhost
    ```

=== "Ubuntu/Debian"

    ```bash
    apt install unattended-upgrades apt-listchanges -y
    dpkg-reconfigure -plow unattended-upgrades
    
    # è¯¦ç»†é…ç½®
    cat > /etc/apt/apt.conf.d/50unattended-upgrades << EOF
    Unattended-Upgrade::Allowed-Origins {
        "\${distro_id}:\${distro_codename}-security";
        "\${distro_id}ESMApps:\${distro_codename}-apps-security";
        "\${distro_id}ESM:\${distro_codename}-infra-security";
    };
    
    // è‡ªåŠ¨é‡å¯é…ç½®
    Unattended-Upgrade::Automatic-Reboot "false";
    Unattended-Upgrade::Automatic-Reboot-WithUsers "false";
    Unattended-Upgrade::Automatic-Reboot-Time "02:00";
    
    // é‚®ä»¶é€šçŸ¥
    Unattended-Upgrade::Mail "admin@yourdomain.com";
    Unattended-Upgrade::MailReport "on-change";
    
    // æ—¥å¿—å’Œæ¸…ç†
    Unattended-Upgrade::AutoFixInterruptedDpkg "true";
    Unattended-Upgrade::MinimalSteps "true";
    Unattended-Upgrade::Remove-Unused-Dependencies "true";
    Unattended-Upgrade::Remove-New-Unused-Dependencies "true";
    EOF
    
    # é…ç½®å®šæ—¶ä»»åŠ¡é¢‘çŽ‡
    vim /etc/apt/apt.conf.d/20auto-upgrades
    # APT::Periodic::Update-Package-Lists "1";
    # APT::Periodic::Unattended-Upgrade "1";
    ```

### 1.3 å†…æ ¸å®‰å…¨é…ç½®

```bash
# æŸ¥çœ‹å½“å‰å†…æ ¸ç‰ˆæœ¬
uname -r

# é…ç½®å†…æ ¸å®‰å…¨å‚æ•°
cat >> /etc/sysctl.d/99-security.conf << EOF
# æ ¸å¿ƒè½¬å‚¨é™åˆ¶
fs.suid_dumpable = 0
kernel.core_uses_pid = 1

# å†…å­˜ä¿æŠ¤
kernel.exec-shield = 1
kernel.randomize_va_space = 2

# è¿›ç¨‹é™åˆ¶
kernel.pid_max = 65536

# dmesgé™åˆ¶
kernel.dmesg_restrict = 1
kernel.kptr_restrict = 2

# æ€§èƒ½äº‹ä»¶é™åˆ¶
kernel.perf_event_paranoid = 3

# ç”¨æˆ·å‘½åç©ºé—´é™åˆ¶ (å¦‚æžœä¸ä½¿ç”¨å®¹å™¨)
# user.max_user_namespaces = 0
EOF

# åº”ç”¨é…ç½®
sysctl -p /etc/sysctl.d/99-security.conf
```

## 2. ç”¨æˆ·å’Œæƒé™ç®¡ç† ðŸ‘¥

### 2.1 ç¦ç”¨ä¸å¿…è¦çš„ç”¨æˆ·è´¦æˆ·

```bash
# æŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰ç”¨æˆ·
getent passwd

# æŸ¥çœ‹å¯ç™»å½•çš„ç”¨æˆ·
getent passwd | grep -E "/bin/bash|/bin/sh|/bin/zsh"

# æŸ¥çœ‹æœ€è¿‘ç™»å½•ç”¨æˆ·
lastlog | grep -v "Never"

# ç¦ç”¨ç³»ç»ŸæœåŠ¡è´¦æˆ·çš„shell
for user in games ftp news uucp operator gopher; do
    if id "$user" >/dev/null 2>&1; then
        usermod -s /sbin/nologin "$user"
        echo "å·²ç¦ç”¨ç”¨æˆ·: $user"
    fi
done

# é”å®šé•¿æœŸæœªä½¿ç”¨çš„è´¦æˆ·
lastlog -b 90 | awk 'NR>1 && $1 != "root" {print $1}' | while read user; do
    if id "$user" >/dev/null 2>&1; then
        usermod -L "$user"
        echo "å·²é”å®šé•¿æœŸæœªä½¿ç”¨çš„è´¦æˆ·: $user"
    fi
done
```

### 2.2 å¼ºåŒ–å¯†ç ç­–ç•¥

```bash
# å®‰è£…å¯†ç è´¨é‡æ£€æŸ¥å·¥å…·
if command -v yum >/dev/null 2>&1; then
    yum install libpwquality cracklib-dicts -y
elif command -v apt >/dev/null 2>&1; then
    apt install libpam-pwquality cracklib-runtime -y
fi

# é…ç½®å¯†ç å¤æ‚åº¦
cat > /etc/security/pwquality.conf << EOF
# å¯†ç æœ€å°é•¿åº¦
minlen = 14

# è‡³å°‘åŒ…å«çš„å­—ç¬¦ç±»åž‹æ•°é‡
minclass = 4

# æœ€å¤§é‡å¤å­—ç¬¦æ•°
maxrepeat = 2

# æœ€å¤§è¿žç»­å­—ç¬¦æ•°
maxsequence = 3

# æ•°å­—å­—ç¬¦è¦æ±‚ï¼ˆè´Ÿæ•°è¡¨ç¤ºè‡³å°‘åŒ…å«ï¼‰
dcredit = -1

# å¤§å†™å­—æ¯è¦æ±‚
ucredit = -1

# å°å†™å­—æ¯è¦æ±‚
lcredit = -1

# ç‰¹æ®Šå­—ç¬¦è¦æ±‚
ocredit = -1

# ç¦æ­¢åŒ…å«ç”¨æˆ·å
usercheck = 1

# ç¦æ­¢ä½¿ç”¨å­—å…¸è¯æ±‡
dictcheck = 1

# ä¸Žæ—§å¯†ç çš„æœ€å°å·®å¼‚
difok = 5
EOF

# é…ç½®ç™»å½•å‚æ•°
vim /etc/login.defs
# ç¡®ä¿ä»¥ä¸‹å‚æ•°è®¾ç½®æ­£ç¡®ï¼š
sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   90/' /etc/login.defs
sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   7/' /etc/login.defs
sed -i 's/^PASS_MIN_LEN.*/PASS_MIN_LEN    14/' /etc/login.defs
sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   14/' /etc/login.defs

# é…ç½®è´¦æˆ·é”å®šç­–ç•¥
if [ -f /etc/pam.d/system-auth ]; then
    # RHEL/CentOS
    PAM_FILE="/etc/pam.d/system-auth"
else
    # Ubuntu/Debian
    PAM_FILE="/etc/pam.d/common-auth"
fi

# å¤‡ä»½åŽŸæ–‡ä»¶
cp $PAM_FILE ${PAM_FILE}.backup

# æ·»åŠ è´¦æˆ·é”å®šé…ç½®ï¼ˆ5æ¬¡å¤±è´¥åŽé”å®š10åˆ†é’Ÿï¼‰
echo "auth required pam_faillock.so preauth deny=5 unlock_time=600" >> $PAM_FILE
echo "auth sufficient pam_faillock.so authfail deny=5 unlock_time=600" >> $PAM_FILE
```

### 2.3 é…ç½®sudoæƒé™å’Œå®¡è®¡

```bash
# å¤‡ä»½sudoersæ–‡ä»¶
cp /etc/sudoers /etc/sudoers.backup.$(date +%Y%m%d)

# é…ç½®sudoå®‰å…¨é€‰é¡¹
cat >> /etc/sudoers << 'EOF'
# æ—¥å¿—é…ç½®
Defaults logfile=/var/log/sudo.log
Defaults log_year, log_host, log_input, log_output
Defaults iolog_dir=/var/log/sudo-io
Defaults log_input, log_output

# å®‰å…¨é€‰é¡¹
Defaults requiretty
Defaults env_reset
Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
Defaults timestamp_timeout=15
Defaults passwd_timeout=5
Defaults passwd_tries=3

# ç¦æ­¢å±é™©å‘½ä»¤
Defaults passwd_tries=3
Cmnd_Alias DANGEROUS = /bin/su, /usr/bin/passwd root, /bin/chmod 777 *, /bin/chown root *
ALL ALL = !DANGEROUS
EOF

# åˆ›å»ºsudoæ—¥å¿—è½®è½¬é…ç½®
cat > /etc/logrotate.d/sudo << EOF
/var/log/sudo.log {
    weekly
    rotate 52
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root root
}

/var/log/sudo-io/*/*.log {
    weekly
    rotate 52
    compress
    delaycompress
    missingok
    notifempty
}
EOF
```

### 2.4 é…ç½®ç”¨æˆ·ä¼šè¯é™åˆ¶

```bash
# é…ç½®ç”¨æˆ·èµ„æºé™åˆ¶
cat >> /etc/security/limits.conf << EOF
# è¿›ç¨‹æ•°é™åˆ¶
* soft nproc 4096
* hard nproc 8192

# æ–‡ä»¶å¥æŸ„é™åˆ¶
* soft nofile 65536
* hard nofile 65536

# å†…å­˜ä½¿ç”¨é™åˆ¶ï¼ˆä»¥KBä¸ºå•ä½ï¼‰
* soft as 4194304
* hard as 8388608

# CPUæ—¶é—´é™åˆ¶ï¼ˆåˆ†é’Ÿï¼‰
* soft cpu 30
* hard cpu 60

# é˜²æ­¢forkç‚¸å¼¹
* hard maxlogins 3
EOF

# é…ç½®ä¼šè¯è¶…æ—¶
echo "TMOUT=900" >> /etc/profile
echo "readonly TMOUT" >> /etc/profile
echo "export TMOUT" >> /etc/profile

# é…ç½®ç™»å½•å¤±è´¥å»¶è¿Ÿ
echo "FAIL_DELAY 3" >> /etc/login.defs
```

## 3. æ–‡ä»¶ç³»ç»Ÿå®‰å…¨ ðŸ“

### 3.1 è®¾ç½®å…³é”®æ–‡ä»¶æƒé™

```bash
#!/bin/bash
# ç³»ç»Ÿæ–‡ä»¶æƒé™åŠ å›ºè„šæœ¬

echo "å¼€å§‹æ–‡ä»¶æƒé™åŠ å›º..."

# å…³é”®ç³»ç»Ÿæ–‡ä»¶æƒé™è®¾ç½®
declare -A file_permissions=(
    ["/etc/passwd"]="644"
    ["/etc/group"]="644"
    ["/etc/shadow"]="000"
    ["/etc/gshadow"]="000"
    ["/etc/ssh/sshd_config"]="600"
    ["/etc/crontab"]="600"
    ["/etc/sudoers"]="440"
    ["/boot/grub2/grub.cfg"]="600"
    ["/boot/grub/grub.cfg"]="600"
)

for file in "${!file_permissions[@]}"; do
    if [ -f "$file" ]; then
        chmod "${file_permissions[$file]}" "$file"
        echo "å·²è®¾ç½® $file æƒé™ä¸º ${file_permissions[$file]}"
    fi
done

# æŸ¥æ‰¾å¹¶ä¿®å¤æƒé™è¿‡äºŽå®½æ¾çš„æ–‡ä»¶
echo "æŸ¥æ‰¾æƒé™è¿‡äºŽå®½æ¾çš„æ–‡ä»¶..."
find /etc -type f -perm -002 -exec chmod o-w {} \; 2>/dev/null
find /etc -type f -perm -020 -exec chmod g-w {} \; 2>/dev/null

# æŸ¥æ‰¾SUIDå’ŒSGIDæ–‡ä»¶
echo "æ‰«æSUID/SGIDæ–‡ä»¶..."
find / -type f \( -perm -4000 -o -perm -2000 \) -exec ls -la {} \; 2>/dev/null > /tmp/suid_sgid_files.txt

# ç§»é™¤ä¸å¿…è¦çš„SUIDä½
unnecessary_suid_files="/usr/bin/chage /usr/bin/gpasswd /usr/bin/wall /usr/bin/chfn /usr/bin/chsh /usr/bin/newgrp /usr/bin/write"
for file in $unnecessary_suid_files; do
    if [ -f "$file" ]; then
        chmod u-s "$file"
        echo "å·²ç§»é™¤ $file çš„SUIDä½"
    fi
done
```

### 3.2 ç£ç›˜æŒ‚è½½å®‰å…¨é€‰é¡¹

```bash
# æ£€æŸ¥å½“å‰æŒ‚è½½é€‰é¡¹
mount | column -t

# åˆ›å»ºå®‰å…¨çš„fstabå¤‡ä»½
cp /etc/fstab /etc/fstab.backup.$(date +%Y%m%d)

# ä¸ºä¸´æ—¶ç›®å½•æ·»åŠ å®‰å…¨æŒ‚è½½é€‰é¡¹
cat >> /etc/fstab << EOF
# å®‰å…¨æŒ‚è½½é€‰é¡¹
tmpfs /tmp tmpfs defaults,rw,nosuid,nodev,noexec,relatime,size=2G 0 0
tmpfs /var/tmp tmpfs defaults,rw,nosuid,nodev,noexec,relatime,size=1G 0 0
tmpfs /dev/shm tmpfs defaults,rw,nosuid,nodev,noexec,relatime,size=1G 0 0
EOF

# ç«‹å³åº”ç”¨æŒ‚è½½
mount -o remount,nodev,nosuid,noexec /tmp
mount -o remount,nodev,nosuid,noexec /var/tmp
mount -o remount,nodev,nosuid,noexec /dev/shm
```

### 3.3 æ–‡ä»¶å®Œæ•´æ€§ç›‘æŽ§

```bash
# å®‰è£…AIDE
if command -v yum >/dev/null 2>&1; then
    yum install aide -y
elif command -v apt >/dev/null 2>&1; then
    apt install aide aide-common -y
fi

# é…ç½®AIDE
cat > /etc/aide.conf << EOF
# AIDEé…ç½®æ–‡ä»¶
database=file:/var/lib/aide/aide.db
database_out=file:/var/lib/aide/aide.db.new
gzip_dbout=yes

# å®šä¹‰æ£€æŸ¥è§„åˆ™
Binlib = p+i+n+u+g+s+b+m+c+md5+sha1
ConfFiles = p+i+n+u+g+s+b+m+c+md5+sha1
Logs = p+i+n+u+g+S
Devices = p+i+n+u+g+s+b+c+md5+sha1

# ç›‘æŽ§ç›®å½•
/boot Binlib
/bin Binlib
/sbin Binlib
/usr/bin Binlib
/usr/sbin Binlib
/usr/libexec Binlib
/usr/local/bin Binlib
/usr/local/sbin Binlib

# é…ç½®æ–‡ä»¶
/etc ConfFiles
!/etc/mtab

# æ—¥å¿—æ–‡ä»¶
/var/log Logs
!/var/log/.*
EOF

# åˆå§‹åŒ–AIDEæ•°æ®åº“
aide --init
mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db

# åˆ›å»ºæ¯æ—¥æ£€æŸ¥è„šæœ¬
cat > /etc/cron.daily/aide-check << 'EOF'
#!/bin/bash
LOGFILE="/var/log/aide-check.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$DATE] å¼€å§‹AIDEæ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥" >> $LOGFILE

if /usr/bin/aide --check >> $LOGFILE 2>&1; then
    echo "[$DATE] AIDEæ£€æŸ¥å®Œæˆï¼Œæœªå‘çŽ°å˜åŒ–" >> $LOGFILE
else
    echo "[$DATE] AIDEæ£€æŸ¥å‘çŽ°æ–‡ä»¶å˜åŒ–ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $LOGFILE
    # å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æžœé…ç½®äº†é‚®ä»¶ç³»ç»Ÿï¼‰
    if command -v mail >/dev/null 2>&1; then
        tail -50 $LOGFILE | mail -s "AIDE Alert - $(hostname)" admin@yourdomain.com
    fi
fi

echo "[$DATE] AIDEæ£€æŸ¥ç»“æŸ" >> $LOGFILE
echo "----------------------------------------" >> $LOGFILE
EOF

chmod +x /etc/cron.daily/aide-check
```

## 4. æœåŠ¡å’Œè¿›ç¨‹å®‰å…¨ âš™ï¸

### 4.1 æœåŠ¡ç®¡ç†å’Œæœ€å°åŒ–

```bash
#!/bin/bash
# æœåŠ¡å®‰å…¨é…ç½®è„šæœ¬

echo "å½“å‰è¿è¡Œçš„æœåŠ¡ï¼š"
systemctl list-units --type=service --state=running

# å®šä¹‰é€šå¸¸å¯ä»¥ç¦ç”¨çš„æœåŠ¡
unnecessary_services=(
    "bluetooth"
    "cups"
    "avahi-daemon"
    "postfix"
    "sendmail"
    "rpcbind"
    "nfs"
    "smb"
    "nmb"
    "telnet"
    "rsh"
    "rlogin"
)

echo "æ­£åœ¨ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡..."
for service in "${unnecessary_services[@]}"; do
    if systemctl is-enabled "$service" >/dev/null 2>&1; then
        systemctl disable "$service"
        systemctl stop "$service"
        echo "å·²ç¦ç”¨æœåŠ¡: $service"
    fi
done

# æ£€æŸ¥ç›‘å¬ç«¯å£
echo "å½“å‰ç›‘å¬çš„ç«¯å£ï¼š"
ss -tulnp | grep LISTEN
```

### 4.2 è¿›ç¨‹èµ„æºé™åˆ¶

```bash
# é…ç½®systemdæœåŠ¡èµ„æºé™åˆ¶
mkdir -p /etc/systemd/system.conf.d
cat > /etc/systemd/system.conf.d/security.conf << EOF
[Manager]
# é»˜è®¤æœåŠ¡é™åˆ¶
DefaultLimitNOFILE=65536
DefaultLimitNPROC=4096
DefaultLimitCORE=0
DefaultLimitAS=4294967296

# è¶…æ—¶è®¾ç½®
DefaultTimeoutStopSec=30s
DefaultTimeoutStartSec=30s
EOF

systemctl daemon-reload
```

## 5. ç½‘ç»œå®‰å…¨åŸºç¡€é…ç½® ðŸŒ

### 5.1 ç½‘ç»œå‚æ•°å®‰å…¨ä¼˜åŒ–

```bash
# åˆ›å»ºç½‘ç»œå®‰å…¨é…ç½®
cat > /etc/sysctl.d/10-network-security.conf << EOF
# TCP/IPå®‰å…¨é…ç½®
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_max_syn_backlog = 4096

# IPè½¬å‘æŽ§åˆ¶
net.ipv4.ip_forward = 0
net.ipv6.conf.all.forwarding = 0

# æºè·¯ç”±ä¿æŠ¤
net.ipv4.conf.all.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# ICMPé‡å®šå‘ä¿æŠ¤
net.ipv4.conf.all.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# IPæ¬ºéª—ä¿æŠ¤
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# è®°å½•å¯ç–‘åŒ…
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# ICMPæŽ§åˆ¶
net.ipv4.icmp_echo_ignore_all = 0
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1

# IPv6å®‰å…¨ï¼ˆå¦‚æžœä¸ä½¿ç”¨IPv6å¯ä»¥ç¦ç”¨ï¼‰
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0
EOF

# åº”ç”¨é…ç½®
sysctl -p /etc/sysctl.d/10-network-security.conf
```

## 6. ç³»ç»Ÿç›‘æŽ§å’Œå®¡è®¡ ðŸ“Š

### 6.1 å®¡è®¡ç³»ç»Ÿé…ç½®

```bash
# å®‰è£…å¹¶é…ç½®auditd
if command -v yum >/dev/null 2>&1; then
    yum install audit audit-libs -y
elif command -v apt >/dev/null 2>&1; then
    apt install auditd audispd-plugins -y
fi

# å¯ç”¨å®¡è®¡æœåŠ¡
systemctl enable auditd
systemctl start auditd

# é…ç½®è¯¦ç»†çš„å®¡è®¡è§„åˆ™
cat > /etc/audit/rules.d/security.rules << EOF
# åˆ é™¤æ‰€æœ‰çŽ°æœ‰è§„åˆ™
-D

# è®¾ç½®ç¼“å†²åŒºå¤§å°
-b 8192

# å¤±è´¥å¤„ç†
-f 1

# ç›‘æŽ§èº«ä»½ç›¸å…³æ–‡ä»¶
-w /etc/passwd -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity

# ç›‘æŽ§æƒé™ç›¸å…³æ–‡ä»¶
-w /etc/sudoers -p wa -k scope
-w /etc/sudoers.d/ -p wa -k scope

# ç›‘æŽ§ç™»å½•ç›¸å…³
-w /var/log/lastlog -p wa -k logins
-w /var/log/faillog -p wa -k logins
-w /var/log/wtmp -p wa -k logins
-w /var/log/btmp -p wa -k logins

# ç›‘æŽ§ç½‘ç»œé…ç½®
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k network
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k network
-w /etc/hosts -p wa -k network
-w /etc/network/ -p wa -k network

# ç›‘æŽ§æ—¶é—´æ›´æ”¹
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
-a always,exit -F arch=b32 -S adjtimex -S settimeofday -k time-change
-w /etc/localtime -p wa -k time-change

# ç›‘æŽ§MACç­–ç•¥
-w /etc/selinux/ -p wa -k MAC-policy

# ç›‘æŽ§æ–‡ä»¶æƒé™ä¿®æ”¹
-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -k perm_mod
-a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -k perm_mod
-a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -k perm_mod
-a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -k perm_mod

# ç›‘æŽ§æ–‡ä»¶è®¿é—®
-a always,exit -F arch=b64 -S creat -S open -S openat -S open_by_handle_at -S truncate -S ftruncate -k file_access
-a always,exit -F arch=b32 -S creat -S open -S openat -S open_by_handle_at -S truncate -S ftruncate -k file_access

# ç›‘æŽ§æŒ‚è½½æ“ä½œ
-a always,exit -F arch=b64 -S mount -k mounts
-a always,exit -F arch=b32 -S mount -k mounts

# ç›‘æŽ§æ–‡ä»¶åˆ é™¤
-a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -k delete
-a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -k delete

# ç›‘æŽ§å†…æ ¸æ¨¡å—
-w /sbin/insmod -p x -k modules
-w /sbin/rmmod -p x -k modules
-w /sbin/modprobe -p x -k modules
-a always,exit -F arch=b64 -S init_module -S delete_module -k modules

# é”å®šè§„åˆ™é…ç½®
-e 2
EOF

# é‡æ–°åŠ è½½å®¡è®¡è§„åˆ™
augenrules --load
systemctl restart auditd
```

### 6.2 ç³»ç»Ÿç›‘æŽ§è„šæœ¬

```bash
# åˆ›å»ºç»¼åˆç›‘æŽ§è„šæœ¬
cat > /usr/local/bin/system-security-monitor.sh << 'EOF'
#!/bin/bash

# é…ç½®
LOG_FILE="/var/log/security-monitor.log"
ALERT_EMAIL="admin@yourdomain.com"
CPU_THRESHOLD=80
MEMORY_THRESHOLD=80
DISK_THRESHOLD=90

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# æ£€æŸ¥CPUä½¿ç”¨çŽ‡
check_cpu() {
    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
    CPU_USAGE=${CPU_USAGE%.*}
    
    if [ $CPU_USAGE -gt $CPU_THRESHOLD ]; then
        log_message "${RED}âš ï¸  CPUä½¿ç”¨çŽ‡è¿‡é«˜: ${CPU_USAGE}%${NC}"
        return 1
    else
        log_message "${GREEN}âœ… CPUä½¿ç”¨çŽ‡æ­£å¸¸: ${CPU_USAGE}%${NC}"
        return 0
    fi
}

# æ£€æŸ¥å¯ç–‘è¿›ç¨‹
check_suspicious_processes() {
    log_message "ðŸ” æ£€æŸ¥å¯ç–‘è¿›ç¨‹..."
    
    # æ£€æŸ¥é«˜CPUä½¿ç”¨çŽ‡è¿›ç¨‹
    HIGH_CPU_PROCS=$(ps aux --sort=-%cpu | head -6 | tail -5)
    log_message "CPUä½¿ç”¨çŽ‡æœ€é«˜çš„è¿›ç¨‹:"
    echo "$HIGH_CPU_PROCS" >> $LOG_FILE
    
    # æ£€æŸ¥å¯ç–‘ç½‘ç»œè¿žæŽ¥
    SUSPICIOUS_CONNECTIONS=$(netstat -tuln | grep -E ':22[0-9][0-9]|:3[0-9][0-9][0-9][0-9]|:4[4-9][0-9][0-9][0-9]')
    if [ ! -z "$SUSPICIOUS_CONNECTIONS" ]; then
        log_message "${YELLOW}âš ï¸  å‘çŽ°å¯ç–‘ç«¯å£ç›‘å¬:${NC}"
        echo "$SUSPICIOUS_CONNECTIONS" >> $LOG_FILE
    fi
}

# æ£€æŸ¥ç³»ç»Ÿå®Œæ•´æ€§
check_system_integrity() {
    log_message "ðŸ” æ£€æŸ¥ç³»ç»Ÿå®Œæ•´æ€§..."
    
    # æ£€æŸ¥å…³é”®æ–‡ä»¶æƒé™
    CRITICAL_FILES=("/etc/passwd" "/etc/shadow" "/etc/sudoers" "/etc/ssh/sshd_config")
    for file in "${CRITICAL_FILES[@]}"; do
        if [ -f "$file" ]; then
            PERMS=$(stat -c "%a" "$file")
            case "$file" in
                "/etc/shadow")
                    if [ "$PERMS" != "000" ] && [ "$PERMS" != "640" ]; then
                        log_message "${RED}âš ï¸  $file æƒé™å¼‚å¸¸: $PERMS${NC}"
                    fi
                    ;;
                "/etc/sudoers")
                    if [ "$PERMS" != "440" ]; then
                        log_message "${RED}âš ï¸  $file æƒé™å¼‚å¸¸: $PERMS${NC}"
                    fi
                    ;;
                *)
                    if [ "$PERMS" != "644" ]; then
                        log_message "${YELLOW}âš ï¸  $file æƒé™å¯èƒ½å¼‚å¸¸: $PERMS${NC}"
                    fi
                    ;;
            esac
        fi
    done
}

# ä¸»æ£€æŸ¥å‡½æ•°
main() {
    log_message "==================== å¼€å§‹å®‰å…¨ç›‘æŽ§ ===================="
    
    ALERTS=0
    
    # æ‰§è¡Œå„é¡¹æ£€æŸ¥
    check_cpu || ((ALERTS++))
    check_memory || ((ALERTS++))
    check_disk || ((ALERTS++))
    check_login_failures || ((ALERTS++))
    check_suspicious_processes
    check_system_integrity
    
    # æ±‡æ€»ç»“æžœ
    if [ $ALERTS -gt 0 ]; then
        log_message "${RED}ðŸš¨ å‘çŽ° $ALERTS ä¸ªå®‰å…¨å‘Šè­¦${NC}"
        
        # å‘é€é‚®ä»¶å‘Šè­¦ï¼ˆå¦‚æžœé…ç½®äº†é‚®ä»¶ç³»ç»Ÿï¼‰
        if command -v mail >/dev/null 2>&1 && [ ! -z "$ALERT_EMAIL" ]; then
            tail -50 $LOG_FILE | mail -s "Security Alert - $(hostname)" $ALERT_EMAIL
        fi
    else
        log_message "${GREEN}âœ… ç³»ç»Ÿå®‰å…¨çŠ¶æ€è‰¯å¥½${NC}"
    fi
    
    log_message "==================== ç›‘æŽ§å®Œæˆ ===================="
    echo "" >> $LOG_FILE
}

# æ‰§è¡Œä¸»å‡½æ•°
main
EOF

chmod +x /usr/local/bin/system-security-monitor.sh

# æ·»åŠ åˆ°cronä»»åŠ¡ï¼ˆæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
(crontab -l 2>/dev/null; echo "0 * * * * /usr/local/bin/system-security-monitor.sh") | crontab -
```

### 6.3 å®‰å…¨äº‹ä»¶å“åº”è„šæœ¬

```bash
# åˆ›å»ºå®‰å…¨äº‹ä»¶å“åº”è„šæœ¬
cat > /usr/local/bin/security-incident-response.sh << 'EOF'
#!/bin/bash

# å®‰å…¨äº‹ä»¶å“åº”è„šæœ¬
INCIDENT_LOG="/var/log/security-incidents.log"
BACKUP_DIR="/var/backups/security-$(date +%Y%m%d_%H%M%S)"

# åˆ›å»ºäº‹ä»¶å“åº”åŠŸèƒ½
incident_response() {
    local incident_type="$1"
    local description="$2"
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] INCIDENT: $incident_type - $description" | tee -a $INCIDENT_LOG
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    mkdir -p $BACKUP_DIR
    
    case "$incident_type" in
        "BRUTE_FORCE")
            # åº”å¯¹æš´åŠ›ç ´è§£
            echo "æ£€æµ‹åˆ°æš´åŠ›ç ´è§£æ”»å‡»ï¼Œæ‰§è¡Œé˜²æŠ¤æŽªæ–½..."
            
            # å¯¼å‡ºå½“å‰è¿žæŽ¥ä¿¡æ¯
            netstat -tuln > $BACKUP_DIR/netstat.log
            ss -tuln > $BACKUP_DIR/ss.log
            
            # å¯¼å‡ºæœ€è¿‘çš„ç™»å½•å°è¯•
            tail -1000 /var/log/secure > $BACKUP_DIR/recent_auth.log 2>/dev/null || true
            tail -1000 /var/log/auth.log > $BACKUP_DIR/recent_auth.log 2>/dev/null || true
            
            # åˆ†æžæ”»å‡»æ¥æºIP
            grep "Failed password" /var/log/secure /var/log/auth.log 2>/dev/null | \
                awk '{print $(NF-3)}' | sort | uniq -c | sort -nr > $BACKUP_DIR/attack_ips.log
            ;;
            
        "MALWARE")
            # åº”å¯¹æ¶æ„è½¯ä»¶
            echo "æ£€æµ‹åˆ°å¯ç–‘è¿›ç¨‹ï¼Œæ‰§è¡Œéš”ç¦»æŽªæ–½..."
            
            # å¯¼å‡ºè¿›ç¨‹ä¿¡æ¯
            ps auxf > $BACKUP_DIR/processes.log
            lsof > $BACKUP_DIR/open_files.log 2>/dev/null
            
            # å¯¼å‡ºç½‘ç»œè¿žæŽ¥
            netstat -anp > $BACKUP_DIR/network_connections.log
            ;;
            
        "FILE_INTEGRITY")
            # åº”å¯¹æ–‡ä»¶å®Œæ•´æ€§é—®é¢˜
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å®Œæ•´æ€§å¼‚å¸¸..."
            
            # è¿è¡ŒAIDEæ£€æŸ¥
            aide --check > $BACKUP_DIR/aide_check.log 2>&1 || true
            
            # å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶
            tar -czf $BACKUP_DIR/critical_configs.tar.gz /etc/passwd /etc/shadow /etc/group /etc/sudoers /etc/ssh/ 2>/dev/null
            ;;
    esac
    
    echo "äº‹ä»¶å“åº”å®Œæˆï¼Œå¤‡ä»½æ–‡ä»¶ä¿å­˜åœ¨: $BACKUP_DIR"
}

# å¿«é€Ÿç³»ç»Ÿéš”ç¦»å‡½æ•°
emergency_isolation() {
    echo "âš ï¸  æ‰§è¡Œç´§æ€¥éš”ç¦»ç¨‹åº..."
    
    # æ–­å¼€ç½‘ç»œè¿žæŽ¥ï¼ˆä»…ä¿ç•™æœ¬åœ°å›žçŽ¯ï¼‰
    iptables -P INPUT DROP
    iptables -P FORWARD DROP
    iptables -P OUTPUT DROP
    iptables -A INPUT -i lo -j ACCEPT
    iptables -A OUTPUT -o lo -j ACCEPT
    
    # è®°å½•éš”ç¦»æ“ä½œ
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] EMERGENCY: System isolated" | tee -a $INCIDENT_LOG
    
    echo "âœ… ç³»ç»Ÿå·²éš”ç¦»ï¼Œä»…å…è®¸æœ¬åœ°è¿žæŽ¥"
    echo "æ¢å¤ç½‘ç»œè¿žæŽ¥å‘½ä»¤: iptables -F && iptables -P INPUT ACCEPT && iptables -P FORWARD ACCEPT && iptables -P OUTPUT ACCEPT"
}

# æ ¹æ®å‚æ•°æ‰§è¡Œç›¸åº”æ“ä½œ
case "$1" in
    "brute_force")
        incident_response "BRUTE_FORCE" "Detected brute force attack"
        ;;
    "malware")
        incident_response "MALWARE" "Detected suspicious process"
        ;;
    "file_integrity")
        incident_response "FILE_INTEGRITY" "File integrity violation detected"
        ;;
    "isolate")
        emergency_isolation
        ;;
    *)
        echo "ç”¨æ³•: $0 {brute_force|malware|file_integrity|isolate}"
        echo "ç¤ºä¾‹: $0 brute_force"
        exit 1
        ;;
esac
EOF

chmod +x /usr/local/bin/security-incident-response.sh
```

## 7. è‡ªåŠ¨åŒ–å®‰å…¨åŠ å›ºè„šæœ¬ ðŸ¤–

### 7.1 ä¸€é”®åŠ å›ºè„šæœ¬

```bash
# åˆ›å»ºä¸€é”®åŠ å›ºè„šæœ¬
cat > /usr/local/bin/auto-hardening.sh << 'EOF'
#!/bin/bash

# ç³»ç»Ÿè‡ªåŠ¨åŒ–å®‰å…¨åŠ å›ºè„šæœ¬
# ç‰ˆæœ¬: 2.0
# é€‚ç”¨: CentOS/RHEL 7-8, Ubuntu 18.04-22.04

set -euo pipefail

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# æ—¥å¿—æ–‡ä»¶
LOG_FILE="/var/log/system-hardening.log"
BACKUP_DIR="/var/backups/pre-hardening-$(date +%Y%m%d_%H%M%S)"

# æ—¥å¿—å‡½æ•°
log() {
    echo -e "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# é”™è¯¯å¤„ç†
error_exit() {
    log "${RED}é”™è¯¯: $1${NC}"
    exit 1
}

# æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error_exit "æ­¤è„šæœ¬éœ€è¦rootæƒé™è¿è¡Œ"
    fi
}

# ç³»ç»Ÿæ£€æµ‹
detect_system() {
    if [ -f /etc/redhat-release ]; then
        OS="redhat"
        if grep -q "release 7" /etc/redhat-release; then
            VERSION="7"
        elif grep -q "release 8" /etc/redhat-release; then
            VERSION="8"
        fi
    elif [ -f /etc/lsb-release ]; then
        OS="ubuntu"
        VERSION=$(lsb_release -rs)
    elif [ -f /etc/debian_version ]; then
        OS="debian"
        VERSION=$(cat /etc/debian_version)
    else
        error_exit "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ"
    fi
    
    log "${GREEN}æ£€æµ‹åˆ°ç³»ç»Ÿ: $OS $VERSION${NC}"
}

# åˆ›å»ºå¤‡ä»½
create_backup() {
    log "${BLUE}åˆ›å»ºç³»ç»Ÿé…ç½®å¤‡ä»½...${NC}"
    mkdir -p $BACKUP_DIR
    
    # å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶
    cp /etc/passwd $BACKUP_DIR/ 2>/dev/null || true
    cp /etc/shadow $BACKUP_DIR/ 2>/dev/null || true
    cp /etc/group $BACKUP_DIR/ 2>/dev/null || true
    cp /etc/sudoers $BACKUP_DIR/ 2>/dev/null || true
    cp -r /etc/ssh/ $BACKUP_DIR/ssh_backup/ 2>/dev/null || true
    cp /etc/login.defs $BACKUP_DIR/ 2>/dev/null || true
    cp /etc/security/limits.conf $BACKUP_DIR/ 2>/dev/null || true
    
    log "${GREEN}å¤‡ä»½å®Œæˆ: $BACKUP_DIR${NC}"
}

# æ›´æ–°ç³»ç»Ÿ
update_system() {
    log "${BLUE}æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…...${NC}"
    
    if [[ "$OS" == "redhat" ]]; then
        if [[ "$VERSION" == "8" ]]; then
            dnf update -y
        else
            yum update -y
        fi
    elif [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
        apt update && apt upgrade -y
    fi
    
    log "${GREEN}ç³»ç»Ÿæ›´æ–°å®Œæˆ${NC}"
}

# é…ç½®å¯†ç ç­–ç•¥
configure_password_policy() {
    log "${BLUE}é…ç½®å¯†ç ç­–ç•¥...${NC}"
    
    # å®‰è£…å¯†ç è´¨é‡æ£€æŸ¥å·¥å…·
    if [[ "$OS" == "redhat" ]]; then
        if [[ "$VERSION" == "8" ]]; then
            dnf install -y libpwquality
        else
            yum install -y libpwquality cracklib-dicts
        fi
    elif [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
        apt install -y libpam-pwquality cracklib-runtime
    fi
    
    # é…ç½®å¯†ç å¤æ‚åº¦
    cat > /etc/security/pwquality.conf << 'EOL'
minlen = 14
minclass = 4
maxrepeat = 2
maxsequence = 3
dcredit = -1
ucredit = -1
lcredit = -1
ocredit = -1
usercheck = 1
dictcheck = 1
difok = 5
EOL
    
    # ä¿®æ”¹ç™»å½•é…ç½®
    sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   90/' /etc/login.defs
    sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   7/' /etc/login.defs
    sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   14/' /etc/login.defs
    
    log "${GREEN}å¯†ç ç­–ç•¥é…ç½®å®Œæˆ${NC}"
}

# é…ç½®SSHå®‰å…¨
configure_ssh() {
    log "${BLUE}é…ç½®SSHå®‰å…¨è®¾ç½®...${NC}"
    
    # å¤‡ä»½SSHé…ç½®
    cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d)
    
    # åº”ç”¨SSHå®‰å…¨é…ç½®
    cat > /etc/ssh/sshd_config << 'EOL'
# SSHå®‰å…¨é…ç½®
Port 22
Protocol 2

# è®¤è¯è®¾ç½®
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes

# è¿žæŽ¥è®¾ç½®
X11Forwarding no
PrintMotd no
PrintLastLog yes
TCPKeepAlive yes
Compression delayed
ClientAliveInterval 300
ClientAliveCountMax 2
MaxAuthTries 3
MaxSessions 2

# é™åˆ¶ç”¨æˆ·å’Œç»„
AllowUsers *
#AllowGroups ssh-users

# å…¶ä»–å®‰å…¨è®¾ç½®
PermitUserEnvironment no
PermitTunnel no
Banner /etc/issue.net
EOL

    # é‡å¯SSHæœåŠ¡
    systemctl reload sshd
    
    log "${GREEN}SSHå®‰å…¨é…ç½®å®Œæˆ${NC}"
}

# é…ç½®é˜²ç«å¢™åŸºç¡€è§„åˆ™
configure_basic_firewall() {
    log "${BLUE}é…ç½®åŸºç¡€é˜²ç«å¢™è§„åˆ™...${NC}"
    
    if [[ "$OS" == "redhat" ]]; then
        systemctl enable firewalld
        systemctl start firewalld
        
        # åŸºç¡€è§„åˆ™
        firewall-cmd --permanent --remove-service=ssh
        firewall-cmd --permanent --add-port=22/tcp
        firewall-cmd --permanent --add-service=http
        firewall-cmd --permanent --add-service=https
        firewall-cmd --reload
        
    elif [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
        apt install -y ufw
        
        # é‡ç½®è§„åˆ™
        ufw --force reset
        
        # é»˜è®¤ç­–ç•¥
        ufw default deny incoming
        ufw default allow outgoing
        
        # åŸºç¡€è§„åˆ™
        ufw allow 22/tcp
        ufw allow 80/tcp
        ufw allow 443/tcp
        
        # å¯ç”¨é˜²ç«å¢™
        ufw --force enable
    fi
    
    log "${GREEN}åŸºç¡€é˜²ç«å¢™é…ç½®å®Œæˆ${NC}"
}

# å®‰è£…å®‰å…¨å·¥å…·
install_security_tools() {
    log "${BLUE}å®‰è£…å®‰å…¨ç›‘æŽ§å·¥å…·...${NC}"
    
    if [[ "$OS" == "redhat" ]]; then
        if [[ "$VERSION" == "8" ]]; then
            dnf install -y aide audit rkhunter logwatch
        else
            yum install -y aide audit rkhunter logwatch epel-release
        fi
    elif [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
        apt install -y aide aide-common auditd rkhunter logwatch
    fi
    
    # å¯ç”¨å®¡è®¡æœåŠ¡
    systemctl enable auditd
    systemctl start auditd
    
    log "${GREEN}å®‰å…¨å·¥å…·å®‰è£…å®Œæˆ${NC}"
}

# åº”ç”¨ç½‘ç»œå®‰å…¨å‚æ•°
apply_network_security() {
    log "${BLUE}åº”ç”¨ç½‘ç»œå®‰å…¨å‚æ•°...${NC}"
    
    cat > /etc/sysctl.d/99-network-security.conf << 'EOL'
# ç½‘ç»œå®‰å…¨å‚æ•°
net.ipv4.ip_forward = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.tcp_syncookies = 1
kernel.randomize_va_space = 2
EOL

    sysctl -p /etc/sysctl.d/99-network-security.conf
    
    log "${GREEN}ç½‘ç»œå®‰å…¨å‚æ•°åº”ç”¨å®Œæˆ${NC}"
}

# ä¸»å‡½æ•°
main() {
    log "${GREEN}==================== å¼€å§‹ç³»ç»Ÿå®‰å…¨åŠ å›º ====================${NC}"
    
    check_root
    detect_system
    create_backup
    
    # è¯¢é—®ç”¨æˆ·ç¡®è®¤
    echo -e "${YELLOW}å³å°†å¼€å§‹ç³»ç»Ÿå®‰å…¨åŠ å›ºï¼Œæ˜¯å¦ç»§ç»­? [y/N]${NC}"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        log "ç”¨æˆ·å–æ¶ˆæ“ä½œ"
        exit 0
    fi
    
    # æ‰§è¡ŒåŠ å›ºæ­¥éª¤
    update_system
    configure_password_policy
    configure_ssh
    configure_basic_firewall
    install_security_tools
    apply_network_security
    
    log "${GREEN}==================== ç³»ç»ŸåŠ å›ºå®Œæˆ ====================${NC}"
    log "${YELLOW}é‡è¦æç¤º:${NC}"
    log "1. SSHé…ç½®å·²ä¿®æ”¹ï¼Œç¡®ä¿æœ‰SSHå¯†é’¥è®¿é—®æƒé™"
    log "2. é˜²ç«å¢™å·²å¯ç”¨ï¼Œè¯·æ ¹æ®éœ€è¦è°ƒæ•´è§„åˆ™"
    log "3. å»ºè®®é‡å¯ç³»ç»Ÿä»¥ç¡®ä¿æ‰€æœ‰è®¾ç½®ç”Ÿæ•ˆ"
    log "4. å¤‡ä»½æ–‡ä»¶ä½ç½®: $BACKUP_DIR"
    
    echo -e "\n${GREEN}åŠ å›ºå®Œæˆ! å»ºè®®çŽ°åœ¨é‡å¯ç³»ç»Ÿã€‚${NC}"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
EOF

chmod +x /usr/local/bin/auto-hardening.sh
```

## 8. å®‰å…¨æ£€æŸ¥å’ŒéªŒè¯ âœ…

### 8.1 å®‰å…¨åˆè§„æ£€æŸ¥è„šæœ¬

```bash
# åˆ›å»ºå®‰å…¨åˆè§„æ£€æŸ¥è„šæœ¬
cat > /usr/local/bin/security-compliance-check.sh << 'EOF'
#!/bin/bash

# å®‰å…¨åˆè§„æ£€æŸ¥è„šæœ¬
COMPLIANCE_LOG="/var/log/compliance-check.log"
SCORE=0
TOTAL_CHECKS=0

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# æ£€æŸ¥å‡½æ•°æ¨¡æ¿
check_item() {
    local check_name="$1"
    local check_command="$2"
    local expected_result="$3"
    local weight="${4:-1}"
    
    ((TOTAL_CHECKS += weight))
    
    echo -e "\n${BLUE}æ£€æŸ¥é¡¹ç›®: $check_name${NC}"
    
    if eval "$check_command"; then
        echo -e "${GREEN}âœ… é€šè¿‡${NC}"
        ((SCORE += weight))
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] PASS: $check_name" >> $COMPLIANCE_LOG
        return 0
    else
        echo -e "${RED}âŒ å¤±è´¥${NC}"
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] FAIL: $check_name" >> $COMPLIANCE_LOG
        return 1
    fi
}

echo -e "${GREEN}==================== å®‰å…¨åˆè§„æ€§æ£€æŸ¥ ====================${NC}"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] å¼€å§‹å®‰å…¨åˆè§„æ£€æŸ¥" > $COMPLIANCE_LOG

# 1. ç³»ç»Ÿæ›´æ–°æ£€æŸ¥
check_item "ç³»ç»Ÿæ˜¯å¦ä¸ºæœ€æ–°ç‰ˆæœ¬" \
    '[ $(yum list updates 2>/dev/null | wc -l || apt list --upgradable 2>/dev/null | wc -l) -le 5 ]' \
    "updates <= 5" 2

# 2. SSHå®‰å…¨æ£€æŸ¥
check_item "SSHç¦ç”¨rootç™»å½•" \
    'grep -q "^PermitRootLogin no" /etc/ssh/sshd_config' \
    "PermitRootLogin no" 3

check_item "SSHç¦ç”¨å¯†ç è®¤è¯" \
    'grep -q "^PasswordAuthentication no" /etc/ssh/sshd_config' \
    "PasswordAuthentication no" 3

# 3. é˜²ç«å¢™çŠ¶æ€æ£€æŸ¥
check_item "é˜²ç«å¢™æœåŠ¡å·²å¯ç”¨" \
    'systemctl is-active --quiet firewalld || systemctl is-active --quiet ufw' \
    "firewall active" 2

# 4. å®¡è®¡æœåŠ¡æ£€æŸ¥
check_item "å®¡è®¡æœåŠ¡å·²å¯ç”¨" \
    'systemctl is-active --quiet auditd' \
    "auditd active" 2

# 5. å¯†ç ç­–ç•¥æ£€æŸ¥
check_item "å¯†ç æœ€å°é•¿åº¦è®¾ç½®" \
    'grep -q "minlen.*=.*1[4-9]" /etc/security/pwquality.conf' \
    "minlen >= 14" 2

# 6. æ–‡ä»¶æƒé™æ£€æŸ¥
check_item "/etc/shadowæƒé™æ£€æŸ¥" \
    '[ $(stat -c "%a" /etc/shadow) = "000" ] || [ $(stat -c "%a" /etc/shadow) = "640" ]' \
    "shadow perms correct" 3

check_item "/etc/sudoersæƒé™æ£€æŸ¥" \
    '[ $(stat -c "%a" /etc/sudoers) = "440" ]' \
    "sudoers perms 440" 2

# 7. ç½‘ç»œå®‰å…¨æ£€æŸ¥
check_item "IPè½¬å‘å·²ç¦ç”¨" \
    'sysctl net.ipv4.ip_forward | grep -q "= 0"' \
    "ip_forward = 0" 2

check_item "TCP SYN Cookieså·²å¯ç”¨" \
    'sysctl net.ipv4.tcp_syncookies | grep -q "= 1"' \
    "syncookies = 1" 1

# 8. æœåŠ¡å®‰å…¨æ£€æŸ¥
check_item "ä¸å¿…è¦æœåŠ¡å·²ç¦ç”¨" \
    '! (systemctl is-enabled bluetooth 2>/dev/null && systemctl is-enabled cups 2>/dev/null)' \
    "unnecessary services disabled" 1

# 9. æ—¥å¿—é…ç½®æ£€æŸ¥
check_item "rsyslogæœåŠ¡è¿è¡Œ" \
    'systemctl is-active --quiet rsyslog' \
    "rsyslog active" 1

# 10. AIDEå®Œæ•´æ€§æ£€æŸ¥å·¥å…·
check_item "AIDEå·²å®‰è£…é…ç½®" \
    'command -v aide >/dev/null && [ -f /var/lib/aide/aide.db ]' \
    "aide configured" 2

# è®¡ç®—æœ€ç»ˆå¾—åˆ†
PERCENTAGE=$((SCORE * 100 / TOTAL_CHECKS))

echo -e "\n${BLUE}==================== æ£€æŸ¥ç»“æžœæ±‡æ€» ====================${NC}"
echo -e "æ€»æ£€æŸ¥é¡¹: $TOTAL_CHECKS"
echo -e "é€šè¿‡é¡¹: $SCORE"

if [ $PERCENTAGE -ge 90 ]; then
    echo -e "åˆè§„å¾—åˆ†: ${GREEN}$PERCENTAGE%${NC} - ä¼˜ç§€"
    LEVEL="ä¼˜ç§€"
elif [ $PERCENTAGE -ge 80 ]; then
    echo -e "åˆè§„å¾—åˆ†: ${GREEN}$PERCENTAGE%${NC} - è‰¯å¥½"
    LEVEL="è‰¯å¥½"
elif [ $PERCENTAGE -ge 70 ]; then
    echo -e "åˆè§„å¾—åˆ†: ${YELLOW}$PERCENTAGE%${NC} - ä¸€èˆ¬"
    LEVEL="ä¸€èˆ¬"
else
    echo -e "åˆè§„å¾—åˆ†: ${RED}$PERCENTAGE%${NC} - éœ€è¦æ”¹è¿›"
    LEVEL="éœ€è¦æ”¹è¿›"
fi

# è®°å½•æœ€ç»ˆç»“æžœ
echo "[$(date '+%Y-%m-%d %H:%M:%S')] åˆè§„æ£€æŸ¥å®Œæˆ - å¾—åˆ†: $PERCENTAGE% ($LEVEL)" >> $COMPLIANCE_LOG

echo -e "\nè¯¦ç»†æ—¥å¿—å·²ä¿å­˜åˆ°: $COMPLIANCE_LOG"
EOF

chmod +x /usr/local/bin/security-compliance-check.sh
```

## 9. å®šæœŸç»´æŠ¤å’Œæ›´æ–°å»ºè®® ðŸ“…

### 9.1 å®šæœŸä»»åŠ¡æ¸…å•

| é¢‘çŽ‡ | ä»»åŠ¡ | å‘½ä»¤/è„šæœ¬ |
|------|------|----------|
| æ¯æ—¥ | å®‰å…¨ç›‘æŽ§æ£€æŸ¥ | `/usr/local/bin/system-security-monitor.sh` |
| æ¯å‘¨ | ç³»ç»Ÿæ—¥å¿—å®¡æŸ¥ | `grep -i "error\|fail\|warn" /var/log/messages` |
| æ¯æœˆ | å®‰å…¨åˆè§„æ£€æŸ¥ | `/usr/local/bin/security-compliance-check.sh` |
| æ¯æœˆ | AIDEå®Œæ•´æ€§æ£€æŸ¥ | `aide --check` |
| æ¯å­£åº¦ | å…¨é¢å®‰å…¨è¯„ä¼° | äººå·¥å®¡æŸ¥ + æ¸—é€æµ‹è¯• |

### 9.2 å®‰å…¨æŒ‡æ ‡ç›‘æŽ§

```bash
# åˆ›å»ºå®‰å…¨æŒ‡æ ‡æ”¶é›†è„šæœ¬
cat > /usr/local/bin/security-metrics.sh << 'EOF'
#!/bin/bash

METRICS_FILE="/var/log/security-metrics.csv"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# å¦‚æžœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºCSVå¤´éƒ¨
if [ ! -f "$METRICS_FILE" ]; then
    echo "timestamp,failed_logins,active_sessions,open_ports,cpu_usage,memory_usage,disk_usage" > $METRICS_FILE
fi

# æ”¶é›†æŒ‡æ ‡
FAILED_LOGINS=$(grep "Failed password" /var/log/secure /var/log/auth.log 2>/dev/null | grep "$(date '+%b %d')" | wc -l)
ACTIVE_SESSIONS=$(who | wc -l)
OPEN_PORTS=$(ss -tuln | grep LISTEN | wc -l)
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.1f", $3/$2 * 100.0)}')
DISK_USAGE=$(df / | awk 'NR==2 {print $(NF-1)}' | sed 's/%//')

# å†™å…¥CSV
echo "$DATE,$FAILED_LOGINS,$ACTIVE_SESSIONS,$OPEN_PORTS,$CPU_USAGE,$MEMORY_USAGE,$DISK_USAGE" >> $METRICS_FILE
EOF

chmod +x /usr/local/bin/security-metrics.sh

# æ·»åŠ åˆ°cronï¼ˆæ¯å°æ—¶æ”¶é›†ä¸€æ¬¡ï¼‰
(crontab -l 2>/dev/null; echo "0 * * * * /usr/local/bin/security-metrics.sh") | crontab -
```