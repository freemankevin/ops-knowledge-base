---
title: 系统安全加固
description: 企业级系统安全加固完整指南，涵盖系统更新、用户管理、文件系统安全、网络配置、监控审计等核心安全措施
keywords:
  - 系统安全加固
  - 安全防护
  - 运维安全
  - 系统环境
  - 安全基线
tags:
  - 系统安全加固
  - 安全防护
  - 运维
  - 知识库
  - 系统环境
---

# 系统基础安全加固

## 📋 加固检查清单

在开始之前，请确认您的加固目标和当前系统状态：

- [ ] 确认系统版本和架构
- [ ] 备份关键配置文件
- [ ] 准备应急恢复方案
- [ ] 通知相关人员维护窗口

## 1. 系统更新和补丁管理 🔄

### 1.1 保持系统更新

=== "CentOS/RHEL 8+"

    ```bash
    # 查看系统版本
    cat /etc/redhat-release
    
    # 查看可更新的软件包
    dnf list updates
    
    # 更新所有软件包
    dnf update -y
    
    # 只更新安全补丁
    dnf --security update
    
    # 查看更新历史
    dnf history list
    ```

=== "CentOS/RHEL 7"

    ```bash
    # 查看可更新的软件包
    yum list updates
    
    # 更新所有软件包
    yum update -y
    
    # 只更新安全补丁
    yum --security update
    
    # 安装yum-security插件（如果需要）
    yum install yum-plugin-security -y
    ```

=== "Ubuntu/Debian"

    ```bash
    # 更新软件包列表
    apt update
    
    # 查看可升级的包
    apt list --upgradable
    
    # 升级所有软件包
    apt upgrade -y
    
    # 完整升级（包括内核）
    apt full-upgrade -y
    
    # 清理不需要的包
    apt autoremove -y
    apt autoclean
    ```

### 1.2 配置自动更新

=== "CentOS/RHEL 8+"

    ```bash
    # 安装并配置dnf-automatic
    dnf install dnf-automatic -y
    
    # 编辑配置文件
    vim /etc/dnf/automatic.conf
    # 关键配置：
    # apply_updates = yes
    # upgrade_type = security
    # email_to = admin@yourdomain.com
    # email_from = system@yourdomain.com
    
    # 启用服务
    systemctl enable --now dnf-automatic.timer
    systemctl status dnf-automatic.timer
    ```

=== "CentOS/RHEL 7"

    ```bash
    yum install yum-cron -y
    systemctl enable yum-cron
    systemctl start yum-cron
    
    # 编辑配置文件
    vim /etc/yum/yum-cron.conf
    # 设置以下参数：
    # apply_updates = yes
    # update_cmd = security
    # email_to = admin@yourdomain.com
    # email_from = root@localhost
    ```

=== "Ubuntu/Debian"

    ```bash
    apt install unattended-upgrades apt-listchanges -y
    dpkg-reconfigure -plow unattended-upgrades
    
    # 详细配置
    cat > /etc/apt/apt.conf.d/50unattended-upgrades << EOF
    Unattended-Upgrade::Allowed-Origins {
        "\${distro_id}:\${distro_codename}-security";
        "\${distro_id}ESMApps:\${distro_codename}-apps-security";
        "\${distro_id}ESM:\${distro_codename}-infra-security";
    };
    
    // 自动重启配置
    Unattended-Upgrade::Automatic-Reboot "false";
    Unattended-Upgrade::Automatic-Reboot-WithUsers "false";
    Unattended-Upgrade::Automatic-Reboot-Time "02:00";
    
    // 邮件通知
    Unattended-Upgrade::Mail "admin@yourdomain.com";
    Unattended-Upgrade::MailReport "on-change";
    
    // 日志和清理
    Unattended-Upgrade::AutoFixInterruptedDpkg "true";
    Unattended-Upgrade::MinimalSteps "true";
    Unattended-Upgrade::Remove-Unused-Dependencies "true";
    Unattended-Upgrade::Remove-New-Unused-Dependencies "true";
    EOF
    
    # 配置定时任务频率
    vim /etc/apt/apt.conf.d/20auto-upgrades
    # APT::Periodic::Update-Package-Lists "1";
    # APT::Periodic::Unattended-Upgrade "1";
    ```

### 1.3 内核安全配置

```bash
# 查看当前内核版本
uname -r

# 配置内核安全参数
cat >> /etc/sysctl.d/99-security.conf << EOF
# 核心转储限制
fs.suid_dumpable = 0
kernel.core_uses_pid = 1

# 内存保护
kernel.exec-shield = 1
kernel.randomize_va_space = 2

# 进程限制
kernel.pid_max = 65536

# dmesg限制
kernel.dmesg_restrict = 1
kernel.kptr_restrict = 2

# 性能事件限制
kernel.perf_event_paranoid = 3

# 用户命名空间限制 (如果不使用容器)
# user.max_user_namespaces = 0
EOF

# 应用配置
sysctl -p /etc/sysctl.d/99-security.conf
```

## 2. 用户和权限管理 👥

### 2.1 禁用不必要的用户账户

```bash
# 查看系统所有用户
getent passwd

# 查看可登录的用户
getent passwd | grep -E "/bin/bash|/bin/sh|/bin/zsh"

# 查看最近登录用户
lastlog | grep -v "Never"

# 禁用系统服务账户的shell
for user in games ftp news uucp operator gopher; do
    if id "$user" >/dev/null 2>&1; then
        usermod -s /sbin/nologin "$user"
        echo "已禁用用户: $user"
    fi
done

# 锁定长期未使用的账户
lastlog -b 90 | awk 'NR>1 && $1 != "root" {print $1}' | while read user; do
    if id "$user" >/dev/null 2>&1; then
        usermod -L "$user"
        echo "已锁定长期未使用的账户: $user"
    fi
done
```

### 2.2 强化密码策略

```bash
# 安装密码质量检查工具
if command -v yum >/dev/null 2>&1; then
    yum install libpwquality cracklib-dicts -y
elif command -v apt >/dev/null 2>&1; then
    apt install libpam-pwquality cracklib-runtime -y
fi

# 配置密码复杂度
cat > /etc/security/pwquality.conf << EOF
# 密码最小长度
minlen = 14

# 至少包含的字符类型数量
minclass = 4

# 最大重复字符数
maxrepeat = 2

# 最大连续字符数
maxsequence = 3

# 数字字符要求（负数表示至少包含）
dcredit = -1

# 大写字母要求
ucredit = -1

# 小写字母要求
lcredit = -1

# 特殊字符要求
ocredit = -1

# 禁止包含用户名
usercheck = 1

# 禁止使用字典词汇
dictcheck = 1

# 与旧密码的最小差异
difok = 5
EOF

# 配置登录参数
vim /etc/login.defs
# 确保以下参数设置正确：
sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   90/' /etc/login.defs
sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   7/' /etc/login.defs
sed -i 's/^PASS_MIN_LEN.*/PASS_MIN_LEN    14/' /etc/login.defs
sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   14/' /etc/login.defs

# 配置账户锁定策略
if [ -f /etc/pam.d/system-auth ]; then
    # RHEL/CentOS
    PAM_FILE="/etc/pam.d/system-auth"
else
    # Ubuntu/Debian
    PAM_FILE="/etc/pam.d/common-auth"
fi

# 备份原文件
cp $PAM_FILE ${PAM_FILE}.backup

# 添加账户锁定配置（5次失败后锁定10分钟）
echo "auth required pam_faillock.so preauth deny=5 unlock_time=600" >> $PAM_FILE
echo "auth sufficient pam_faillock.so authfail deny=5 unlock_time=600" >> $PAM_FILE
```

### 2.3 配置sudo权限和审计

```bash
# 备份sudoers文件
cp /etc/sudoers /etc/sudoers.backup.$(date +%Y%m%d)

# 配置sudo安全选项
cat >> /etc/sudoers << 'EOF'
# 日志配置
Defaults logfile=/var/log/sudo.log
Defaults log_year, log_host, log_input, log_output
Defaults iolog_dir=/var/log/sudo-io
Defaults log_input, log_output

# 安全选项
Defaults requiretty
Defaults env_reset
Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
Defaults timestamp_timeout=15
Defaults passwd_timeout=5
Defaults passwd_tries=3

# 禁止危险命令
Defaults passwd_tries=3
Cmnd_Alias DANGEROUS = /bin/su, /usr/bin/passwd root, /bin/chmod 777 *, /bin/chown root *
ALL ALL = !DANGEROUS
EOF

# 创建sudo日志轮转配置
cat > /etc/logrotate.d/sudo << EOF
/var/log/sudo.log {
    weekly
    rotate 52
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root root
}

/var/log/sudo-io/*/*.log {
    weekly
    rotate 52
    compress
    delaycompress
    missingok
    notifempty
}
EOF
```

### 2.4 配置用户会话限制

```bash
# 配置用户资源限制
cat >> /etc/security/limits.conf << EOF
# 进程数限制
* soft nproc 4096
* hard nproc 8192

# 文件句柄限制
* soft nofile 65536
* hard nofile 65536

# 内存使用限制（以KB为单位）
* soft as 4194304
* hard as 8388608

# CPU时间限制（分钟）
* soft cpu 30
* hard cpu 60

# 防止fork炸弹
* hard maxlogins 3
EOF

# 配置会话超时
echo "TMOUT=900" >> /etc/profile
echo "readonly TMOUT" >> /etc/profile
echo "export TMOUT" >> /etc/profile

# 配置登录失败延迟
echo "FAIL_DELAY 3" >> /etc/login.defs
```

## 3. 文件系统安全 📁

### 3.1 设置关键文件权限

```bash
#!/bin/bash
# 系统文件权限加固脚本

echo "开始文件权限加固..."

# 关键系统文件权限设置
declare -A file_permissions=(
    ["/etc/passwd"]="644"
    ["/etc/group"]="644"
    ["/etc/shadow"]="000"
    ["/etc/gshadow"]="000"
    ["/etc/ssh/sshd_config"]="600"
    ["/etc/crontab"]="600"
    ["/etc/sudoers"]="440"
    ["/boot/grub2/grub.cfg"]="600"
    ["/boot/grub/grub.cfg"]="600"
)

for file in "${!file_permissions[@]}"; do
    if [ -f "$file" ]; then
        chmod "${file_permissions[$file]}" "$file"
        echo "已设置 $file 权限为 ${file_permissions[$file]}"
    fi
done

# 查找并修复权限过于宽松的文件
echo "查找权限过于宽松的文件..."
find /etc -type f -perm -002 -exec chmod o-w {} \; 2>/dev/null
find /etc -type f -perm -020 -exec chmod g-w {} \; 2>/dev/null

# 查找SUID和SGID文件
echo "扫描SUID/SGID文件..."
find / -type f \( -perm -4000 -o -perm -2000 \) -exec ls -la {} \; 2>/dev/null > /tmp/suid_sgid_files.txt

# 移除不必要的SUID位
unnecessary_suid_files="/usr/bin/chage /usr/bin/gpasswd /usr/bin/wall /usr/bin/chfn /usr/bin/chsh /usr/bin/newgrp /usr/bin/write"
for file in $unnecessary_suid_files; do
    if [ -f "$file" ]; then
        chmod u-s "$file"
        echo "已移除 $file 的SUID位"
    fi
done
```

### 3.2 磁盘挂载安全选项

```bash
# 检查当前挂载选项
mount | column -t

# 创建安全的fstab备份
cp /etc/fstab /etc/fstab.backup.$(date +%Y%m%d)

# 为临时目录添加安全挂载选项
cat >> /etc/fstab << EOF
# 安全挂载选项
tmpfs /tmp tmpfs defaults,rw,nosuid,nodev,noexec,relatime,size=2G 0 0
tmpfs /var/tmp tmpfs defaults,rw,nosuid,nodev,noexec,relatime,size=1G 0 0
tmpfs /dev/shm tmpfs defaults,rw,nosuid,nodev,noexec,relatime,size=1G 0 0
EOF

# 立即应用挂载
mount -o remount,nodev,nosuid,noexec /tmp
mount -o remount,nodev,nosuid,noexec /var/tmp
mount -o remount,nodev,nosuid,noexec /dev/shm
```

### 3.3 文件完整性监控

```bash
# 安装AIDE
if command -v yum >/dev/null 2>&1; then
    yum install aide -y
elif command -v apt >/dev/null 2>&1; then
    apt install aide aide-common -y
fi

# 配置AIDE
cat > /etc/aide.conf << EOF
# AIDE配置文件
database=file:/var/lib/aide/aide.db
database_out=file:/var/lib/aide/aide.db.new
gzip_dbout=yes

# 定义检查规则
Binlib = p+i+n+u+g+s+b+m+c+md5+sha1
ConfFiles = p+i+n+u+g+s+b+m+c+md5+sha1
Logs = p+i+n+u+g+S
Devices = p+i+n+u+g+s+b+c+md5+sha1

# 监控目录
/boot Binlib
/bin Binlib
/sbin Binlib
/usr/bin Binlib
/usr/sbin Binlib
/usr/libexec Binlib
/usr/local/bin Binlib
/usr/local/sbin Binlib

# 配置文件
/etc ConfFiles
!/etc/mtab

# 日志文件
/var/log Logs
!/var/log/.*
EOF

# 初始化AIDE数据库
aide --init
mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db

# 创建每日检查脚本
cat > /etc/cron.daily/aide-check << 'EOF'
#!/bin/bash
LOGFILE="/var/log/aide-check.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$DATE] 开始AIDE文件完整性检查" >> $LOGFILE

if /usr/bin/aide --check >> $LOGFILE 2>&1; then
    echo "[$DATE] AIDE检查完成，未发现变化" >> $LOGFILE
else
    echo "[$DATE] AIDE检查发现文件变化，请查看详细日志" >> $LOGFILE
    # 发送邮件通知（如果配置了邮件系统）
    if command -v mail >/dev/null 2>&1; then
        tail -50 $LOGFILE | mail -s "AIDE Alert - $(hostname)" admin@yourdomain.com
    fi
fi

echo "[$DATE] AIDE检查结束" >> $LOGFILE
echo "----------------------------------------" >> $LOGFILE
EOF

chmod +x /etc/cron.daily/aide-check
```

## 4. 服务和进程安全 ⚙️

### 4.1 服务管理和最小化

```bash
#!/bin/bash
# 服务安全配置脚本

echo "当前运行的服务："
systemctl list-units --type=service --state=running

# 定义通常可以禁用的服务
unnecessary_services=(
    "bluetooth"
    "cups"
    "avahi-daemon"
    "postfix"
    "sendmail"
    "rpcbind"
    "nfs"
    "smb"
    "nmb"
    "telnet"
    "rsh"
    "rlogin"
)

echo "正在禁用不必要的服务..."
for service in "${unnecessary_services[@]}"; do
    if systemctl is-enabled "$service" >/dev/null 2>&1; then
        systemctl disable "$service"
        systemctl stop "$service"
        echo "已禁用服务: $service"
    fi
done

# 检查监听端口
echo "当前监听的端口："
ss -tulnp | grep LISTEN
```

### 4.2 进程资源限制

```bash
# 配置systemd服务资源限制
mkdir -p /etc/systemd/system.conf.d
cat > /etc/systemd/system.conf.d/security.conf << EOF
[Manager]
# 默认服务限制
DefaultLimitNOFILE=65536
DefaultLimitNPROC=4096
DefaultLimitCORE=0
DefaultLimitAS=4294967296

# 超时设置
DefaultTimeoutStopSec=30s
DefaultTimeoutStartSec=30s
EOF

systemctl daemon-reload
```

## 5. 网络安全基础配置 🌐

### 5.1 网络参数安全优化

```bash
# 创建网络安全配置
cat > /etc/sysctl.d/10-network-security.conf << EOF
# TCP/IP安全配置
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_max_syn_backlog = 4096

# IP转发控制
net.ipv4.ip_forward = 0
net.ipv6.conf.all.forwarding = 0

# 源路由保护
net.ipv4.conf.all.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# ICMP重定向保护
net.ipv4.conf.all.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# IP欺骗保护
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# 记录可疑包
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# ICMP控制
net.ipv4.icmp_echo_ignore_all = 0
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1

# IPv6安全（如果不使用IPv6可以禁用）
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0
EOF

# 应用配置
sysctl -p /etc/sysctl.d/10-network-security.conf
```

## 6. 系统监控和审计 📊

### 6.1 审计系统配置

```bash
# 安装并配置auditd
if command -v yum >/dev/null 2>&1; then
    yum install audit audit-libs -y
elif command -v apt >/dev/null 2>&1; then
    apt install auditd audispd-plugins -y
fi

# 启用审计服务
systemctl enable auditd
systemctl start auditd

# 配置详细的审计规则
cat > /etc/audit/rules.d/security.rules << EOF
# 删除所有现有规则
-D

# 设置缓冲区大小
-b 8192

# 失败处理
-f 1

# 监控身份相关文件
-w /etc/passwd -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity

# 监控权限相关文件
-w /etc/sudoers -p wa -k scope
-w /etc/sudoers.d/ -p wa -k scope

# 监控登录相关
-w /var/log/lastlog -p wa -k logins
-w /var/log/faillog -p wa -k logins
-w /var/log/wtmp -p wa -k logins
-w /var/log/btmp -p wa -k logins

# 监控网络配置
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k network
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k network
-w /etc/hosts -p wa -k network
-w /etc/network/ -p wa -k network

# 监控时间更改
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
-a always,exit -F arch=b32 -S adjtimex -S settimeofday -k time-change
-w /etc/localtime -p wa -k time-change

# 监控MAC策略
-w /etc/selinux/ -p wa -k MAC-policy

# 监控文件权限修改
-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -k perm_mod
-a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -k perm_mod
-a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -k perm_mod
-a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -k perm_mod

# 监控文件访问
-a always,exit -F arch=b64 -S creat -S open -S openat -S open_by_handle_at -S truncate -S ftruncate -k file_access
-a always,exit -F arch=b32 -S creat -S open -S openat -S open_by_handle_at -S truncate -S ftruncate -k file_access

# 监控挂载操作
-a always,exit -F arch=b64 -S mount -k mounts
-a always,exit -F arch=b32 -S mount -k mounts

# 监控文件删除
-a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -k delete
-a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -k delete

# 监控内核模块
-w /sbin/insmod -p x -k modules
-w /sbin/rmmod -p x -k modules
-w /sbin/modprobe -p x -k modules
-a always,exit -F arch=b64 -S init_module -S delete_module -k modules

# 锁定规则配置
-e 2
EOF

# 重新加载审计规则
augenrules --load
systemctl restart auditd
```

### 6.2 系统监控脚本

```bash
# 创建综合监控脚本
cat > /usr/local/bin/system-security-monitor.sh << 'EOF'
#!/bin/bash

# 配置
LOG_FILE="/var/log/security-monitor.log"
ALERT_EMAIL="admin@yourdomain.com"
CPU_THRESHOLD=80
MEMORY_THRESHOLD=80
DISK_THRESHOLD=90

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 日志函数
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# 检查CPU使用率
check_cpu() {
    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
    CPU_USAGE=${CPU_USAGE%.*}
    
    if [ $CPU_USAGE -gt $CPU_THRESHOLD ]; then
        log_message "${RED}⚠️  CPU使用率过高: ${CPU_USAGE}%${NC}"
        return 1
    else
        log_message "${GREEN}✅ CPU使用率正常: ${CPU_USAGE}%${NC}"
        return 0
    fi
}

# 检查可疑进程
check_suspicious_processes() {
    log_message "🔍 检查可疑进程..."
    
    # 检查高CPU使用率进程
    HIGH_CPU_PROCS=$(ps aux --sort=-%cpu | head -6 | tail -5)
    log_message "CPU使用率最高的进程:"
    echo "$HIGH_CPU_PROCS" >> $LOG_FILE
    
    # 检查可疑网络连接
    SUSPICIOUS_CONNECTIONS=$(netstat -tuln | grep -E ':22[0-9][0-9]|:3[0-9][0-9][0-9][0-9]|:4[4-9][0-9][0-9][0-9]')
    if [ ! -z "$SUSPICIOUS_CONNECTIONS" ]; then
        log_message "${YELLOW}⚠️  发现可疑端口监听:${NC}"
        echo "$SUSPICIOUS_CONNECTIONS" >> $LOG_FILE
    fi
}

# 检查系统完整性
check_system_integrity() {
    log_message "🔐 检查系统完整性..."
    
    # 检查关键文件权限
    CRITICAL_FILES=("/etc/passwd" "/etc/shadow" "/etc/sudoers" "/etc/ssh/sshd_config")
    for file in "${CRITICAL_FILES[@]}"; do
        if [ -f "$file" ]; then
            PERMS=$(stat -c "%a" "$file")
            case "$file" in
                "/etc/shadow")
                    if [ "$PERMS" != "000" ] && [ "$PERMS" != "640" ]; then
                        log_message "${RED}⚠️  $file 权限异常: $PERMS${NC}"
                    fi
                    ;;
                "/etc/sudoers")
                    if [ "$PERMS" != "440" ]; then
                        log_message "${RED}⚠️  $file 权限异常: $PERMS${NC}"
                    fi
                    ;;
                *)
                    if [ "$PERMS" != "644" ]; then
                        log_message "${YELLOW}⚠️  $file 权限可能异常: $PERMS${NC}"
                    fi
                    ;;
            esac
        fi
    done
}

# 主检查函数
main() {
    log_message "==================== 开始安全监控 ===================="
    
    ALERTS=0
    
    # 执行各项检查
    check_cpu || ((ALERTS++))
    check_memory || ((ALERTS++))
    check_disk || ((ALERTS++))
    check_login_failures || ((ALERTS++))
    check_suspicious_processes
    check_system_integrity
    
    # 汇总结果
    if [ $ALERTS -gt 0 ]; then
        log_message "${RED}🚨 发现 $ALERTS 个安全告警${NC}"
        
        # 发送邮件告警（如果配置了邮件系统）
        if command -v mail >/dev/null 2>&1 && [ ! -z "$ALERT_EMAIL" ]; then
            tail -50 $LOG_FILE | mail -s "Security Alert - $(hostname)" $ALERT_EMAIL
        fi
    else
        log_message "${GREEN}✅ 系统安全状态良好${NC}"
    fi
    
    log_message "==================== 监控完成 ===================="
    echo "" >> $LOG_FILE
}

# 执行主函数
main
EOF

chmod +x /usr/local/bin/system-security-monitor.sh

# 添加到cron任务（每小时执行一次）
(crontab -l 2>/dev/null; echo "0 * * * * /usr/local/bin/system-security-monitor.sh") | crontab -
```

### 6.3 安全事件响应脚本

```bash
# 创建安全事件响应脚本
cat > /usr/local/bin/security-incident-response.sh << 'EOF'
#!/bin/bash

# 安全事件响应脚本
INCIDENT_LOG="/var/log/security-incidents.log"
BACKUP_DIR="/var/backups/security-$(date +%Y%m%d_%H%M%S)"

# 创建事件响应功能
incident_response() {
    local incident_type="$1"
    local description="$2"
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] INCIDENT: $incident_type - $description" | tee -a $INCIDENT_LOG
    
    # 创建备份目录
    mkdir -p $BACKUP_DIR
    
    case "$incident_type" in
        "BRUTE_FORCE")
            # 应对暴力破解
            echo "检测到暴力破解攻击，执行防护措施..."
            
            # 导出当前连接信息
            netstat -tuln > $BACKUP_DIR/netstat.log
            ss -tuln > $BACKUP_DIR/ss.log
            
            # 导出最近的登录尝试
            tail -1000 /var/log/secure > $BACKUP_DIR/recent_auth.log 2>/dev/null || true
            tail -1000 /var/log/auth.log > $BACKUP_DIR/recent_auth.log 2>/dev/null || true
            
            # 分析攻击来源IP
            grep "Failed password" /var/log/secure /var/log/auth.log 2>/dev/null | \
                awk '{print $(NF-3)}' | sort | uniq -c | sort -nr > $BACKUP_DIR/attack_ips.log
            ;;
            
        "MALWARE")
            # 应对恶意软件
            echo "检测到可疑进程，执行隔离措施..."
            
            # 导出进程信息
            ps auxf > $BACKUP_DIR/processes.log
            lsof > $BACKUP_DIR/open_files.log 2>/dev/null
            
            # 导出网络连接
            netstat -anp > $BACKUP_DIR/network_connections.log
            ;;
            
        "FILE_INTEGRITY")
            # 应对文件完整性问题
            echo "检测到文件完整性异常..."
            
            # 运行AIDE检查
            aide --check > $BACKUP_DIR/aide_check.log 2>&1 || true
            
            # 备份关键配置文件
            tar -czf $BACKUP_DIR/critical_configs.tar.gz /etc/passwd /etc/shadow /etc/group /etc/sudoers /etc/ssh/ 2>/dev/null
            ;;
    esac
    
    echo "事件响应完成，备份文件保存在: $BACKUP_DIR"
}

# 快速系统隔离函数
emergency_isolation() {
    echo "⚠️  执行紧急隔离程序..."
    
    # 断开网络连接（仅保留本地回环）
    iptables -P INPUT DROP
    iptables -P FORWARD DROP
    iptables -P OUTPUT DROP
    iptables -A INPUT -i lo -j ACCEPT
    iptables -A OUTPUT -o lo -j ACCEPT
    
    # 记录隔离操作
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] EMERGENCY: System isolated" | tee -a $INCIDENT_LOG
    
    echo "✅ 系统已隔离，仅允许本地连接"
    echo "恢复网络连接命令: iptables -F && iptables -P INPUT ACCEPT && iptables -P FORWARD ACCEPT && iptables -P OUTPUT ACCEPT"
}

# 根据参数执行相应操作
case "$1" in
    "brute_force")
        incident_response "BRUTE_FORCE" "Detected brute force attack"
        ;;
    "malware")
        incident_response "MALWARE" "Detected suspicious process"
        ;;
    "file_integrity")
        incident_response "FILE_INTEGRITY" "File integrity violation detected"
        ;;
    "isolate")
        emergency_isolation
        ;;
    *)
        echo "用法: $0 {brute_force|malware|file_integrity|isolate}"
        echo "示例: $0 brute_force"
        exit 1
        ;;
esac
EOF

chmod +x /usr/local/bin/security-incident-response.sh
```

## 7. 自动化安全加固脚本 🤖

### 7.1 一键加固脚本

```bash
# 创建一键加固脚本
cat > /usr/local/bin/auto-hardening.sh << 'EOF'
#!/bin/bash

# 系统自动化安全加固脚本
# 版本: 2.0
# 适用: CentOS/RHEL 7-8, Ubuntu 18.04-22.04

set -euo pipefail

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# 日志文件
LOG_FILE="/var/log/system-hardening.log"
BACKUP_DIR="/var/backups/pre-hardening-$(date +%Y%m%d_%H%M%S)"

# 日志函数
log() {
    echo -e "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# 错误处理
error_exit() {
    log "${RED}错误: $1${NC}"
    exit 1
}

# 检查是否为root用户
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error_exit "此脚本需要root权限运行"
    fi
}

# 系统检测
detect_system() {
    if [ -f /etc/redhat-release ]; then
        OS="redhat"
        if grep -q "release 7" /etc/redhat-release; then
            VERSION="7"
        elif grep -q "release 8" /etc/redhat-release; then
            VERSION="8"
        fi
    elif [ -f /etc/lsb-release ]; then
        OS="ubuntu"
        VERSION=$(lsb_release -rs)
    elif [ -f /etc/debian_version ]; then
        OS="debian"
        VERSION=$(cat /etc/debian_version)
    else
        error_exit "不支持的操作系统"
    fi
    
    log "${GREEN}检测到系统: $OS $VERSION${NC}"
}

# 创建备份
create_backup() {
    log "${BLUE}创建系统配置备份...${NC}"
    mkdir -p $BACKUP_DIR
    
    # 备份关键配置文件
    cp /etc/passwd $BACKUP_DIR/ 2>/dev/null || true
    cp /etc/shadow $BACKUP_DIR/ 2>/dev/null || true
    cp /etc/group $BACKUP_DIR/ 2>/dev/null || true
    cp /etc/sudoers $BACKUP_DIR/ 2>/dev/null || true
    cp -r /etc/ssh/ $BACKUP_DIR/ssh_backup/ 2>/dev/null || true
    cp /etc/login.defs $BACKUP_DIR/ 2>/dev/null || true
    cp /etc/security/limits.conf $BACKUP_DIR/ 2>/dev/null || true
    
    log "${GREEN}备份完成: $BACKUP_DIR${NC}"
}

# 更新系统
update_system() {
    log "${BLUE}更新系统软件包...${NC}"
    
    if [[ "$OS" == "redhat" ]]; then
        if [[ "$VERSION" == "8" ]]; then
            dnf update -y
        else
            yum update -y
        fi
    elif [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
        apt update && apt upgrade -y
    fi
    
    log "${GREEN}系统更新完成${NC}"
}

# 配置密码策略
configure_password_policy() {
    log "${BLUE}配置密码策略...${NC}"
    
    # 安装密码质量检查工具
    if [[ "$OS" == "redhat" ]]; then
        if [[ "$VERSION" == "8" ]]; then
            dnf install -y libpwquality
        else
            yum install -y libpwquality cracklib-dicts
        fi
    elif [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
        apt install -y libpam-pwquality cracklib-runtime
    fi
    
    # 配置密码复杂度
    cat > /etc/security/pwquality.conf << 'EOL'
minlen = 14
minclass = 4
maxrepeat = 2
maxsequence = 3
dcredit = -1
ucredit = -1
lcredit = -1
ocredit = -1
usercheck = 1
dictcheck = 1
difok = 5
EOL
    
    # 修改登录配置
    sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   90/' /etc/login.defs
    sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   7/' /etc/login.defs
    sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   14/' /etc/login.defs
    
    log "${GREEN}密码策略配置完成${NC}"
}

# 配置SSH安全
configure_ssh() {
    log "${BLUE}配置SSH安全设置...${NC}"
    
    # 备份SSH配置
    cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d)
    
    # 应用SSH安全配置
    cat > /etc/ssh/sshd_config << 'EOL'
# SSH安全配置
Port 22
Protocol 2

# 认证设置
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes

# 连接设置
X11Forwarding no
PrintMotd no
PrintLastLog yes
TCPKeepAlive yes
Compression delayed
ClientAliveInterval 300
ClientAliveCountMax 2
MaxAuthTries 3
MaxSessions 2

# 限制用户和组
AllowUsers *
#AllowGroups ssh-users

# 其他安全设置
PermitUserEnvironment no
PermitTunnel no
Banner /etc/issue.net
EOL

    # 重启SSH服务
    systemctl reload sshd
    
    log "${GREEN}SSH安全配置完成${NC}"
}

# 配置防火墙基础规则
configure_basic_firewall() {
    log "${BLUE}配置基础防火墙规则...${NC}"
    
    if [[ "$OS" == "redhat" ]]; then
        systemctl enable firewalld
        systemctl start firewalld
        
        # 基础规则
        firewall-cmd --permanent --remove-service=ssh
        firewall-cmd --permanent --add-port=22/tcp
        firewall-cmd --permanent --add-service=http
        firewall-cmd --permanent --add-service=https
        firewall-cmd --reload
        
    elif [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
        apt install -y ufw
        
        # 重置规则
        ufw --force reset
        
        # 默认策略
        ufw default deny incoming
        ufw default allow outgoing
        
        # 基础规则
        ufw allow 22/tcp
        ufw allow 80/tcp
        ufw allow 443/tcp
        
        # 启用防火墙
        ufw --force enable
    fi
    
    log "${GREEN}基础防火墙配置完成${NC}"
}

# 安装安全工具
install_security_tools() {
    log "${BLUE}安装安全监控工具...${NC}"
    
    if [[ "$OS" == "redhat" ]]; then
        if [[ "$VERSION" == "8" ]]; then
            dnf install -y aide audit rkhunter logwatch
        else
            yum install -y aide audit rkhunter logwatch epel-release
        fi
    elif [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
        apt install -y aide aide-common auditd rkhunter logwatch
    fi
    
    # 启用审计服务
    systemctl enable auditd
    systemctl start auditd
    
    log "${GREEN}安全工具安装完成${NC}"
}

# 应用网络安全参数
apply_network_security() {
    log "${BLUE}应用网络安全参数...${NC}"
    
    cat > /etc/sysctl.d/99-network-security.conf << 'EOL'
# 网络安全参数
net.ipv4.ip_forward = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.tcp_syncookies = 1
kernel.randomize_va_space = 2
EOL

    sysctl -p /etc/sysctl.d/99-network-security.conf
    
    log "${GREEN}网络安全参数应用完成${NC}"
}

# 主函数
main() {
    log "${GREEN}==================== 开始系统安全加固 ====================${NC}"
    
    check_root
    detect_system
    create_backup
    
    # 询问用户确认
    echo -e "${YELLOW}即将开始系统安全加固，是否继续? [y/N]${NC}"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        log "用户取消操作"
        exit 0
    fi
    
    # 执行加固步骤
    update_system
    configure_password_policy
    configure_ssh
    configure_basic_firewall
    install_security_tools
    apply_network_security
    
    log "${GREEN}==================== 系统加固完成 ====================${NC}"
    log "${YELLOW}重要提示:${NC}"
    log "1. SSH配置已修改，确保有SSH密钥访问权限"
    log "2. 防火墙已启用，请根据需要调整规则"
    log "3. 建议重启系统以确保所有设置生效"
    log "4. 备份文件位置: $BACKUP_DIR"
    
    echo -e "\n${GREEN}加固完成! 建议现在重启系统。${NC}"
}

# 执行主函数
main "$@"
EOF

chmod +x /usr/local/bin/auto-hardening.sh
```

## 8. 安全检查和验证 ✅

### 8.1 安全合规检查脚本

```bash
# 创建安全合规检查脚本
cat > /usr/local/bin/security-compliance-check.sh << 'EOF'
#!/bin/bash

# 安全合规检查脚本
COMPLIANCE_LOG="/var/log/compliance-check.log"
SCORE=0
TOTAL_CHECKS=0

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# 检查函数模板
check_item() {
    local check_name="$1"
    local check_command="$2"
    local expected_result="$3"
    local weight="${4:-1}"
    
    ((TOTAL_CHECKS += weight))
    
    echo -e "\n${BLUE}检查项目: $check_name${NC}"
    
    if eval "$check_command"; then
        echo -e "${GREEN}✅ 通过${NC}"
        ((SCORE += weight))
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] PASS: $check_name" >> $COMPLIANCE_LOG
        return 0
    else
        echo -e "${RED}❌ 失败${NC}"
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] FAIL: $check_name" >> $COMPLIANCE_LOG
        return 1
    fi
}

echo -e "${GREEN}==================== 安全合规性检查 ====================${NC}"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] 开始安全合规检查" > $COMPLIANCE_LOG

# 1. 系统更新检查
check_item "系统是否为最新版本" \
    '[ $(yum list updates 2>/dev/null | wc -l || apt list --upgradable 2>/dev/null | wc -l) -le 5 ]' \
    "updates <= 5" 2

# 2. SSH安全检查
check_item "SSH禁用root登录" \
    'grep -q "^PermitRootLogin no" /etc/ssh/sshd_config' \
    "PermitRootLogin no" 3

check_item "SSH禁用密码认证" \
    'grep -q "^PasswordAuthentication no" /etc/ssh/sshd_config' \
    "PasswordAuthentication no" 3

# 3. 防火墙状态检查
check_item "防火墙服务已启用" \
    'systemctl is-active --quiet firewalld || systemctl is-active --quiet ufw' \
    "firewall active" 2

# 4. 审计服务检查
check_item "审计服务已启用" \
    'systemctl is-active --quiet auditd' \
    "auditd active" 2

# 5. 密码策略检查
check_item "密码最小长度设置" \
    'grep -q "minlen.*=.*1[4-9]" /etc/security/pwquality.conf' \
    "minlen >= 14" 2

# 6. 文件权限检查
check_item "/etc/shadow权限检查" \
    '[ $(stat -c "%a" /etc/shadow) = "000" ] || [ $(stat -c "%a" /etc/shadow) = "640" ]' \
    "shadow perms correct" 3

check_item "/etc/sudoers权限检查" \
    '[ $(stat -c "%a" /etc/sudoers) = "440" ]' \
    "sudoers perms 440" 2

# 7. 网络安全检查
check_item "IP转发已禁用" \
    'sysctl net.ipv4.ip_forward | grep -q "= 0"' \
    "ip_forward = 0" 2

check_item "TCP SYN Cookies已启用" \
    'sysctl net.ipv4.tcp_syncookies | grep -q "= 1"' \
    "syncookies = 1" 1

# 8. 服务安全检查
check_item "不必要服务已禁用" \
    '! (systemctl is-enabled bluetooth 2>/dev/null && systemctl is-enabled cups 2>/dev/null)' \
    "unnecessary services disabled" 1

# 9. 日志配置检查
check_item "rsyslog服务运行" \
    'systemctl is-active --quiet rsyslog' \
    "rsyslog active" 1

# 10. AIDE完整性检查工具
check_item "AIDE已安装配置" \
    'command -v aide >/dev/null && [ -f /var/lib/aide/aide.db ]' \
    "aide configured" 2

# 计算最终得分
PERCENTAGE=$((SCORE * 100 / TOTAL_CHECKS))

echo -e "\n${BLUE}==================== 检查结果汇总 ====================${NC}"
echo -e "总检查项: $TOTAL_CHECKS"
echo -e "通过项: $SCORE"

if [ $PERCENTAGE -ge 90 ]; then
    echo -e "合规得分: ${GREEN}$PERCENTAGE%${NC} - 优秀"
    LEVEL="优秀"
elif [ $PERCENTAGE -ge 80 ]; then
    echo -e "合规得分: ${GREEN}$PERCENTAGE%${NC} - 良好"
    LEVEL="良好"
elif [ $PERCENTAGE -ge 70 ]; then
    echo -e "合规得分: ${YELLOW}$PERCENTAGE%${NC} - 一般"
    LEVEL="一般"
else
    echo -e "合规得分: ${RED}$PERCENTAGE%${NC} - 需要改进"
    LEVEL="需要改进"
fi

# 记录最终结果
echo "[$(date '+%Y-%m-%d %H:%M:%S')] 合规检查完成 - 得分: $PERCENTAGE% ($LEVEL)" >> $COMPLIANCE_LOG

echo -e "\n详细日志已保存到: $COMPLIANCE_LOG"
EOF

chmod +x /usr/local/bin/security-compliance-check.sh
```

## 9. 定期维护和更新建议 📅

### 9.1 定期任务清单

| 频率 | 任务 | 命令/脚本 |
|------|------|----------|
| 每日 | 安全监控检查 | `/usr/local/bin/system-security-monitor.sh` |
| 每周 | 系统日志审查 | `grep -i "error\|fail\|warn" /var/log/messages` |
| 每月 | 安全合规检查 | `/usr/local/bin/security-compliance-check.sh` |
| 每月 | AIDE完整性检查 | `aide --check` |
| 每季度 | 全面安全评估 | 人工审查 + 渗透测试 |

### 9.2 安全指标监控

```bash
# 创建安全指标收集脚本
cat > /usr/local/bin/security-metrics.sh << 'EOF'
#!/bin/bash

METRICS_FILE="/var/log/security-metrics.csv"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# 如果文件不存在，创建CSV头部
if [ ! -f "$METRICS_FILE" ]; then
    echo "timestamp,failed_logins,active_sessions,open_ports,cpu_usage,memory_usage,disk_usage" > $METRICS_FILE
fi

# 收集指标
FAILED_LOGINS=$(grep "Failed password" /var/log/secure /var/log/auth.log 2>/dev/null | grep "$(date '+%b %d')" | wc -l)
ACTIVE_SESSIONS=$(who | wc -l)
OPEN_PORTS=$(ss -tuln | grep LISTEN | wc -l)
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.1f", $3/$2 * 100.0)}')
DISK_USAGE=$(df / | awk 'NR==2 {print $(NF-1)}' | sed 's/%//')

# 写入CSV
echo "$DATE,$FAILED_LOGINS,$ACTIVE_SESSIONS,$OPEN_PORTS,$CPU_USAGE,$MEMORY_USAGE,$DISK_USAGE" >> $METRICS_FILE
EOF

chmod +x /usr/local/bin/security-metrics.sh

# 添加到cron（每小时收集一次）
(crontab -l 2>/dev/null; echo "0 * * * * /usr/local/bin/security-metrics.sh") | crontab -
```