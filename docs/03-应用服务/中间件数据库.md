---
title: 中间件数据库
description: 中间件数据库
keywords:
  - 中间件数据库
  - Linux
  - CentOS
  - Ubuntu
  - Debian
  - 运维
tags:
  - 中间件数据库
  - Linux
  - CentOS
  - Ubuntu
  - Debian
  - 运维
  - 知识库
  - 系统环境
---


# 中间件数据库部署

本文档将介绍如何使用 Docker Compose 部署常用的中间件数据库，包括服务注册发现、消息队列、数据库、搜索引擎等核心组件。所有服务都采用开源镜像，便于快速搭建开发和测试环境。

## Nginx

Nginx 作为高性能的 Web 服务器和反向代理服务器，是微服务架构中的重要组件。

```yaml
services:
  nginx:
   image: nginx:1.28.0-alpine
   container_name: nginx
   ports:
     - "80:80"
    #  - "443:443"
   environment:
     - TZ=Asia/Shanghai
   healthcheck:
     test: ["CMD", "nginx", "-t"]
     interval: 30s
     timeout: 10s
     retries: 3
   volumes:
      - ./conf/mime.types:/etc/nginx/mime.types:ro
      - ./conf/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./conf/web.conf:/etc/nginx/conf.d/default.conf:ro
     - ./data/nginx/certs:/etc/ssl/private:ro
     - ./data/nginx/html:/usr/share/nginx/html
     - ./data/nginx/logs:/var/log/nginx:rw
   restart: always
```

### 配置文件

| 配置文件 | 说明 | 下载链接 |
|----------|----------|----------|
| mime.types | Nginx 配置文件，定义 MIME 类型 | [:material-download: 下载](../temples/configs/mime.types){ .md-button } |
| nginx.conf | Nginx 主配置文件，定义服务器和反向代理 | [:material-download: 下载](../temples/configs/nginx.conf){ .md-button } |
| web.conf | Nginx 业务配置文件，定义网站的反向代理 | [:material-download: 下载](../temples/configs/web.conf){ .md-button } |

### 其他配置

Portainer代理配置

```nginx
        # Portainer代理配置
        location /portainer {
            # 重定向到不带尾部斜杠的路径
            return 301 http://$host:$server_port/portainer/;
        }

        location /portainer/ {
            # 移除路径前缀，直接代理到根路径
            rewrite ^/portainer/(.*)$ /$1 break;
            proxy_pass http://127.0.0.1:9000/;
            proxy_http_version 1.1;

            # 修复CSRF问题的代理头配置
            proxy_set_header Host 127.0.0.1:9000;  # 设置为后端实际地址
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host:$server_port;  # 包含端口信息
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_set_header Origin http://127.0.0.1:9000;    # 设置正确的Origin
            proxy_set_header Referer http://127.0.0.1:9000/;  # 设置正确的Referer

            # WebSocket支持
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # 缓冲设置
            proxy_buffering off;
            proxy_cache off;

            # 超时设置
            proxy_connect_timeout 1800s;
            proxy_send_timeout 1800s;
            proxy_read_timeout 1800s;

            # 请求体大小限制
            client_max_body_size 50000M;

            # 处理重定向 - 将后端的重定向URL修改为包含前缀的URL
            proxy_redirect ~^/(.*)$ /portainer/$1;
            proxy_redirect / /portainer/;
        }
```

pgAdmin代理配置

```nginx
        # pgAdmin代理配置
        location /pgadmin/ {
            proxy_pass http://127.0.0.1:8080/;
            proxy_http_version 1.1;

            # 基本代理头
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_set_header X-Script-Name /pgadmin;

            # WebSocket支持
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # 缓冲设置
            proxy_buffering off;
            proxy_cache off;

            # 超时设置
            proxy_connect_timeout 1800s;
            proxy_send_timeout 1800s;
            proxy_read_timeout 1800s;

            # 请求体大小限制
            client_max_body_size 2000M;

            # 处理重定向
            proxy_redirect off;
        }


        # pgAdmin静态文件处理
        location ~* ^/pgadmin/.*\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Script-Name /pgadmin;
            expires 1M;
            add_header Cache-Control "public, immutable";
        }
```


### 证书生成

如果有域名，可以使用 Let's Encrypt 生成免费的 SSL 证书。

```bash
certbot certonly --standalone -d example.com --email your-email@example.com --agree-tos
# 将生成的证书和私钥复制到 Nginx 配置目录中。
cp /etc/letsencrypt/live/example.com/fullchain.pem ./data/nginx/certs/
cp /etc/letsencrypt/live/example.com/privkey.pem ./data/nginx/certs/
```
如果没有域名，可以通过openssl 生成自签名证书。
```bash
openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout ./data/nginx/certs/selfsigned.key -out ./data/nginx/certs/selfsigned.crt
```


## Nacos

Nacos 是阿里巴巴开源的服务发现、配置管理和服务管理平台。

```yaml
services:
  nacos:
    image: nacos-server:v3.0.1
    container_name: nacos
    ports:
      - "8848:8848"  # Server API port  #(1)!
      - "9848:9848"  # gRPC port
      - "9849:9849"  # gRPC config port
      - "7848:7848"  # Raft port
      - "8080:8080"  # Console port (v3 only, safe to expose for v2) #(2)!
    env_file:
      - ./conf/nacos-standlone.env
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./conf/nacos-application.properties:/home/nacos/conf/application.properties
      - ./data/nacos/data/:/home/nacos/data
      - ./data/nacos/logs/:/home/nacos/logs
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/nacos/ || curl -f http://localhost:8848/nacos/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: always
```

1. 8848 端口为 Nacos V2 服务端 API 端口，用于客户端调用。

2. 8080 端口为 Nacos V3 控制台端口，用于管理配置和服务。

### 配置文件

| 配置文件 | 说明 | 下载链接 |
|----------|----------|----------|
| nacos-standlone.env | Nacos 配置文件，定义环境变量 | [:material-download: 下载](../temples/configs/nacos-standlone.env){ .md-button } |
| nacos-application.properties | Nacos 配置文件，定义应用属性 | [:material-download: 下载](../temples/configs/nacos-application.properties){ .md-button } |


## MinIO

MinIO 是高性能的分布式对象存储系统，兼容 Amazon S3 API。

### HTTP 模式
```yaml
services:
  minio: 
    image: minio:RELEASE.2025-07-23T15-54-02Z
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: 'admin'
      MINIO_ROOT_PASSWORD: 'm3VeRe8a'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./data/minio/data:/data
    restart: always
```

### HTTPS 模式

???+ Warning

    证书命名需要为 private.key 和 public.crt ，否则可能无法正常生效

```yaml
services:
  minio: 
    image: minio:RELEASE.2025-07-23T15-54-02Z
    container_name: minio
    ports:
      - "9000:9000"  # HTTPS API
      - "9001:9001"  # HTTPS Console
    command: server /data --console-address ":9001" --certs-dir /certs
    environment:
      MINIO_ROOT_USER: 'admin'
      MINIO_ROOT_PASSWORD: 'm3VeRe8a'
      MINIO_SERVER_URL: "https://<ipaddr>:9000" 
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./data/minio/data:/data
      - ./certs:/certs  # 挂载证书目录
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost:9000/minio/health/live"]  
      interval: 30s
      timeout: 10s
      retries: 3
    restart: always
```

通过下面命令生成自定义 SSL 证书。

```bash hl_lines="8"
# 创建证书目录
mkdir -p ./certs  && cd ./certs

# 生成私钥 (必须命名为 private.key)
openssl genrsa -out private.key 2048

# 生成自签名证书 (必须命名为 public.crt)
openssl req -new -x509 -key private.key -sha256 -days 365 -out public.crt \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=YourOrg/CN=183.237.186.226" \
  -addext "subjectAltName=IP:<ipaddr>,IP:127.0.0.1,DNS:localhost,DNS:<domain>"   #(1)!

# 设置权限
chmod 600 private.key
chmod 644 public.crt

# 验证证书
openssl x509 -in public.crt -text -noout | grep -A 5 "Subject Alternative Name"
```

1. 要将这里的 `<ipaddr>` / `<domain>` 替换为自己实际的 IP 地址和域名。

### 同步复制

MinIO 支持数据同步复制，确保数据的高可用性和冗余性。

???+ Warning

    同步复制需要Minio 备份节点应为空白，否则无法正常完成数据同步。

    另外， 只有Minio 版本 < `v2025.05.xx` 才默认支持，后面版本功能已被完全阉割。



```yaml
services:
  minio-mc:
    image: minio/mc:latest
    container_name: minio-mc
    environment:
      SITE1_URL: http://<SITE1_IP>:9000
      SITE2_URL: http://<SITE2_IP>:9000
      MINIO_ACCESS_KEY: "${MINIO_ROOT_USER}"
      MINIO_SECRET_KEY: "${MINIO_ROOT_PASSWORD}"
    volumes:
      - ./scripts/site-replication.sh:/site-replication.sh
    entrypoint: ["/bin/bash", "/site-replication.sh"]
    restart: on-failure
```

| 脚本文件 | 说明 | 下载链接 |
|----------|----------|----------|
| site-replication.sh | 同步复制脚本 | [:material-download: 下载](../temples/scripts/site-replication.sh){ .md-button } |



## Redis

Redis 是高性能的内存数据结构存储，用作缓存、消息代理和数据库。

```yaml
services:
  redis:
   image: redis:8.0.3
   container_name: redis
   ports:
     - "6379:6379"
   command: [ "redis-server", "/usr/local/etc/redis/redis.conf"]
   volumes:
     - /etc/localtime:/etc/localtime:ro
     - ./conf/redis.conf:/usr/local/etc/redis/redis.conf
     - ./data/redis/data:/data
   privileged: true
   healthcheck:
     test: ["CMD-SHELL", "redis-cli ping"]
     interval: 10s
     timeout: 5s
     retries: 3
   restart: always
```

| 配置文件 | 说明 | 下载链接 |
|----------|----------|----------|
| redis.conf | Redis 配置文件 | [:material-download: 下载](../temples/configs/redis.conf){ .md-button } |

## RabbitMQ

RabbitMQ 是功能强大的消息代理，支持多种消息传递协议。

```yaml
services:
  rabbitmq:
   image: rabbitmq:4.1.2-management-alpine
   container_name: rabbitmq
   hostname: rabbitmq
   ports:
     - 5672:5672
     - 15672:15672
   environment:
     TZ: Asia/Shanghai
     RABBITMQ_DEFAULT_USER: "admin"
     RABBITMQ_DEFAULT_PASS: "feNop7N3"
   healthcheck:
     test: [ "CMD", "rabbitmqctl", "status"]
     interval: 5s
     timeout: 20s
     retries: 10
   volumes:
     - /etc/localtime:/etc/localtime:ro
     - ./data/rabbitmq/data/:/var/lib/rabbitmq/
   restart: always
```


## PostgreSQL

PostgreSQL 是功能强大的开源关系型数据库，支持 PostGIS 地理信息扩展。

```yaml
services:
  postgres:
    image: freelabspace/postgresql-postgis:12.22
    container_name: postgres-postgis
    environment:
      - TZ=Asia/Shanghai
      - POSTGRES_DB=gis
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=5iQub9fo
    ports:
      - "5433:5432"
    volumes:
      - ./data/postgres/pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    networks:
      - pg

  pg-backup:
    image: freelabspace/postgresql-backup:latest
    container_name: pg-backup
    environment:
      TZ: Asia/Shanghai
      PG_HOST: postgres
      PG_PORT: 5432
      PG_USER: postgres
      PG_PASSWORD: 5iQub9fo
      PG_DATABASE: gis  # 使用逗号分隔多个数据库
      BACKUP_RETENTION_DAYS: 7 # 保留7天
      BACKUP_TIME: "03:00"  # 每天凌晨3点执行，24小时制
      BACKUP_INTERVAL: daily  # 备份间隔：daily（每天）、hourly（每小时）或数字（每隔多少分钟）
      ENABLE_COMPRESSION: "true" # 启用压缩
      BACKUP_FORMAT: "both"  # 备份格式: both（同时生成dump和sql）、dump（仅dump格式）、sql（仅sql格式）
      BACKUP_DIR: /backups
    volumes:
      - ./data/postgres/backups:/backups
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - pg

networks:
  pg:
    driver: bridge
```


## Elasticsearch

Elasticsearch 是分布式搜索和分析引擎，适用于全文搜索和数据分析。

```yaml
services:
  elastic:
   image: elasticsearch:9.0.4
   container_name: elastic
   environment:
     TZ: Asia/Shanghai
     ELASTIC_PASSWORD: p0y4REbA  
     ES_JAVA_OPTS: "-Xms2g -Xmx4g" 
   ports:
     - "9200:9200"
   volumes:
     - /etc/localtime:/etc/localtime:ro
     - ./data/elastic/data:/usr/share/elasticsearch/data
     - ./data/elastic/logs:/usr/share/elasticsearch/logs
     - ./data/elastic/plugins:/usr/share/elasticsearch/plugins
     - ./conf/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
   ulimits:
     memlock:
       soft: -1
       hard: -1
   restart: always
```

| 配置文件 | 说明 | 下载链接 |
|----------|----------|----------|
| elasticsearch.yml | Elasticsearch 配置文件 | [:material-download: 下载](../temples/configs/elasticsearch.yml){ .md-button } |

## GeoServer

GeoServer 是开源的地理信息服务器，用于发布地理空间数据。

```yaml
services:
  geoserver:
  image: kartoza/geoserver:2.27.1
  container_name: geoserver
  ports:
    - "8080:8080"
  environment:
    TIMEZONE: 'Asia/Shanghai'
    GEOSERVER_DATA_DIR: /opt/geoserver/data
    GEOSERVER_ADMIN_USER: "admin"
    GEOSERVER_ADMIN_PASSWORD: "yoRiK02a"
  volumes:
   - ./data/geoserver/data:/opt/geoserver/data
  restart: always
```


## 部署说明

### 1. 环境准备
```bash
# 创建必要的目录结构
mkdir -p ./data/elastic/{data,logs,snapshots}

# 设置目录权限
chmod -R 775 ./data/elastic/plugins/
mkdir -p     ./data/elastic/{data,logs,snapshots}
chmod -R 775 ./data/elastic/
```

### 2. 启动服务
```bash
# 启动所有服务
docker-compose up -d

# 启动指定服务
docker-compose up -d nginx redis 

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f nacos
```

### 3. 服务访问地址

| 服务 | 访问地址 | 默认账号密码 |
|------|----------|-------------|
| Nginx | http://localhost | - |
| Nacos | http://localhost:8848/nacos | nacos/nacos |
| MinIO | http://localhost:9001 | admin/lId5p4to |
| RabbitMQ | http://localhost:15672 | admin/feNop7N3 |
| Elasticsearch | http://localhost:9200 | elastic/p0y4REbA |
| GeoServer | http://localhost:8080/geoserver | admin/yoRiK02a |
