---
title: ç›‘æ§å‘Šè­¦
description: ç›‘æ§å‘Šè­¦
keywords:
  - ç›‘æ§å‘Šè­¦
  - è¿ç»´
  - çŸ¥è¯†åº“
  - ç³»ç»Ÿç¯å¢ƒ
tags:
  - ç›‘æ§å‘Šè­¦
  - è¿ç»´
  - çŸ¥è¯†åº“
  - ç³»ç»Ÿç¯å¢ƒ
---

# ç›‘æ§å‘Šè­¦ç³»ç»Ÿè®¾è®¡ä¸å®æˆ˜åº”ç”¨

åœ¨ç°ä»£è¿ç»´ä½“ç³»ä¸­ï¼Œç›‘æ§å‘Šè­¦æ˜¯ä¿éšœç³»ç»Ÿç¨³å®šè¿è¡Œçš„é‡è¦ç¯èŠ‚ã€‚æœ¬æ–‡å°†ç»“åˆç†è®ºåŸºç¡€å’Œdocker-composeå®é™…éƒ¨ç½²ï¼Œä¸ºä½ æ„å»ºä¸€å¥—å®Œæ•´çš„ç›‘æ§å‘Šè­¦çŸ¥è¯†ä½“ç³»ã€‚

---

## 1. ç›‘æ§å‘Šè­¦æ ¸å¿ƒç†è®º

### 1.1 å››ä¸ªé»„é‡‘ä¿¡å·

Google SRE æå‡ºçš„å››ä¸ªé»„é‡‘ä¿¡å·æ˜¯ç›‘æ§å‘Šè­¦çš„æ ¸å¿ƒæŒ‡æ ‡ï¼š

1. **å»¶è¿Ÿï¼ˆLatencyï¼‰**ï¼šæœåŠ¡å¤„ç†è¯·æ±‚æ‰€éœ€çš„æ—¶é—´
2. **æµé‡ï¼ˆTrafficï¼‰**ï¼šç³»ç»Ÿæ‰¿è½½çš„è¯·æ±‚é‡  
3. **é”™è¯¯ï¼ˆErrorsï¼‰**ï¼šå¤±è´¥è¯·æ±‚çš„æ¯”ç‡
4. **é¥±å’Œåº¦ï¼ˆSaturationï¼‰**ï¼šç³»ç»Ÿèµ„æºçš„ä½¿ç”¨ç¨‹åº¦

### 1.2 åˆ†å±‚ç›‘æ§æ¶æ„

```mermaid
graph TB
    A[ä¸šåŠ¡ç›‘æ§<br/>è®¢å•é‡ã€è½¬åŒ–ç‡ã€æ´»è·ƒç”¨æˆ·] --> D[å‘Šè­¦å¤„ç†ä¸­å¿ƒ]
    B[åº”ç”¨ç›‘æ§<br/>å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€QPS] --> D
    C[åŸºç¡€è®¾æ–½ç›‘æ§<br/>CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ] --> D
    
    D --> E[å³æ—¶é€šçŸ¥<br/>é‚®ä»¶ã€çŸ­ä¿¡ã€ä¼ä¸šå¾®ä¿¡]
    D --> F[å·¥å•ç³»ç»Ÿ<br/>è‡ªåŠ¨å·¥å•ã€æµç¨‹ç®¡ç†] 
    D --> G[å¤§å±å±•ç¤º<br/>å®æ—¶çŠ¶æ€ã€è¶‹åŠ¿åˆ†æ]
```

### 1.3 å‘Šè­¦çº§åˆ«å®šä¹‰

| çº§åˆ« | æè¿° | å“åº”æ—¶é—´ | é€šçŸ¥æ–¹å¼ | å®é™…ç¤ºä¾‹ |
|------|------|----------|----------|----------|
| P0 - ç´§æ€¥ | ä¸šåŠ¡å®Œå…¨ä¸­æ–­ | ç«‹å³å“åº” | ç”µè¯+çŸ­ä¿¡+å¾®ä¿¡ | æ”¯ä»˜ç³»ç»Ÿå®•æœº |
| P1 - ä¸¥é‡ | æ ¸å¿ƒåŠŸèƒ½å¼‚å¸¸ | 15åˆ†é’Ÿå†… | çŸ­ä¿¡+å¾®ä¿¡+é‚®ä»¶ | æ•°æ®åº“ä¸»ä»åˆ‡æ¢ |
| P2 - é‡è¦ | æ€§èƒ½æ˜¾è‘—ä¸‹é™ | 30åˆ†é’Ÿå†… | å¾®ä¿¡+é‚®ä»¶ | APIå“åº”æ—¶é—´è¶…é˜ˆå€¼ |
| P3 - ä¸€èˆ¬ | æ¬¡è¦åŠŸèƒ½å¼‚å¸¸ | 1å°æ—¶å†… | é‚®ä»¶ | éå…³é”®æœåŠ¡å‘Šè­¦ |

---

## 2. Docker Compose éƒ¨ç½²æ–¹æ¡ˆ

### 2.1 é¡¹ç›®ç»“æ„

```
monitoring/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ prometheus/
â”‚   â”œâ”€â”€ prometheus.yml
â”‚   â””â”€â”€ rules/
â”‚       â”œâ”€â”€ system_alerts.yml
â”‚       â”œâ”€â”€ app_alerts.yml
â”‚       â””â”€â”€ business_alerts.yml
â”œâ”€â”€ alertmanager/
â”‚   â”œâ”€â”€ alertmanager.yml
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ wechat.tmpl
â”œâ”€â”€ grafana/
â”‚   â”œâ”€â”€ datasources/
â”‚   â””â”€â”€ dashboards/
â””â”€â”€ scripts/
    â”œâ”€â”€ deploy.sh
    â””â”€â”€ node_exporter_install.sh
```

### 2.2 ä¸»é…ç½®æ–‡ä»¶

**docker-compose.yml**
```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./prometheus/rules:/etc/prometheus/rules
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--storage.tsdb.retention.size=50GB'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    networks:
      - monitoring
    restart: unless-stopped

  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - ./alertmanager/templates:/etc/alertmanager/templates
      - alertmanager_data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:9093'
    networks:
      - monitoring
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.1.0
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    networks:
      - monitoring
    restart: unless-stopped

  # Node Exporter ç”¨äºç›‘æ§å®¿ä¸»æœº
  node-exporter:
    image: prom/node-exporter:v1.6.1
    container_name: node-exporter
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - monitoring
    restart: unless-stopped

  # cAdvisor ç”¨äºç›‘æ§å®¹å™¨
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.0
    container_name: cadvisor
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    devices:
      - /dev/kmsg
    networks:
      - monitoring
    restart: unless-stopped

networks:
  monitoring:
    driver: bridge

volumes:
  prometheus_data:
  alertmanager_data:
  grafana_data:
```

### 2.3 Prometheus é…ç½®

**prometheus/prometheus.yml**
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'docker-monitoring'
    replica: 'A'

rule_files:
  - "/etc/prometheus/rules/*.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  # Prometheus è‡ªç›‘æ§
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Node Exporter ç³»ç»Ÿç›‘æ§
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'monitoring-server'

  # cAdvisor å®¹å™¨ç›‘æ§
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']

  # å¤–éƒ¨æœåŠ¡å™¨ç›‘æ§
  - job_name: 'external-servers'
    static_configs:
      - targets:
        - '192.168.1.10:9100'  # app-server-01
        - '192.168.1.11:9100'  # app-server-02
    relabel_configs:
      - source_labels: [__address__]
        regex: '192.168.1.10:9100'
        target_label: server_role
        replacement: 'app-server-01'
      - source_labels: [__address__]
        regex: '192.168.1.11:9100'
        target_label: server_role
        replacement: 'app-server-02'

  # Spring Boot åº”ç”¨ç›‘æ§
  - job_name: 'spring-boot-apps'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets:
        - '192.168.1.10:8080'  # app-01
        - '192.168.1.11:8080'  # app-02
    scrape_interval: 10s

  # MySQL æ•°æ®åº“ç›‘æ§
  - job_name: 'mysql'
    static_configs:
      - targets: ['192.168.1.10:9104']
    relabel_configs:
      - source_labels: [__address__]
        target_label: mysql_instance
        replacement: 'prod-mysql-01'

  # Redis ç¼“å­˜ç›‘æ§
  - job_name: 'redis'
    static_configs:
      - targets: ['192.168.1.10:9121']
```

### 2.4 ç³»ç»Ÿå‘Šè­¦è§„åˆ™

**prometheus/rules/system_alerts.yml**
```yaml
groups:
- name: system_alerts
  rules:
  # å®ä¾‹å®•æœºå‘Šè­¦
  - alert: InstanceDown
    expr: up == 0
    for: 1m
    labels:
      severity: critical
      team: ops
      service: infrastructure
    annotations:
      summary: "å®ä¾‹ {{ $labels.instance }} å®•æœº"
      description: "{{ $labels.job }}/{{ $labels.instance }} å·²å®•æœºè¶…è¿‡1åˆ†é’Ÿ"
      runbook_url: "https://wiki.company.com/runbook/instance-down"

  # CPUä½¿ç”¨ç‡å‘Šè­¦
  - alert: HighCPUUsage
    expr: (100 - (avg by(instance)(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 85
    for: 5m
    labels:
      severity: warning
      team: ops
      service: infrastructure
    annotations:
      summary: "CPUä½¿ç”¨ç‡è¿‡é«˜"
      description: "å®ä¾‹ {{ $labels.instance }} CPUä½¿ç”¨ç‡ {{ $value | printf \"%.1f\" }}%ï¼Œè¶…è¿‡85%é˜ˆå€¼ï¼ŒæŒç»­5åˆ†é’Ÿ"

  - alert: CriticalCPUUsage
    expr: (100 - (avg by(instance)(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 95
    for: 2m
    labels:
      severity: critical
      team: ops
      service: infrastructure
    annotations:
      summary: "CPUä½¿ç”¨ç‡æé«˜"
      description: "å®ä¾‹ {{ $labels.instance }} CPUä½¿ç”¨ç‡ {{ $value | printf \"%.1f\" }}%ï¼Œè¶…è¿‡95%é˜ˆå€¼"

  # å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
  - alert: HighMemoryUsage
    expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 80
    for: 5m
    labels:
      severity: warning
      team: ops
      service: infrastructure
    annotations:
      summary: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
      description: "å®ä¾‹ {{ $labels.instance }} å†…å­˜ä½¿ç”¨ç‡ {{ $value | printf \"%.1f\" }}%ï¼Œè¶…è¿‡80%é˜ˆå€¼"

  # ç£ç›˜ç©ºé—´å‘Šè­¦
  - alert: DiskSpaceWarning
    expr: (1 - node_filesystem_avail_bytes{fstype!="tmpfs",mountpoint!="/boot"} / node_filesystem_size_bytes{fstype!="tmpfs",mountpoint!="/boot"}) * 100 > 80
    for: 5m
    labels:
      severity: warning
      team: ops
      service: infrastructure
    annotations:
      summary: "ç£ç›˜ç©ºé—´ä¸è¶³"
      description: "å®ä¾‹ {{ $labels.instance }} ç£ç›˜ {{ $labels.mountpoint }} ä½¿ç”¨ç‡ {{ $value | printf \"%.1f\" }}%"

  - alert: DiskSpaceCritical
    expr: (1 - node_filesystem_avail_bytes{fstype!="tmpfs",mountpoint!="/boot"} / node_filesystem_size_bytes{fstype!="tmpfs",mountpoint!="/boot"}) * 100 > 90
    for: 2m
    labels:
      severity: critical
      team: ops
      service: infrastructure
    annotations:
      summary: "ç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³"
      description: "å®ä¾‹ {{ $labels.instance }} ç£ç›˜ {{ $labels.mountpoint }} ä½¿ç”¨ç‡ {{ $value | printf \"%.1f\" }}%ï¼Œè¯·ç«‹å³å¤„ç†"

  # ç³»ç»Ÿè´Ÿè½½å‘Šè­¦
  - alert: HighSystemLoad
    expr: node_load5 > (count by(instance)(node_cpu_seconds_total{mode="idle"}) * 1.5)
    for: 10m
    labels:
      severity: warning
      team: ops
      service: infrastructure
    annotations:
      summary: "ç³»ç»Ÿè´Ÿè½½è¿‡é«˜"
      description: "å®ä¾‹ {{ $labels.instance }} 5åˆ†é’Ÿè´Ÿè½½ {{ $value | printf \"%.2f\" }}ï¼Œè¶…è¿‡CPUæ ¸æ•°çš„1.5å€"

  # Dockerå®¹å™¨å‘Šè­¦
  - alert: ContainerDown
    expr: absent(container_last_seen) or (time() - container_last_seen > 60)
    for: 1m
    labels:
      severity: critical
      team: ops
      service: container
    annotations:
      summary: "å®¹å™¨ {{ $labels.name }} å·²åœæ­¢"
      description: "å®¹å™¨ {{ $labels.name }} åœ¨å®ä¾‹ {{ $labels.instance }} ä¸Šå·²åœæ­¢è¿è¡Œ"

  - alert: ContainerHighMemoryUsage
    expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) * 100 > 80
    for: 5m
    labels:
      severity: warning
      team: ops
      service: container
    annotations:
      summary: "å®¹å™¨å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
      description: "å®¹å™¨ {{ $labels.name }} å†…å­˜ä½¿ç”¨ç‡ {{ $value | printf \"%.1f\" }}%"
```

### 2.5 åº”ç”¨å‘Šè­¦è§„åˆ™

**prometheus/rules/app_alerts.yml**
```yaml
groups:
- name: application_alerts
  rules:
  # HTTPé”™è¯¯ç‡å‘Šè­¦
  - alert: HighHTTPErrorRate
    expr: (sum(rate(http_requests_total{status=~"5.."}[5m])) by (instance, job) / sum(rate(http_requests_total[5m])) by (instance, job)) * 100 > 5
    for: 2m
    labels:
      severity: critical
      team: dev
      service: application
    annotations:
      summary: "HTTPé”™è¯¯ç‡è¿‡é«˜"
      description: "åº”ç”¨ {{ $labels.job }} å®ä¾‹ {{ $labels.instance }} 5xxé”™è¯¯ç‡ {{ $value | printf \"%.2f\" }}%ï¼Œè¶…è¿‡5%é˜ˆå€¼"

  # å“åº”æ—¶é—´å‘Šè­¦
  - alert: HighResponseTime
    expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, instance, job)) > 1
    for: 5m
    labels:
      severity: warning
      team: dev
      service: application
    annotations:
      summary: "å“åº”æ—¶é—´è¿‡é«˜"
      description: "åº”ç”¨ {{ $labels.job }} å®ä¾‹ {{ $labels.instance }} P95å“åº”æ—¶é—´ {{ $value | printf \"%.2f\" }}sï¼Œè¶…è¿‡1sé˜ˆå€¼"

  # JVMå†…å­˜å‘Šè­¦
  - alert: HighJVMMemoryUsage
    expr: (jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"}) * 100 > 80
    for: 5m
    labels:
      severity: warning
      team: dev
      service: application
    annotations:
      summary: "JVMå †å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
      description: "åº”ç”¨ {{ $labels.job }} JVMå †å†…å­˜ä½¿ç”¨ç‡ {{ $value | printf \"%.1f\" }}%ï¼Œè¶…è¿‡80%é˜ˆå€¼"

  # GCæ—¶é—´å‘Šè­¦
  - alert: HighGCTime
    expr: increase(jvm_gc_collection_seconds_sum[5m]) / increase(jvm_gc_collection_seconds_count[5m]) > 0.1
    for: 5m
    labels:
      severity: warning
      team: dev
      service: application
    annotations:
      summary: "GCè€—æ—¶è¿‡é•¿"
      description: "åº”ç”¨ {{ $labels.job }} å¹³å‡GCæ—¶é—´ {{ $value | printf \"%.3f\" }}sï¼Œè¶…è¿‡0.1sé˜ˆå€¼"

  # çº¿ç¨‹æ­»é”å‘Šè­¦
  - alert: JVMDeadlockedThreads
    expr: jvm_threads_deadlocked > 0
    for: 1m
    labels:
      severity: critical
      team: dev
      service: application
    annotations:
      summary: "JVMæ£€æµ‹åˆ°æ­»é”çº¿ç¨‹"
      description: "åº”ç”¨ {{ $labels.job }} æ£€æµ‹åˆ° {{ $value }} ä¸ªæ­»é”çº¿ç¨‹"
```

### 2.6 ä¸šåŠ¡å‘Šè­¦è§„åˆ™

**prometheus/rules/business_alerts.yml**
```yaml
groups:
- name: business_alerts
  rules:
  # è®¢å•é‡å¼‚å¸¸å‘Šè­¦
  - alert: LowOrderCount
    expr: rate(orders_created_total[10m]) * 3600 < 100  # æ¯å°æ—¶è®¢å•æ•°å°‘äº100
    for: 10m
    labels:
      severity: warning
      team: business
      service: order
    annotations:
      summary: "è®¢å•é‡å¼‚å¸¸åä½"
      description: "å½“å‰è®¢å•åˆ›å»ºé€Ÿç‡ {{ $value | printf \"%.0f\" }} è®¢å•/å°æ—¶ï¼Œä½äºæ­£å¸¸æ°´å¹³100"

  # æ”¯ä»˜æˆåŠŸç‡å‘Šè­¦
  - alert: LowPaymentSuccessRate
    expr: (rate(payment_total{status="success"}[5m]) / rate(payment_total[5m])) * 100 < 95
    for: 5m
    labels:
      severity: critical
      team: business
      service: payment
    annotations:
      summary: "æ”¯ä»˜æˆåŠŸç‡è¿‡ä½"
      description: "æ”¯ä»˜æˆåŠŸç‡ {{ $value | printf \"%.1f\" }}%ï¼Œä½äº95%é˜ˆå€¼"

  # ç”¨æˆ·ç™»å½•å¼‚å¸¸
  - alert: HighLoginFailureRate
    expr: (rate(login_attempts_total{status="failed"}[5m]) / rate(login_attempts_total[5m])) * 100 > 20
    for: 3m
    labels:
      severity: warning
      team: security
      service: auth
    annotations:
      summary: "ç™»å½•å¤±è´¥ç‡å¼‚å¸¸"
      description: "ç™»å½•å¤±è´¥ç‡ {{ $value | printf \"%.1f\" }}%ï¼Œè¶…è¿‡20%é˜ˆå€¼ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é—®é¢˜"

  # APIè°ƒç”¨é‡å¼‚å¸¸
  - alert: APICallAbnormal
    expr: rate(api_requests_total[5m]) < 10
    for: 10m
    labels:
      severity: warning
      team: dev
      service: api
    annotations:
      summary: "APIè°ƒç”¨é‡å¼‚å¸¸åä½"
      description: "APIè°ƒç”¨é€Ÿç‡ {{ $value | printf \"%.1f\" }} è¯·æ±‚/ç§’ï¼Œå¼‚å¸¸åä½"
```

### 2.7 Alertmanager é…ç½®

**alertmanager/alertmanager.yml**
```yaml
global:
  smtp_smarthost: 'smtp.163.com:587'
  smtp_from: 'alert@company.com'
  smtp_auth_username: 'alert@company.com'
  smtp_auth_password: 'your_smtp_password'
  wechat_api_url: 'https://qyapi.weixin.qq.com/cgi-bin/'

templates:
  - '/etc/alertmanager/templates/*.tmpl'

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
  # å…³é”®ä¸šåŠ¡å‘Šè­¦ - ç«‹å³é€šçŸ¥
  - match:
      severity: critical
    receiver: 'critical-alerts'
    group_wait: 0s
    repeat_interval: 5m
    routes:
    # æ”¯ä»˜ç³»ç»Ÿç‰¹æ®Šå¤„ç†
    - match:
        service: payment
      receiver: 'payment-team'
    # åŸºç¡€è®¾æ–½æ•…éšœ
    - match:
        service: infrastructure
      receiver: 'ops-critical'

  # ä¸€èˆ¬å‘Šè­¦
  - match:
      severity: warning
    receiver: 'warning-alerts'

  # ä¸šåŠ¡å‘Šè­¦
  - match:
      team: business
    receiver: 'business-team'

  # æµ‹è¯•ç¯å¢ƒé™é»˜
  - match:
      cluster: test
    receiver: 'null'

receivers:
# é»˜è®¤æ¥æ”¶è€…
- name: 'default'
  email_configs:
  - to: 'ops@company.com'
    subject: 'ã€ç›‘æ§å‘Šè­¦ã€‘{{ .GroupLabels.alertname }}'
    body: |
      {{ range .Alerts }}
      å‘Šè­¦åç§°: {{ .Annotations.summary }}
      å‘Šè­¦æè¿°: {{ .Annotations.description }}
      å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
      è§¦å‘æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
      å®ä¾‹ä¿¡æ¯: {{ .Labels.instance }}
      {{ end }}

# å…³é”®å‘Šè­¦
- name: 'critical-alerts'
  email_configs:
  - to: 'ops-leader@company.com,cto@company.com'
    subject: 'ã€ğŸš¨ç´§æ€¥å‘Šè­¦ã€‘{{ .GroupLabels.alertname }}'
  wechat_configs:
  - corp_id: 'your_corp_id'
    api_secret: 'your_api_secret'
    to_party: 'ops'
    agent_id: '1000003'
    title: 'ğŸš¨ ç´§æ€¥å‘Šè­¦'
    message: |
      {{ template "wechat.default.message" . }}

# è¿ç»´å…³é”®å‘Šè­¦
- name: 'ops-critical'
  email_configs:
  - to: 'ops-leader@company.com'
  webhook_configs:
  - url: 'http://your-webhook-server/dingtalk'
    title: 'åŸºç¡€è®¾æ–½å‘Šè­¦'
    text: |
      {{ range .Alerts }}
      {{ .Annotations.summary }}
      {{ .Annotations.description }}
      æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
      {{ end }}

# æ”¯ä»˜å›¢é˜Ÿå‘Šè­¦
- name: 'payment-team'
  email_configs:
  - to: 'payment-dev@company.com'
  webhook_configs:
  - url: 'http://your-webhook-server/payment-alerts'

# ä¸€èˆ¬å‘Šè­¦
- name: 'warning-alerts'
  email_configs:
  - to: 'ops@company.com'
    subject: 'ã€âš ï¸è­¦å‘Šã€‘{{ .GroupLabels.alertname }}'

# ä¸šåŠ¡å‘Šè­¦
- name: 'business-team'
  email_configs:
  - to: 'business@company.com,product@company.com'
    subject: 'ã€ğŸ“Šä¸šåŠ¡å‘Šè­¦ã€‘{{ .GroupLabels.alertname }}'

# ç©ºæ¥æ”¶è€…
- name: 'null'

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
# å½“criticalå‘Šè­¦è§¦å‘æ—¶ï¼ŒæŠ‘åˆ¶ç›¸åŒå®ä¾‹çš„warningå‘Šè­¦
- source_match:
    severity: 'critical'
  target_match:
    severity: 'warning'
  equal: ['alertname', 'instance']

# å½“å®ä¾‹å®•æœºæ—¶ï¼ŒæŠ‘åˆ¶è¯¥å®ä¾‹çš„æ‰€æœ‰å…¶ä»–å‘Šè­¦
- source_match:
    alertname: 'InstanceDown'
  target_match_re:
    alertname: '.*'
  equal: ['instance']
```

### 2.8 ä¼ä¸šå¾®ä¿¡å‘Šè­¦æ¨¡æ¿

**alertmanager/templates/wechat.tmpl**
```go-template
{{ define "wechat.default.message" }}
{{- if gt (len .Alerts.Firing) 0 -}}
ğŸš¨ **å‘Šè­¦è§¦å‘** ({{ len .Alerts.Firing }}æ¡)
{{ range .Alerts.Firing }}
**{{ .Annotations.summary }}**
> æè¿°: {{ .Annotations.description }}
> çº§åˆ«: {{ .Labels.severity }}
> å®ä¾‹: {{ .Labels.instance }}
> æ—¶é—´: {{ .StartsAt.Format "01-02 15:04:05" }}
{{ if .Annotations.runbook_url }}> [å¤„ç†æ‰‹å†Œ]({{ .Annotations.runbook_url }}){{ end }}

{{ end }}
{{- end }}

{{- if gt (len .Alerts.Resolved) 0 -}}
âœ… **å‘Šè­¦æ¢å¤** ({{ len .Alerts.Resolved }}æ¡)
{{ range .Alerts.Resolved }}
**{{ .Annotations.summary }}**
> å®ä¾‹: {{ .Labels.instance }}
> æŒç»­æ—¶é—´: {{ (.EndsAt.Sub .StartsAt).Round 1 }}
> æ¢å¤æ—¶é—´: {{ .EndsAt.Format "01-02 15:04:05" }}

{{ end }}
{{- end }}
{{ end }}
```

---

## 3. ä¸€é”®éƒ¨ç½²è„šæœ¬

### 3.1 å®Œæ•´éƒ¨ç½²è„šæœ¬

**scripts/deploy.sh**
```bash
#!/bin/bash
# ç›‘æ§ç³»ç»Ÿä¸€é”®éƒ¨ç½²è„šæœ¬

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

echo "ğŸš€ å¼€å§‹éƒ¨ç½²ç›‘æ§å‘Šè­¦ç³»ç»Ÿ..."

# æ£€æŸ¥Dockerå’Œdocker-compose
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "âŒ docker-compose æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…docker-compose"
    exit 1
fi

# åˆ›å»ºå¿…è¦ç›®å½•
echo "ğŸ“ åˆ›å»ºç›®å½•ç»“æ„..."
mkdir -p "$PROJECT_DIR"/{prometheus/rules,alertmanager/templates,grafana/{datasources,dashboards}}

# æ£€æŸ¥é…ç½®æ–‡ä»¶
echo "ğŸ” æ£€æŸ¥é…ç½®æ–‡ä»¶..."
required_files=(
    "docker-compose.yml"
    "prometheus/prometheus.yml"
    "prometheus/rules/system_alerts.yml"
    "prometheus/rules/app_alerts.yml"
    "prometheus/rules/business_alerts.yml"
    "alertmanager/alertmanager.yml"
    "alertmanager/templates/wechat.tmpl"
)

for file in "${required_files[@]}"; do
    if [[ ! -f "$PROJECT_DIR/$file" ]]; then
        echo "âŒ ç¼ºå°‘é…ç½®æ–‡ä»¶: $file"
        exit 1
    fi
done

# è®¾ç½®æƒé™
echo "ğŸ”’ è®¾ç½®æƒé™..."
sudo chown -R 472:472 "$PROJECT_DIR/grafana" 2>/dev/null || true
sudo chown -R 65534:65534 "$PROJECT_DIR/prometheus" 2>/dev/null || true
sudo chown -R 65534:65534 "$PROJECT_DIR/alertmanager" 2>/dev/null || true

cd "$PROJECT_DIR"

# å¯åŠ¨æœåŠ¡
echo "ğŸ”„ å¯åŠ¨ç›‘æ§æœåŠ¡..."
docker-compose down 2>/dev/null || true
docker-compose up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 30

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
services=("prometheus" "alertmanager" "grafana" "node-exporter" "cadvisor")
all_healthy=true

for service in "${services[@]}"; do
    if docker-compose ps "$service" | grep -q "Up"; then
        echo "âœ… $service: è¿è¡Œæ­£å¸¸"
    else
        echo "âŒ $service: å¯åŠ¨å¤±è´¥"
        all_healthy=false
    fi
done

if $all_healthy; then
    echo ""
    echo "ğŸ‰ ç›‘æ§ç³»ç»Ÿéƒ¨ç½²æˆåŠŸï¼"
    echo "ğŸ“Š è®¿é—®åœ°å€ï¼š"
    echo "  - Prometheus: http://localhost:9090"
    echo "  - Alertmanager: http://localhost:9093" 
    echo "  - Grafana: http://localhost:3000 (admin/admin123)"
    echo ""
    echo "ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
    echo "  1. åœ¨ç›®æ ‡æœåŠ¡å™¨å®‰è£… Node Exporter"
    echo "  2. é…ç½®åº”ç”¨ç¨‹åºæŒ‡æ ‡æš´éœ²"
    echo "  3. å¯¼å…¥ Grafana ä»ªè¡¨ç›˜"
    echo "  4. æµ‹è¯•å‘Šè­¦é€šçŸ¥"
else
    echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—: docker-compose logs"
    exit 1
fi
```

### 3.2 Node Exporter å®‰è£…è„šæœ¬

**scripts/node_exporter_install.sh**
```bash
#!/bin/bash
# åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šå®‰è£… Node Exporter

set -e

NODE_EXPORTER_VERSION="1.6.1"
INSTALL_DIR="/opt/node_exporter"
SERVICE_USER="node_exporter"

echo "ğŸ”§ å®‰è£… Node Exporter v$NODE_EXPORTER_VERSION"

# æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
if [[ $EUID -ne 0 ]]; then
   echo "âŒ è¯·ä½¿ç”¨rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬"
   exit 1
fi

# åˆ›å»ºç”¨æˆ·
if ! id "$SERVICE_USER" &>/dev/null; then
    useradd -r -s /bin/false "$SERVICE_USER"
    echo "âœ… åˆ›å»ºç”¨æˆ·: $SERVICE_USER"
fi

# ä¸‹è½½å¹¶å®‰è£…
echo "ğŸ“¥ ä¸‹è½½ Node Exporter..."
cd /tmp
wget -q "https://github.com/prometheus/node_exporter/releases/download/v$NODE_EXPORTER_VERSION/node_exporter-$NODE_EXPORTER_VERSION.linux-amd64.tar.gz"

# è§£å‹å¹¶å®‰è£…
tar -xzf "node_exporter-$NODE_EXPORTER_VERSION.linux-amd64.tar.gz"
mkdir -p "$INSTALL_DIR"
cp "node_exporter-$NODE_EXPORTER_VERSION.linux-amd64/node_exporter" "$INSTALL_DIR/"
chmod +x "$INSTALL_DIR/node_exporter"
chown -R "$SERVICE_USER:$SERVICE_USER" "$INSTALL_DIR"

# åˆ›å»ºsystemdæœåŠ¡
cat > /etc/systemd/system/node_exporter.service << EOF
[Unit]
Description=Node Exporter
Documentation=https://prometheus.io/docs/guides/node-exporter/
After=network-online.target

[Service]
Type=simple
User=$SERVICE_USER
ExecStart=$INSTALL_DIR/node_exporter \\
  --web.listen-address=:9100 \\
  --path.procfs=/proc \\
  --path.sysfs=/sys \\
  --collector.filesystem.ignored-mount-points='^/(dev|proc|sys|var/lib/docker/.+)(\$|/)' \\
  --collector.filesystem.ignored-fs-types='^(autofs|binfmt_misc|cgroup|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|mqueue|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|sysfs|tracefs)\ \\
  --collector.systemd \\
  --collector.processes

SyslogIdentifier=node_exporter
Restart=always
RestartSec=1

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
systemctl daemon-reload
systemctl enable node_exporter
systemctl start node_exporter

# éªŒè¯å®‰è£…
sleep 3
if systemctl is-active --quiet node_exporter; then
    echo "âœ… Node Exporter å®‰è£…æˆåŠŸ"
    echo "ğŸ“Š ç›‘æ§ç«¯ç‚¹: http://$(hostname -I | awk '{print $1}'):9100/metrics"
    
    # ç®€å•æµ‹è¯•
    if curl -s http://localhost:9100/metrics | grep -q "node_cpu_seconds_total"; then
        echo "âœ… æŒ‡æ ‡é‡‡é›†æ­£å¸¸"
    else
        echo "âš ï¸  æŒ‡æ ‡é‡‡é›†å¯èƒ½æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥"
    fi
else
    echo "âŒ Node Exporter å¯åŠ¨å¤±è´¥"
    systemctl status node_exporter
    exit 1
fi

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf /tmp/node_exporter-*
echo "ğŸ§¹ æ¸…ç†å®Œæˆ"
```

---

## 4. Spring Boot åº”ç”¨é›†æˆ

### 4.1 æ·»åŠ ç›‘æ§ä¾èµ–

**pom.xml**
```xml
<dependencies>
    <!-- Spring Boot Actuator -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    
    <!-- Micrometer Prometheus -->
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-registry-prometheus</artifactId>
    </dependency>
</dependencies>
```

### 4.2 åº”ç”¨é…ç½®

**application.yml**
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: always
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5,0.9,0.95,0.99
    tags:
      application: ${spring.application.name}
      environment: ${spring.profiles.active:dev}

# åº”ç”¨ä¿¡æ¯
info:
  app:
    name: ${spring.application.name}
    version: @project.version@
    description: Demo application for monitoring
```

### 4.3 è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡

**BusinessMetrics.java**
```java
package com.example.monitoring;

import io.micrometer.core.instrument.*;
import org.springframework.stereotype.Component;

import java.util.concurrent.atomic.AtomicInteger;

@Component
public class BusinessMetrics {
    
    private final Counter orderCreatedCounter;
    private final Counter paymentCounter;
    private final Timer orderProcessTimer;
    private final Gauge activeUsersGauge;
    private final DistributionSummary orderAmountSummary;
    private final AtomicInteger activeUsers = new AtomicInteger(0);
    
    public BusinessMetrics(MeterRegistry registry) {
        // è®¢å•åˆ›å»ºè®¡æ•°å™¨
        this.orderCreatedCounter = Counter.builder("orders_created_total")
                .description("è®¢å•åˆ›å»ºæ€»æ•°")
                .tag("type", "business")
                .register(registry);
        
        // æ”¯ä»˜è®¡æ•°å™¨ï¼ˆå¸¦çŠ¶æ€æ ‡ç­¾ï¼‰
        this.paymentCounter = Counter.builder("payment_total")
                .description("æ”¯ä»˜æ€»æ•°")
                .register(registry);
        
        // è®¢å•å¤„ç†æ—¶é—´
        this.orderProcessTimer = Timer.builder("order_process_duration_seconds")
                .description("è®¢å•å¤„ç†è€—æ—¶")
                .register(registry);
        
        // æ´»è·ƒç”¨æˆ·æ•°
        this.activeUsersGauge = Gauge.builder("active_users_current")
                .description("å½“å‰æ´»è·ƒç”¨æˆ·æ•°")
                .register(registry, activeUsers, AtomicInteger::get);
        
        // è®¢å•é‡‘é¢åˆ†å¸ƒ
        this.orderAmountSummary = DistributionSummary.builder("order_amount_yuan")
                .description("è®¢å•é‡‘é¢åˆ†å¸ƒ")
                .minimumExpectedValue(1.0)
                .maximumExpectedValue(10000.0)
                .publishPercentiles(0.5, 0.95, 0.99)
                .register(registry);
    }
    
    // è®°å½•è®¢å•åˆ›å»º
    public void recordOrderCreated() {
        orderCreatedCounter.increment();
    }
    
    // è®°å½•æ”¯ä»˜ç»“æœ
    public void recordPayment(String status, double amount) {
        paymentCounter.increment(Tags.of("status", status));
        if ("success".equals(status)) {
            orderAmountSummary.record(amount);
        }
    }
    
    // å¼€å§‹è®¢å•å¤„ç†è®¡æ—¶
    public Timer.Sample startOrderProcessing() {
        return Timer.start(orderProcessTimer);
    }
    
    // æ›´æ–°æ´»è·ƒç”¨æˆ·æ•°
    public void setActiveUsers(int count) {
        activeUsers.set(count);
    }
}
```

### 4.4 ä¸šåŠ¡æ¥å£ç¤ºä¾‹

**OrderController.java**
```java
package com.example.controller;

import com.example.monitoring.BusinessMetrics;
import io.micrometer.core.instrument.Timer;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Random;

@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    @Autowired
    private BusinessMetrics businessMetrics;
    
    private final Random random = new Random();
    
    @PostMapping
    public String createOrder(@RequestBody OrderRequest request) {
        // å¼€å§‹è®¡æ—¶
        Timer.Sample sample = businessMetrics.startOrderProcessing();
        
        try {
            // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
            Thread.sleep(random.nextInt(1000) + 100);
            
            // è®°å½•è®¢å•åˆ›å»º
            businessMetrics.recordOrderCreated();
            
            // æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†
            boolean paymentSuccess = random.nextDouble() > 0.05; // 95% æˆåŠŸç‡
            double amount = request.getAmount();
            
            if (paymentSuccess) {
                businessMetrics.recordPayment("success", amount);
                return "Order created successfully";
            } else {
                businessMetrics.recordPayment("failed", amount);
                throw new RuntimeException("Payment failed");
            }
            
        } catch (Exception e) {
            throw new RuntimeException("Order processing failed", e);
        } finally {
            // ç»“æŸè®¡æ—¶
            sample.stop();
        }
    }
    
    @GetMapping("/stats")
    public String getStats() {
        // æ¨¡æ‹Ÿæ´»è·ƒç”¨æˆ·æ•°å˜åŒ–
        int activeUsers = random.nextInt(1000) + 500;
        businessMetrics.setActiveUsers(activeUsers);
        return "Current active users: " + activeUsers;
    }
    
    // æ¨¡æ‹Ÿæ…¢æ¥å£
    @GetMapping("/slow")
    public String slowEndpoint() throws InterruptedException {
        Thread.sleep(2000); // 2ç§’å»¶è¿Ÿ
        return "Slow response";
    }
    
    // æ¨¡æ‹Ÿé”™è¯¯æ¥å£
    @GetMapping("/error")
    public String errorEndpoint() {
        if (random.nextDouble() > 0.5) {
            throw new RuntimeException("Random error occurred");
        }
        return "Success";
    }
    
    public static class OrderRequest {
        private double amount;
        private String productId;
        
        // getters and setters
        public double getAmount() { return amount; }
        public void setAmount(double amount) { this.amount = amount; }
        public String getProductId() { return productId; }
        public void setProductId(String productId) { this.productId = productId; }
    }
}
```

---

## 5. Grafana ä»ªè¡¨ç›˜é…ç½®

### 5.1 æ•°æ®æºé…ç½®

**grafana/datasources/prometheus.yml**
```yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: true
    jsonData:
      httpMethod: GET
      prometheusType: Prometheus
      prometheusVersion: 2.47.0
```

### 5.2 ä»ªè¡¨ç›˜è‡ªåŠ¨å¯¼å…¥

**grafana/dashboards/dashboards.yml**
```yaml
apiVersion: 1

providers:
  - name: 'default'
    orgId: 1
    folder: ''
    folderUid: ''
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    allowUiUpdates: true
    options:
      path: /etc/grafana/provisioning/dashboards
```

---

## 6. æµ‹è¯•ä¸éªŒè¯

### 6.1 å‘Šè­¦æµ‹è¯•è„šæœ¬

**scripts/test_alerts.sh**
```bash
#!/bin/bash
# å‘Šè­¦æµ‹è¯•è„šæœ¬

echo "ğŸ§ª å¼€å§‹æµ‹è¯•å‘Šè­¦ç³»ç»Ÿ..."

# æµ‹è¯•CPUå‘Šè­¦
echo "1. æµ‹è¯•CPUå‘Šè­¦ï¼ˆåˆ›å»ºCPUè´Ÿè½½ï¼‰"
stress-ng --cpu 4 --timeout 300s &
STRESS_PID=$!
echo "âœ… CPUå‹åŠ›æµ‹è¯•å·²å¯åŠ¨ (PID: $STRESS_PID)ï¼Œå°†æŒç»­5åˆ†é’Ÿ"

# æµ‹è¯•å†…å­˜å‘Šè­¦
echo "2. æµ‹è¯•å†…å­˜å‘Šè­¦ï¼ˆå ç”¨å†…å­˜ï¼‰"  
stress-ng --vm 2 --vm-bytes 1G --timeout 300s &
echo "âœ… å†…å­˜å‹åŠ›æµ‹è¯•å·²å¯åŠ¨"

# æµ‹è¯•HTTPé”™è¯¯ç‡å‘Šè­¦
echo "3. æµ‹è¯•åº”ç”¨é”™è¯¯ç‡å‘Šè­¦"
for i in {1..50}; do
    curl -s http://localhost:8080/api/orders/error >/dev/null &
done
echo "âœ… HTTPé”™è¯¯è¯·æ±‚å·²å‘é€"

# æµ‹è¯•ç£ç›˜ç©ºé—´å‘Šè­¦
echo "4. æµ‹è¯•ç£ç›˜ç©ºé—´å‘Šè­¦ï¼ˆåˆ›å»ºå¤§æ–‡ä»¶ï¼‰"
dd if=/dev/zero of=/tmp/test_large_file bs=1M count=1000 2>/dev/null &
echo "âœ… ç£ç›˜æ–‡ä»¶åˆ›å»ºä¸­..."

echo ""
echo "ğŸ“Š ç›‘æ§æ£€æŸ¥å‘½ä»¤ï¼š"
echo "  - æŸ¥çœ‹Prometheusç›®æ ‡: http://localhost:9090/targets"
echo "  - æŸ¥çœ‹å‘Šè­¦è§„åˆ™: http://localhost:9090/alerts"
echo "  - æŸ¥çœ‹Alertmanager: http://localhost:9093"
echo "  - æŸ¥çœ‹Grafana: http://localhost:3000"
echo ""
echo "â° ç­‰å¾…5-10åˆ†é’Ÿï¼Œå‘Šè­¦åº”è¯¥ä¼šè§¦å‘"
echo "ğŸ§¹ æ¸…ç†å‘½ä»¤: pkill stress-ng && rm -f /tmp/test_large_file"
```

### 6.2 æŒ‡æ ‡éªŒè¯è„šæœ¬

**scripts/verify_metrics.sh**
```bash
#!/bin/bash
# æŒ‡æ ‡éªŒè¯è„šæœ¬

PROMETHEUS_URL="http://localhost:9090"
TARGETS=(
    "http://localhost:9100/metrics"  # node-exporter
    "http://localhost:8080/actuator/prometheus"  # spring-boot app
)

echo "ğŸ” éªŒè¯ç›‘æ§æŒ‡æ ‡..."

# æ£€æŸ¥Prometheusæ˜¯å¦è¿è¡Œ
if ! curl -s "$PROMETHEUS_URL/api/v1/query?query=up" | grep -q "success"; then
    echo "âŒ Prometheus ä¸å¯è®¿é—®"
    exit 1
fi
echo "âœ… Prometheus è¿è¡Œæ­£å¸¸"

# æ£€æŸ¥å„ä¸ªtargetçš„æŒ‡æ ‡
for target in "${TARGETS[@]}"; do
    echo "æ£€æŸ¥: $target"
    if curl -s --connect-timeout 5 "$target" | head -n 5 | grep -q "#"; then
        echo "âœ… $target - æŒ‡æ ‡æ­£å¸¸"
    else
        echo "âŒ $target - æŒ‡æ ‡å¼‚å¸¸æˆ–ä¸å¯è¾¾"
    fi
done

# æ£€æŸ¥å…³é”®æŒ‡æ ‡æ˜¯å¦å­˜åœ¨
key_metrics=(
    "up"
    "node_cpu_seconds_total"
    "node_memory_MemTotal_bytes"
    "http_requests_total"
    "jvm_memory_used_bytes"
)

echo ""
echo "ğŸ” æ£€æŸ¥å…³é”®æŒ‡æ ‡..."
for metric in "${key_metrics[@]}"; do
    result=$(curl -s "$PROMETHEUS_URL/api/v1/query?query=$metric" | jq -r '.data.result | length')
    if [[ "$result" -gt 0 ]]; then
        echo "âœ… $metric - æ‰¾åˆ° $result ä¸ªå®ä¾‹"
    else
        echo "âŒ $metric - æœªæ‰¾åˆ°æ•°æ®"
    fi
done

echo ""
echo "ğŸ“Š æŒ‡æ ‡éªŒè¯å®Œæˆ"
```

---

## 7. ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–å»ºè®®

### 7.1 æ€§èƒ½ä¼˜åŒ–

**Prometheus é…ç½®ä¼˜åŒ–**
```yaml
# prometheus.yml ä¼˜åŒ–é…ç½®
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  
  # å¤–éƒ¨æ ‡ç­¾
  external_labels:
    cluster: 'production'
    replica: '1'

# æ•°æ®ä¿ç•™ç­–ç•¥
storage:
  tsdb:
    retention.time: 30d
    retention.size: 50GB
    
# è¿œç¨‹å†™å…¥ï¼ˆå¯é€‰ï¼‰
remote_write:
  - url: "http://victoriametrics:8428/api/v1/write"
    queue_config:
      max_samples_per_send: 10000
      batch_send_deadline: 5s
      max_shards: 200
```

### 7.2 å®‰å…¨åŠ å›º

**docker-compose å®‰å…¨é…ç½®**
```yaml
services:
  prometheus:
    # æ·»åŠ èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    
    # åªæš´éœ²å†…ç½‘ç«¯å£
    ports:
      - "127.0.0.1:9090:9090"
    
    # æ·»åŠ å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
```

### 7.3 é«˜å¯ç”¨éƒ¨ç½²

**prometheus é›†ç¾¤é…ç½®**
```yaml
# docker-compose-ha.yml
version: '3.8'
services:
  prometheus-1:
    image: prom/prometheus:v2.47.0
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=15d'
      - '--web.external-url=http://prometheus-1:9090'
    external_labels:
      replica: 'A'
      
  prometheus-2:
    image: prom/prometheus:v2.47.0
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=15d'
      - '--web.external-url=http://prometheus-2:9090'
    external_labels:
      replica: 'B'
      
  # Thanos Query ç»Ÿä¸€æŸ¥è¯¢å±‚
  thanos-query:
    image: thanosio/thanos:v0.32.0
    command:
      - query
      - --http-address=0.0.0.0:10902
      - --store=prometheus-1:9090
      - --store=prometheus-2:9090
    ports:
      - "10902:10902"
```

---

## 8. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 8.1 å‘Šè­¦ç›¸å…³é—®é¢˜

**Q: å‘Šè­¦é£æš´å¦‚ä½•å¤„ç†ï¼Ÿ**
```yaml
# åœ¨ alertmanager.yml ä¸­é…ç½®
route:
  group_by: ['alertname', 'cluster']
  group_wait: 30s      # ç­‰å¾…30ç§’æ”¶é›†åŒç»„å‘Šè­¦
  group_interval: 5m   # æ–°å‘Šè­¦ç­‰å¾…5åˆ†é’Ÿ
  repeat_interval: 4h  # 4å°æ—¶é‡å¤å‘é€

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
- source_match:
    severity: 'critical'
  target_match:
    severity: 'warning'
  equal: ['alertname', 'instance']
```

**Q: å¦‚ä½•å®ç°å‘Šè­¦é™é»˜ï¼Ÿ**
```bash
# é€šè¿‡ amtool å‘½ä»¤è¡Œå·¥å…·
amtool silence add alertname="HighCPUUsage" instance="192.168.1.10:9100" --duration="2h" --comment="ç³»ç»Ÿç»´æŠ¤"

# æˆ–è€…é€šè¿‡API
curl -X POST http://localhost:9093/api/v1/silences \
  -H "Content-Type: application/json" \
  -d '{
    "matchers": [
      {
        "name": "alertname",
        "value": "HighCPUUsage"
      },
      {
        "name": "instance", 
        "value": "192.168.1.10:9100"
      }
    ],
    "startsAt": "2024-01-15T10:00:00.000Z",
    "endsAt": "2024-01-15T12:00:00.000Z",
    "createdBy": "admin",
    "comment": "ç³»ç»Ÿç»´æŠ¤çª—å£"
  }'
```

### 8.2 æ€§èƒ½ç›¸å…³é—®é¢˜

**Q: Prometheus å†…å­˜å ç”¨è¿‡é«˜ï¼Ÿ**
```yaml
# ä¼˜åŒ–é‡‡é›†é…ç½®
scrape_configs:
  - job_name: 'high-frequency'
    scrape_interval: 5s   # å…³é”®æœåŠ¡é«˜é¢‘
    
  - job_name: 'normal'
    scrape_interval: 30s  # æ™®é€šæœåŠ¡
    
  - job_name: 'low-frequency'
    scrape_interval: 60s  # æ‰¹å¤„ç†ä»»åŠ¡ä½é¢‘

# è°ƒæ•´ä¿ç•™ç­–ç•¥
storage:
  tsdb:
    retention.time: 15d  # å‡å°‘ä¿ç•™æ—¶é—´
    retention.size: 30GB # é™åˆ¶å­˜å‚¨å¤§å°
```
