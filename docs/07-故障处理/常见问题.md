---
title: 常见问题
description: 常见问题
keywords:
  - 常见问题
  - 运维
  - 知识库
  - 系统环境
tags:
  - 常见问题
  - 运维
  - 知识库
  - 系统环境
---

# 常见问题

本文档提供了操作系统、中间件和前后端应用的故障诊断、处理和维护操作指南。

## 系统监控与诊断

### 基础监控命令

```bash
# 系统资源监控
top                    # 实时查看系统进程
htop                   # 增强版进程监控
free -h                # 内存使用情况
df -h                  # 磁盘空间使用
iostat -x 1            # 磁盘I/O监控
vmstat 1               # 系统统计信息
sar -u 1 10            # CPU使用率统计

# 网络监控
netstat -tulpn         # 查看端口监听状态
ss -tulpn              # 现代版本的netstat
iftop                  # 网络流量监控
tcpdump -i eth0        # 网络包捕获
```

### 日志分析

```bash
# 系统日志
journalctl -xe         # 查看系统日志
journalctl -u servicename.service  # 查看特定服务日志
tail -f /var/log/messages          # 实时查看系统消息
grep -i error /var/log/syslog      # 搜索错误信息

# 应用日志
tail -f application.log            # 实时查看应用日志
grep -C 5 "ERROR" application.log  # 查找错误及上下文
zcat /var/log/nginx/access.log.gz | grep "404"  # 压缩日志分析
```

## 操作系统故障处理

### 磁盘空间不足

```bash
# 查找大文件
find / -type f -size +100M -exec ls -lh {} \; 2>/dev/null
du -ah /var/log/ | sort -rh | head -20

# 清理临时文件
rm -rf /tmp/*
rm -rf /var/tmp/*
docker system prune -f  # 清理Docker资源

# 日志轮转
logrotate -f /etc/logrotate.conf

# 清理包管理缓存
# CentOS/RHEL
yum clean all
# Ubuntu/Debian  
apt-get clean
apt-get autoremove
```

### 内存不足处理

```bash
# 查看内存使用
cat /proc/meminfo
ps aux --sort=-%mem | head -20

# 清理缓存
sync
echo 1 > /proc/sys/vm/drop_caches
echo 2 > /proc/sys/vm/drop_caches  
echo 3 > /proc/sys/vm/drop_caches

# 查看交换分区
swapon -s
free -h

# 添加临时交换文件（紧急情况）
fallocate -l 1G /swapfile
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
```

### CPU高负载处理

```bash
# 查找CPU占用高的进程
top -bn1 | head -20
ps aux --sort=-%cpu | head -20

# 查看系统负载
uptime
cat /proc/loadavg

# 限制进程CPU使用（nice值调整）
renice +10 -p PID      # 降低进程优先级
```

### 网络问题诊断

```bash
# 连通性测试
ping -c 4 8.8.8.8
traceroute google.com
mtr google.com

# 端口检测
telnet host port
nmap -p port host

# DNS解析检测
nslookup domain
dig domain
host domain

# 防火墙检查
iptables -L -n -v
firewall-cmd --list-all
```

## Docker 容器故障处理

### 容器状态检查

```bash
# 查看容器状态
docker ps -a
docker-compose ps

# 查看容器资源使用
docker stats
docker stats --no-stream

# 查看容器日志
docker logs container_name
docker-compose logs service_name
docker logs -f --tail 100 container_name
```

### 容器故障处理

```bash
# 重启容器
docker restart container_name
docker-compose restart service_name

# 强制停止并重启
docker-compose down
docker-compose up -d

# 进入容器调试
docker exec -it container_name /bin/bash
docker exec -it container_name /bin/sh

# 查看容器配置
docker inspect container_name
```

### Docker 系统维护

```bash
# 清理未使用的资源
docker system prune -f
docker image prune -f
docker volume prune -f
docker network prune -f

# 查看磁盘使用
docker system df

# 清理悬空镜像
docker rmi $(docker images -f "dangling=true" -q)
```

## 中间件故障处理

### Nginx 故障处理

```bash
# 配置文件检测
nginx -t
nginx -T  # 显示完整配置

# 重载配置
nginx -s reload
systemctl reload nginx

# 查看错误日志
tail -f /var/log/nginx/error.log
grep -i error /var/log/nginx/error.log

# 常见问题修复
# 权限问题
chown -R nginx:nginx /var/www/html
chmod -R 755 /var/www/html

# 端口占用检查
lsof -i :80
netstat -tulpn | grep :80
```

### Redis 故障处理

```bash
# 连接测试
redis-cli ping
redis-cli -h host -p port ping

# 内存使用检查
redis-cli info memory
redis-cli info stats

# 慢查询日志
redis-cli slowlog get 10
redis-cli slowlog len

# 数据持久化检查
redis-cli lastsave
redis-cli bgsave

# 配置重载
redis-cli config rewrite
```

### PostgreSQL 故障处理

```bash
# 连接测试
pg_isready -h localhost -p 5432
psql -h localhost -U postgres -d dbname -c "SELECT version();"

# 查看活动连接
psql -c "SELECT * FROM pg_stat_activity;"

# 锁等待检查
psql -c "SELECT * FROM pg_locks WHERE NOT granted;"

# 慢查询分析
psql -c "SELECT query, calls, total_time, mean_time FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;"

# 数据库大小检查
psql -c "SELECT pg_size_pretty(pg_database_size('dbname'));"

# 备份恢复
pg_dump -h localhost -U postgres dbname > backup.sql
psql -h localhost -U postgres dbname < backup.sql
```

### Elasticsearch 故障处理

```bash
# 集群健康检查
curl -X GET "localhost:9200/_cluster/health?pretty"
curl -X GET "localhost:9200/_cat/health?v"

# 节点状态
curl -X GET "localhost:9200/_cat/nodes?v"
curl -X GET "localhost:9200/_cat/indices?v"

# 分片状态
curl -X GET "localhost:9200/_cat/shards?v"

# 清理缓存
curl -X POST "localhost:9200/_cache/clear"

# 强制合并索引
curl -X POST "localhost:9200/index_name/_forcemerge?max_num_segments=1"
```

### RabbitMQ 故障处理

```bash
# 服务状态检查
rabbitmqctl status
rabbitmqctl cluster_status

# 队列状态
rabbitmqctl list_queues
rabbitmqctl list_exchanges

# 连接和通道
rabbitmqctl list_connections
rabbitmqctl list_channels

# 内存和磁盘使用
rabbitmqctl status | grep -A 10 "Memory"

# 重置节点（危险操作）
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl start_app
```

## 应用层故障处理

### Java 应用故障处理

```bash
# JVM 监控
jps -l                 # 查看Java进程
jstat -gc PID          # GC统计信息
jmap -heap PID         # 堆内存信息
jstack PID             # 线程堆栈信息

# 生成堆转储
jmap -dump:live,format=b,file=heapdump.hprof PID

# 查看系统属性
jinfo PID

# 内存分析
jhat heapdump.hprof    # 启动web界面分析

# GC日志分析
tail -f gc.log | grep "Full GC"
```

### Spring Boot 应用处理

```bash
# 健康检查端点
curl http://localhost:8080/actuator/health
curl http://localhost:8080/actuator/info

# 查看配置
curl http://localhost:8080/actuator/env
curl http://localhost:8080/actuator/configprops

# 查看Bean
curl http://localhost:8080/actuator/beans

# 线程转储
curl http://localhost:8080/actuator/threaddump

# 堆转储
curl http://localhost:8080/actuator/heapdump -o heapdump.hprof
```

### 前端应用故障处理

```bash
# Nginx 静态资源检查
ls -la /usr/share/nginx/html/
curl -I http://localhost/index.html

# 查看访问日志
tail -f /var/log/nginx/access.log
grep -E "4[0-9]{2}|5[0-9]{2}" /var/log/nginx/access.log

# 缓存清理
curl -X PURGE http://localhost/path/to/file

# 压缩检查
curl -H "Accept-Encoding: gzip" -I http://localhost/
```

## 自动化运维脚本

### 系统健康检查脚本

```bash
#!/bin/bash
# 系统健康检查脚本

echo "=== 系统健康检查报告 $(date) ==="

# CPU使用率
echo -e "\n--- CPU使用率 ---"
top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print "CPU使用率: " 100-$1 "%"}'

# 内存使用
echo -e "\n--- 内存使用情况 ---"
free -h

# 磁盘使用
echo -e "\n--- 磁盘使用情况 ---"
df -h | grep -vE '^Filesystem|tmpfs|cdrom'

# 系统负载
echo -e "\n--- 系统负载 ---"
uptime

# 重要服务状态
echo -e "\n--- 服务状态 ---"
systemctl is-active docker nginx postgresql redis-server | while read service; do
    echo "Service: $service"
done
```

### Docker 容器监控脚本

```bash
#!/bin/bash
# Docker容器健康监控

echo "=== Docker容器状态检查 $(date) ==="

# 容器状态
echo -e "\n--- 容器运行状态 ---"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# 资源使用
echo -e "\n--- 容器资源使用 ---"
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

# 检查不健康的容器
echo -e "\n--- 不健康的容器 ---"
docker ps --filter health=unhealthy --format "table {{.Names}}\t{{.Status}}"

# Docker系统信息
echo -e "\n--- Docker系统使用 ---"
docker system df
```

### 日志轮转脚本

```bash
#!/bin/bash
# 应用日志清理脚本

LOG_DIR="/var/log/myapp"
BACKUP_DIR="/var/log/backup"
DAYS_TO_KEEP=7

# 创建备份目录
mkdir -p $BACKUP_DIR

# 压缩和归档旧日志
find $LOG_DIR -name "*.log" -type f -mtime +1 -exec gzip {} \;

# 移动压缩文件到备份目录
find $LOG_DIR -name "*.gz" -type f -mtime +1 -exec mv {} $BACKUP_DIR \;

# 删除过期备份
find $BACKUP_DIR -name "*.gz" -type f -mtime +$DAYS_TO_KEEP -delete

echo "日志清理完成: $(date)"
```

## 故障预防措施

### 监控告警设置

1. **系统监控告警**
   - CPU使用率超过80%
   - 内存使用率超过85%
   - 磁盘使用率超过90%
   - 系统负载超过CPU核数的2倍

2. **应用监控告警**
   - 应用响应时间超过3秒
   - 错误率超过5%
   - 数据库连接池使用率超过80%
   - JVM堆内存使用率超过85%

3. **中间件监控告警**
   - Redis内存使用率超过80%
   - Nginx错误率超过1%
   - PostgreSQL连接数超过最大值的80%
   - Elasticsearch集群状态为Red

### 定期维护任务

```bash
# 创建定期维护的crontab
# 每天凌晨2点执行系统清理
0 2 * * * /opt/scripts/system_cleanup.sh

# 每周日凌晨3点执行完整备份
0 3 * * 0 /opt/scripts/full_backup.sh

# 每小时检查系统健康状态
0 * * * * /opt/scripts/health_check.sh

# 每天午夜轮转日志
0 0 * * * /opt/scripts/log_rotate.sh
```

### 备份策略

1. **数据库备份**
   - 每日增量备份
   - 每周完整备份
   - 异地备份存储

2. **配置文件备份**
   - 版本控制管理
   - 自动化部署前备份
   - 关键配置实时同步

3. **应用备份**
   - Docker镜像版本管理
   - 代码仓库标签管理
   - 静态资源CDN备份

